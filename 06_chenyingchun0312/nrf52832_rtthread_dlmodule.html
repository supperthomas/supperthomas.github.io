<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. nRF52832 RT-Thread dmodule适配 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="5. STM32L496 USB CDC适配" href="stm32l496.html" />
    <link rel="prev" title="3. 程序员的自我修养" href="elf_introduce.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">NORDIC:chenyingchun0312</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_posix_dfs/rt_thread_posix_dfs.html">2. POSIX 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="elf_introduce.html">3. 程序员的自我修养</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. nRF52832 RT-Thread dmodule适配</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">4.1. 硬件准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">4.2. 软件准备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mcu">4.3. MCU内部储存器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ramflash">RAM和FLASH</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flashpage-size">Flash的Page Size</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#nrf52832rtthread">4.4. nRF52832运行rtthread最小系统</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#gcc">使用GCC编译程序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">再次编译</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">查看整个修改点</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#fal">4.5. FAL 适配</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">使能fal软件包</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">添加配置文件</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">4.6. 虚拟文件系统适配</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dfs">DFS简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">DFS架构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flash">内部flash挂载文件系统</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">4.7. 动态模块适配</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">基本介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">功能简介</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">使用动态模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">加载动态模块</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="stm32l496.html">5. STM32L496 USB CDC适配</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb.html">6. USB</a></li>
<li class="toctree-l2"><a class="reference internal" href="i2s.html">7. I2S总线介绍</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">NORDIC:chenyingchun0312</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>nRF52832 RT-Thread dmodule适配</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/06_chenyingchun0312/nrf52832_rtthread_dlmodule.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>[TOC]</p>
<section id="nrf52832-rt-thread-dmodule">
<h1><span class="section-number">4. </span>nRF52832 RT-Thread dmodule适配<a class="headerlink" href="#nrf52832-rt-thread-dmodule" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2><span class="section-number">4.1. </span>硬件准备<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p>准备NRF52832开发板，我这里使用的是青风的NRF52832开发板。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626153037768.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626153037768.png" /></p>
</section>
<section id="id2">
<h2><span class="section-number">4.2. </span>软件准备<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<ul>
<li><p>rtthread源码</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone https://gitee.com/rtthread/rt-thread.git
</pre></div>
</div>
<p>注意：请使用master分支，master分支和github上保持一致的。</p>
</li>
<li><p>rtthread-app源码</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RT</span><span class="o">-</span><span class="n">Thread</span><span class="o">/</span><span class="n">rtthread</span><span class="o">-</span><span class="n">apps</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="mcu">
<h2><span class="section-number">4.3. </span>MCU内部储存器<a class="headerlink" href="#mcu" title="此标题的永久链接"></a></h2>
<section id="ramflash">
<h3>RAM和FLASH<a class="headerlink" href="#ramflash" title="此标题的永久链接"></a></h3>
<p>不同型号，内部资源不完全一致，参考如下说明</p>
<p>备注：青风52832开发板，Device Name为nRF52832-QFAA，内部资源为RAM 64KB，Flash 512KB。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210616231946677.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210616231946677.png" /></p>
</section>
<section id="flashpage-size">
<h3>Flash的Page Size<a class="headerlink" href="#flashpage-size" title="此标题的永久链接"></a></h3>
<p>nordic内部flash的管理是通过NVMC（non-volatile memory controller）控制器管理的，page size大小和block size大小参考文档《nRF52832_PS_v1.4.pdf》第23页。</p>
<p>即page size大小为0x1000，block size大小为0x200，每个page包含了8个block。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210616233833766.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210616233833766.png" /></p>
</section>
</section>
<section id="nrf52832rtthread">
<h2><span class="section-number">4.4. </span>nRF52832运行rtthread最小系统<a class="headerlink" href="#nrf52832rtthread" title="此标题的永久链接"></a></h2>
<p>由于希望适配动态模块的加载，需要使用arm-gcc交叉编译工具链，因此，接下来的操作都将基于arm-gcc环境。nRF52832的arm-gcc环境，这里以vscode开发为例，在vscode上GCC环境搭建，可以参考如下链接：</p>
<p><a class="reference external" href="https://supperthomas-wiki.readthedocs.io/en/latest/10_jiy/02_gcc_on_vscode/gcc_on_vscode.html">在VS Code上使用GCC开发嵌入式应用</a></p>
<section id="gcc">
<h3>使用GCC编译程序<a class="headerlink" href="#gcc" title="此标题的永久链接"></a></h3>
<section id="id3">
<h4>基本编译环境<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h4>
<p>在<code class="docutils literal notranslate"><span class="pre">rt-thread\bsp\nrf5x\nrf52832</span></code> 目录中，使用rtthread env工具打开，执行scons，使用arm-gcc来编译程序，出现如下提示：</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626154418762.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626154418762.png" /></p>
<p>上面的错误原因，提示很明显，需要修改bsp根目录下的rtconfig.py中的EXEC_PATH，设置GCC交叉编译工具链的路径，这里需要修改的内容如下：</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626154917030.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626154917030.png" /></p>
<p>根据自己当前的电脑环境设置正确的GCC交叉编译工具链位置，比如我这里设置修改如下：</p>
<p>注意，这里由于是windows开发环境，路径是反斜杠，在python环境中，有三种处理方式</p>
<ul class="simple">
<li><p>在字符串前加<code class="docutils literal notranslate"><span class="pre">r</span></code>字母</p></li>
<li><p>所有反斜杠<code class="docutils literal notranslate"><span class="pre">'\'</span></code>都需要转义</p></li>
<li><p>将所有反斜杠<code class="docutils literal notranslate"><span class="pre">'\'</span></code>修改成斜杠<code class="docutils literal notranslate"><span class="pre">'/'</span></code></p></li>
</ul>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626155234950.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626155234950.png" /></p>
<p>修改后，再次执行<code class="docutils literal notranslate"><span class="pre">scons</span></code>编译程序，出现如下提示</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626162645013.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626162645013.png" /></p>
<p>这里，说明一下，由于nrf5x bsp可以正确运行，还需要加载nrfx hal库，类似于stm32的hal库。nrfx hal库使用软件包的形式提供，而不是像stm32中的hal库，已经存在于bsp中，因此这里才会报错，这里我们需要下载对应的软件包。</p>
</section>
<section id="nrfx-hal">
<h4>下载nrfx hal 库软件包<a class="headerlink" href="#nrfx-hal" title="此标题的永久链接"></a></h4>
<p>在env环境中，执行<code class="docutils literal notranslate"><span class="pre">menuconfig</span></code>命令</p>
<ul>
<li><p>选择online packages</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163227187.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163227187.png" /></p>
</li>
<li><p>选择外设库和驱动</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163243256.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163243256.png" /></p>
</li>
<li><p>选择nrfx 库</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163348195.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163348195.png" /></p>
</li>
<li><p>选择最新nrfx最新版本</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163358689.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163358689.png" /></p>
</li>
<li><p>保存修改</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163626369.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163626369.png" /></p>
</li>
<li><p>执行pkgs –update更新nrfx库软件包</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163813921.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626163813921.png" /></p>
</li>
<li><p>下载好软件包后，继续编译，提示如下错误，由于GCC链接脚本适配异常，这里，我们还需要修改链接脚本</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626164356961.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626164356961.png" /></p>
</li>
</ul>
</section>
<section id="id4">
<h4>链接脚本修改<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h4>
<p>链接脚本修改为如下内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Linker</span> <span class="n">script</span> <span class="n">to</span> <span class="n">configure</span> <span class="n">memory</span> <span class="n">regions</span><span class="o">.</span> <span class="o">*/</span>

<span class="n">MEMORY</span>
<span class="p">{</span>
  <span class="n">ROM</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="p">:</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">LENGTH</span> <span class="o">=</span> <span class="mh">0x80000</span>  <span class="o">/*</span> <span class="mi">512</span><span class="n">K</span> <span class="n">FLASH</span> <span class="o">*/</span>
  <span class="n">RAM</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span> <span class="p">:</span> <span class="n">ORIGIN</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="n">LENGTH</span> <span class="o">=</span> <span class="mh">0x10000</span>  <span class="o">/*</span> <span class="mi">64</span><span class="n">K</span> <span class="n">RAM</span>    <span class="o">*/</span>
<span class="p">}</span>
<span class="n">ENTRY</span><span class="p">(</span><span class="n">Reset_Handler</span><span class="p">)</span>
<span class="n">_system_stack_size</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>

<span class="n">SECTIONS</span>
<span class="p">{</span>
    <span class="o">.</span><span class="n">text</span> <span class="p">:</span>
    <span class="p">{</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">_stext</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">isr_vector</span><span class="p">))</span>            <span class="o">/*</span> <span class="n">Startup</span> <span class="n">code</span> <span class="o">*/</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>                        <span class="o">/*</span> <span class="n">remaining</span> <span class="n">code</span> <span class="o">*/</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">text</span><span class="o">.*</span><span class="p">)</span>                      <span class="o">/*</span> <span class="n">remaining</span> <span class="n">code</span> <span class="o">*/</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">rodata</span><span class="p">)</span>                      <span class="o">/*</span> <span class="n">read</span><span class="o">-</span><span class="n">only</span> <span class="n">data</span> <span class="p">(</span><span class="n">constants</span><span class="p">)</span> <span class="o">*/</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">rodata</span><span class="o">*</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">glue_7</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">glue_7t</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">linkonce</span><span class="o">.</span><span class="n">t</span><span class="o">*</span><span class="p">)</span>

        <span class="o">/*</span> <span class="n">section</span> <span class="n">information</span> <span class="k">for</span> <span class="n">finsh</span> <span class="n">shell</span> <span class="o">*/</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">__fsymtab_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">FSymTab</span><span class="p">))</span>
        <span class="n">__fsymtab_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">__vsymtab_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">VSymTab</span><span class="p">))</span>
        <span class="n">__vsymtab_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">section</span> <span class="n">information</span> <span class="k">for</span> <span class="n">initial</span><span class="o">.</span> <span class="o">*/</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">__rt_init_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="o">.</span><span class="n">rti_fn</span><span class="o">*</span><span class="p">)))</span>
        <span class="n">__rt_init_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">section</span> <span class="n">information</span> <span class="k">for</span> <span class="n">modules</span> <span class="o">*/</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">__rtmsymtab_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">RTMSymTab</span><span class="p">))</span>
        <span class="n">__rtmsymtab_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        
        <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__ctors_start__</span> <span class="o">=</span> <span class="o">.</span><span class="p">);</span>
        <span class="n">KEEP</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="o">.</span><span class="n">init_array</span><span class="o">.*</span><span class="p">)))</span>
        <span class="n">KEEP</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">init_array</span><span class="p">))</span>
        <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__ctors_end__</span> <span class="o">=</span> <span class="o">.</span><span class="p">);</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

        <span class="n">_etext</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">&gt;</span> <span class="n">ROM</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="o">/*</span> <span class="o">.</span><span class="n">ARM</span><span class="o">.</span><span class="n">exidx</span> <span class="ow">is</span> <span class="nb">sorted</span><span class="p">,</span> <span class="n">so</span> <span class="n">has</span> <span class="n">to</span> <span class="n">go</span> <span class="ow">in</span> <span class="n">its</span> <span class="n">own</span> <span class="n">output</span> <span class="n">section</span><span class="o">.</span>  <span class="o">*/</span>
    <span class="n">__exidx_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
    <span class="o">.</span><span class="n">ARM</span><span class="o">.</span><span class="n">exidx</span> <span class="p">:</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">ARM</span><span class="o">.</span><span class="n">exidx</span><span class="o">*</span> <span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">linkonce</span><span class="o">.</span><span class="n">armexidx</span><span class="o">.*</span><span class="p">)</span>

        <span class="o">/*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">startup</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="o">.</span><span class="n">data</span> <span class="n">secion</span> <span class="o">*/</span>
        <span class="n">_sidata</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">&gt;</span> <span class="n">ROM</span>
    <span class="n">__exidx_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

    <span class="o">/*</span> <span class="o">.</span><span class="n">data</span> <span class="n">section</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">used</span> <span class="k">for</span> <span class="n">initialized</span> <span class="n">data</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">data</span> <span class="p">:</span> <span class="n">AT</span> <span class="p">(</span><span class="n">_sidata</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">startup</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="o">.</span><span class="n">data</span> <span class="n">secion</span> <span class="o">*/</span>
        <span class="n">_sdata</span> <span class="o">=</span> <span class="o">.</span> <span class="p">;</span>

        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">data</span><span class="o">.*</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">linkonce</span><span class="o">.</span><span class="n">d</span><span class="o">*</span><span class="p">)</span>

        <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__dtors_start__</span> <span class="o">=</span> <span class="o">.</span><span class="p">);</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">SORT</span><span class="p">(</span><span class="o">.</span><span class="n">dtors</span><span class="o">.*</span><span class="p">)))</span>
        <span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">dtors</span><span class="p">))</span>
        <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__dtors_end__</span> <span class="o">=</span> <span class="o">.</span><span class="p">);</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">startup</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="o">.</span><span class="n">data</span> <span class="n">secion</span> <span class="o">*/</span>
        <span class="n">_edata</span> <span class="o">=</span> <span class="o">.</span> <span class="p">;</span>
    <span class="p">}</span> <span class="o">&gt;</span><span class="n">RAM</span>

    <span class="o">.</span><span class="n">stack</span> <span class="p">:</span> 
    <span class="p">{</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">_sstack</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
        <span class="o">.</span> <span class="o">=</span> <span class="o">.</span> <span class="o">+</span> <span class="n">_system_stack_size</span><span class="p">;</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="n">_estack</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
    <span class="p">}</span> <span class="o">&gt;</span><span class="n">RAM</span>

    <span class="n">__bss_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
    <span class="o">.</span><span class="n">bss</span> <span class="p">:</span>
    <span class="p">{</span>
        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">startup</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="o">.</span><span class="n">bss</span> <span class="n">secion</span> <span class="o">*/</span>
        <span class="n">_sbss</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">bss</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">bss</span><span class="o">.*</span><span class="p">)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">COMMON</span><span class="p">)</span>

        <span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">startup</span> <span class="ow">in</span> <span class="n">order</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">the</span> <span class="o">.</span><span class="n">bss</span> <span class="n">secion</span> <span class="o">*/</span>
        <span class="n">_ebss</span> <span class="o">=</span> <span class="o">.</span> <span class="p">;</span>
        
        <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">bss</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
    <span class="p">}</span> <span class="o">&gt;</span> <span class="n">RAM</span>
    <span class="n">__bss_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

    <span class="n">_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>

    <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__etext</span> <span class="o">=</span> <span class="n">__exidx_end</span><span class="p">);</span>
    <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__data_start__</span> <span class="o">=</span> <span class="n">_sdata</span><span class="p">);</span>
    <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__bss_start__</span> <span class="o">=</span> <span class="n">__bss_start</span><span class="p">);</span>
    <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__bss_end__</span> <span class="o">=</span> <span class="n">__bss_end</span><span class="p">);</span>
    <span class="n">PROVIDE</span><span class="p">(</span><span class="n">__StackTop</span> <span class="o">=</span> <span class="n">_estack</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">Stabs</span> <span class="n">debugging</span> <span class="n">sections</span><span class="o">.</span>  <span class="o">*/</span>
    <span class="o">.</span><span class="n">stab</span>          <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stab</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">stabstr</span>       <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stabstr</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">excl</span>     <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">excl</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">exclstr</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">exclstr</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">index</span>    <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">indexstr</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">stab</span><span class="o">.</span><span class="n">indexstr</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">comment</span>       <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">/*</span> <span class="n">DWARF</span> <span class="n">debug</span> <span class="n">sections</span><span class="o">.</span>
     <span class="o">*</span> <span class="n">Symbols</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">DWARF</span> <span class="n">debugging</span> <span class="n">sections</span> <span class="n">are</span> <span class="n">relative</span> <span class="n">to</span> <span class="n">the</span> <span class="n">beginning</span>
     <span class="o">*</span> <span class="n">of</span> <span class="n">the</span> <span class="n">section</span> <span class="n">so</span> <span class="n">we</span> <span class="n">begin</span> <span class="n">them</span> <span class="n">at</span> <span class="mf">0.</span>  <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">DWARF</span> <span class="mi">1</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">debug</span>          <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">line</span>           <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">line</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">/*</span> <span class="n">GNU</span> <span class="n">DWARF</span> <span class="mi">1</span> <span class="n">extensions</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">debug_srcinfo</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_srcinfo</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_sfnames</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_sfnames</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">/*</span> <span class="n">DWARF</span> <span class="mf">1.1</span> <span class="ow">and</span> <span class="n">DWARF</span> <span class="mi">2</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">debug_aranges</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_aranges</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_pubnames</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_pubnames</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">/*</span> <span class="n">DWARF</span> <span class="mi">2</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">debug_info</span>     <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">.</span><span class="n">gnu</span><span class="o">.</span><span class="n">linkonce</span><span class="o">.</span><span class="n">wi</span><span class="o">.*</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_abbrev</span>   <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_abbrev</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_line</span>     <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_line</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_frame</span>    <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_frame</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_str</span>      <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_str</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_loc</span>      <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_loc</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_macinfo</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_macinfo</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">/*</span> <span class="n">SGI</span><span class="o">/</span><span class="n">MIPS</span> <span class="n">DWARF</span> <span class="mi">2</span> <span class="n">extensions</span> <span class="o">*/</span>
    <span class="o">.</span><span class="n">debug_weaknames</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_weaknames</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_funcnames</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_funcnames</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_typenames</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_typenames</span><span class="p">)</span> <span class="p">}</span>
    <span class="o">.</span><span class="n">debug_varnames</span>  <span class="mi">0</span> <span class="p">:</span> <span class="p">{</span> <span class="o">*</span><span class="p">(</span><span class="o">.</span><span class="n">debug_varnames</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如上链接脚本，和bsp\stm32\stm32h750-artpi-h750\board\linker_scripts\link.lds相比，仅有如下区别：</p>
<ul>
<li><p>内存分布不一样，CPU型号不同，内存分布必然不一样，右边是nRF52832的</p>
<p><img alt="../_images/image-20210626202650729.png" src="../_images/image-20210626202650729.png" /></p>
</li>
<li><p>提供了一些链接符号，供gcc_startup_nrf52.S启动文件使用。启动文件需要知道这些符号，来初始化bss段、重定向数据段、设置堆栈指针sp等。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626202841785.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626202841785.png" /></p>
</li>
</ul>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626202939083.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626202939083.png" /></p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626203141280.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626203141280.png" /></p>
<p>对于启动文件gcc_startup_nrf52.S还有一个注意点，需要说明下，作为一个遗留优化空间吧！</p>
<p>参考stm32的gcc启动文件，好像是并没有栈大小，堆大小的定义。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626204216383.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626204216383.png" /></p>
</section>
<section id="id5">
<h4>链接脚本分析<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h4>
<ul>
<li><p>内存布局分析</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626204842209.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626204842209.png" /></p>
</li>
<li><p>PROVIDE关键字</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626205114450.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626205114450.png" /></p>
</li>
</ul>
<p>在链接脚本中，使用PROVIDE关键，PROVIDE（符号 = 值）， 在汇编或者C语言中，可以直接引用。</p>
<p>比如，链接脚本中，提供的这些符号，在如下启动文件中，使用到了：</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626205427734.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626205427734.png" /></p>
<ul class="simple">
<li><p>参考文档《rombootloader链接脚本分析.md》</p></li>
</ul>
<p>再提一个注意事项，我在实际测试过程中，menuconfig加载的默认值和Kconfig中配置的不一致，暂不清楚原因。因此，需要menuconfig时，特别加上一个设置MCU资源的配置，配置如下：</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626211028728.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626211028728.png" /></p>
</section>
</section>
<section id="id6">
<h3>再次编译<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<ul>
<li><p>编译通过，编译后，在bsp根目录生成了rt-thread.elf、rt-thread.bin、rt-thread.hex三个文件</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626155720667.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626155720667.png" /></p>
</li>
<li><p>在env环境中，执行<code class="docutils literal notranslate"><span class="pre">code</span> <span class="pre">.</span></code> 打开vscode</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626160058786.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626160058786.png" /></p>
</li>
<li><p>在vscode环境中编译代码（和在env环境中执行scons一致），点击菜单栏<code class="docutils literal notranslate"><span class="pre">终端</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">运行生成任务</span></code> （快捷键 <code class="docutils literal notranslate"> <span class="pre">ctrl+shift+b</span></code>），快速编译代码，编译完成会有如下提示</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626211449656.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626211449656.png" /></p>
</li>
<li><p>进入Debug环境，发现程序可以停在第一条将要执行的指令上了</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626161329676.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626161329676.png" /></p>
</li>
<li><p>打开串口，全速运行，rtthread最小系统运行成功</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626212023063.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626212023063.png" /></p>
</li>
</ul>
</section>
<section id="id7">
<h3>查看整个修改点<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>通过git管理，查看文件的修改情况如下，仅修改了4个文件。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626212339655.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626212339655.png" /></p>
</section>
</section>
<section id="fal">
<h2><span class="section-number">4.5. </span>FAL 适配<a class="headerlink" href="#fal" title="此标题的永久链接"></a></h2>
<section id="id8">
<h3>使能fal软件包<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h3>
<ul>
<li><p>在线软件包</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220618964.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220618964.png" /></p>
</li>
<li><p>系统软件包</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220652804.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220652804.png" /></p>
</li>
<li><p>fal软件包</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220716575.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220716575.png" /></p>
</li>
<li><p>使用默认fal配置即可</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220747832.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220747832.png" /></p>
</li>
<li><p>保存，并执行<code class="docutils literal notranslate"><span class="pre">pkgs</span> <span class="pre">–update</span></code>命令，更新软件包</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220927047.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626220927047.png" /></p>
</li>
<li><p>使能片上Flash</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223322120.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223322120.png" /></p>
</li>
</ul>
</section>
<section id="id9">
<h3>添加配置文件<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>在board目录下新建fal_cfg.h，并加入如下内容</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * File      : fal_cfg.h</span>
<span class="cm"> * This file is part of FAL (Flash Abstraction Layer) package</span>
<span class="cm"> * COPYRIGHT (C) 2006 - 2018, RT-Thread Development Team</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Change Logs:</span>
<span class="cm"> * Date           Author        Notes</span>
<span class="cm"> * 2021-06-26     chenyingchun  the first version</span>
<span class="cm"> */</span><span class="w"></span>

<span class="cp">#ifndef _FAL_CFG_H_</span>
<span class="cp">#define _FAL_CFG_H_</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtconfig.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;board.h&gt;</span><span class="cp"></span>

<span class="cp">#define ON_CHIP_FLASH_DEV_NAME  &quot;mcu_onchip_flash&quot;</span>
<span class="cp">#define ON_CHIP_PARTION_NAME    &quot;filesystem&quot;</span>

<span class="cm">/* ===================== Flash device Configuration ========================= */</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fal_flash_dev</span><span class="w"> </span><span class="n">mcu_onchip_flash</span><span class="p">;</span><span class="w"></span>

<span class="cm">/* flash device table */</span><span class="w"></span>
<span class="cp">#define FAL_FLASH_DEV_TABLE \</span>
<span class="cp">    {                       \</span>
<span class="cp">        &amp;mcu_onchip_flash,  \</span>
<span class="cp">    }   </span>
<span class="cm">/* ====================== Partition Configuration ========================== */</span><span class="w"></span>
<span class="cp">#ifdef FAL_PART_HAS_TABLE_CFG</span>
<span class="cm">/* partition table */</span><span class="w"></span>
<span class="cp">#define FAL_PART_TABLE                                                                                  \</span>
<span class="cp">    {                                                                                                   \</span>
<span class="cp">        {FAL_PART_MAGIC_WORD, ON_CHIP_PARTION_NAME, ON_CHIP_FLASH_DEV_NAME, 160 * 1024, 268 * 1024, 0}, \</span>
<span class="cp">    }</span>
<span class="cp">#endif </span><span class="cm">/* FAL_PART_HAS_TABLE_CFG */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _FAL_CFG_H_ */</span><span class="cp"></span>
</pre></div>
</div>
<ul>
<li><p>在application.c中加入如下代码</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223652374.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223652374.png" /></p>
</li>
<li><p>编译，运行代码，可以看到fal初始化成功</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223736373.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626223736373.png" /></p>
</li>
</ul>
</section>
</section>
<section id="id10">
<h2><span class="section-number">4.6. </span>虚拟文件系统适配<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p><a class="reference external" href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/filesystem/filesystem">虚拟文件系统参考链接 </a></p>
<section id="dfs">
<h3>DFS简介<a class="headerlink" href="#dfs" title="此标题的永久链接"></a></h3>
<p>DFS 是 RT-Thread 提供的虚拟文件系统组件，全称为Device File System，即设备虚拟文件系统。文件系统的名称使用类似 UNIX 文件、文件夹的风格，目录结构如下图所示。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210618212132946.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210618212132946.png" /></p>
</section>
<section id="id11">
<h3>DFS架构<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h3>
<p>RT-Thread DFS 组件的主要功能特点有：</p>
<ul class="simple">
<li><p>为应用程序提供统一的 POSIX 文件和目录操作接口：read、write、poll/select 等。</p></li>
<li><p>支持多种类型的文件系统，如 FatFS、RomFS、DevFS 等，并提供普通文件、设备文件、网络文件描述符的管理。</p></li>
<li><p>支持多种类型的存储设备，如 SD Card、SPI Flash、Nand Flash 等。</p></li>
</ul>
<p>DFS 的层次架构如下图所示，主要分为 POSIX 接口层、虚拟文件系统层和设备抽象层。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210618212330733.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210618212330733.png" /></p>
<section id="posix">
<h4>POSIX接口层<a class="headerlink" href="#posix" title="此标题的永久链接"></a></h4>
<p>POSIX 表示可移植操作系统接口（Portable Operating System Interface of UNIX，缩写 POSIX），POSIX 标准定义了操作系统应该为应用程序提供的接口标准，是 IEEE 为在各种 UNIX 操作系统上运行的软件而定义的一系列 API 标准的总称。</p>
<p>POSIX 标准意在期望获得源代码级别的软件可移植性。换句话说，为一个 POSIX 兼容的操作系统编写的程序，应该可以在任何其它 POSIX 操作系统（即使是来自另一个厂商）上编译执行。RT-Thread 支持 POSIX 标准接口，因此可以很方便的将 Linux/Unix 的程序移植到 RT-Thread 操作系统上。</p>
</section>
<section id="id12">
<h4>虚拟文件系统层<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h4>
<p>用户可以将具体的文件系统注册到DFS中，如FatFS、RomFS、DevFS等，下面介绍几种常用的文件系统类型：</p>
<ul class="simple">
<li><p>FatFS 是专为小型嵌入式设备开发的一个兼容微软 FAT 格式的文件系统，采用 ANSI C 编写，具有良好的硬件无关性以及可移植性，是 RT-Thread 中最常用的文件系统类型。</p></li>
<li><p>传统型的RomFS文件系统是一种简单的、紧凑的、只读的文件系统，不支持动态擦写保存，按顺序存放数据，因而支持应用程序以 XIP(execute In Place，片内运行) 方式运行，在系统运行时, 节省 RAM 空间。</p></li>
<li><p>Jffs2 文件系统是一种日志闪存文件系统。主要用于 NOR 型闪存，基于 MTD 驱动层，特点是：可读写的、支持数据压缩的、基于哈希表的日志型文件系统，并提供了崩溃 / 掉电安全保护，提供写平衡支持等。</p></li>
<li><p>DevFS 即设备文件系统，在 RT-Thread 操作系统中开启该功能后，可以将系统中的设备在 /dev 文件夹下虚拟成文件，使得设备可以按照文件的操作方式使用read、write等接口进行操作。</p></li>
<li><p>NFS 网络文件系统（Network File System）是一项在不同机器、不同操作系统之间通过网络共享文件的技术。在操作系统的开发调试阶段，可以利用该技术在主机上建立基于 NFS 的根文件系统，挂载到嵌入式设备上，可以很方便地修改根文件系统的内容。</p></li>
<li><p>UFFS 是 Ultra-low-cost Flash File System（超低功耗的闪存文件系统）的简称。它是国人开发的、专为嵌入式设备等小内存环境中使用 Nand Flash 的开源文件系统。与嵌入式中常使用的 Yaffs 文件系统相比，具有资源占用少、启动速度快、免费等优势。</p></li>
</ul>
</section>
</section>
<section id="flash">
<h3>内部flash挂载文件系统<a class="headerlink" href="#flash" title="此标题的永久链接"></a></h3>
<p><a class="reference external" href="https://blog.csdn.net/tyustli/article/details/105809582">RT-Thread–片上 flash挂载 Fatfs 文件系统</a></p>
<p><a class="reference external" href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/application-note/components/dfs/an0027-littlefs.md">在STM32L4上应用littlefs文件系统 (rt-thread.org)</a></p>
<p>通过实测，发现nRF52832挂载FatFs文件系统失败，可能是由于Flash空间大小的问题，因为FatFs需要占用的尺寸比较大，具体深层次原因，并没有仔细调查。</p>
<p>下面以挂载littlefs文件系统为例，说明下操作流程：</p>
<ul>
<li><p>开启 / 配置DFS框架，为应用程序提供统一的POSIX文件和目录操作接口</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225009745.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225009745.png" /></p>
</li>
<li><p>使能 littlefs 软件包，注意选择最新版本</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225116707.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225116707.png" /></p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225157577.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225157577.png" /></p>
</li>
<li><p>使能 MTD 设备</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225311183.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626225311183.png" /></p>
</li>
<li><p>使能 fal，上面已经操作过该步骤，并测试正常</p></li>
<li><p>执行<code class="docutils literal notranslate"><span class="pre">pkgs</span> <span class="pre">–update</span></code>更新软件包</p></li>
<li><p>查看经过上面的配置，新增了哪些宏</p>
<p><img alt="../_images/image-20210626225800995.png" src="../_images/image-20210626225800995.png" /></p>
<p><img alt="../_images/image-20210626225826513.png" src="../_images/image-20210626225826513.png" /></p>
</li>
<li><p>编译运行代码，littlefs文件系统挂载成功</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626230534166.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626230534166.png" /></p>
</li>
</ul>
</section>
</section>
<section id="id13">
<h2><span class="section-number">4.7. </span>动态模块适配<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h2>
<p><a class="reference external" href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/dlmodule/dlmodule?id=%E5%8A%A8%E6%80%81%E6%A8%A1%E5%9D%97">动态模块 参考链接</a></p>
<section id="id14">
<h3>基本介绍<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h3>
<p>在传统桌面操作系统中，用户空间和内核空间是分开的，应用程序运行在用户空间，内核以及内核模块则运行于内核空间，其中内核模块可以动态加载与删除以扩展内核功能。<code class="docutils literal notranslate"><span class="pre">dlmodule</span></code> 则是 RT-Thread 下，在内核空间对外提供的动态模块加载机制的软件组件。在 RT-Thread v3.1.0 以前的版本中，也被称为应用模块（Application Module），在 RT-Thread v3.1.0 及之后，则回归传统，以动态模块命名。</p>
<p><code class="docutils literal notranslate"><span class="pre">dlmodule</span></code> 组件更多的是一个ELF格式加载器，把单独编译的一个elf文件的代码段，数据段加载到内存中，并对其中的符号进行解析，绑定到内核导出的 API 地址上。动态模块 elf 文件主要放置于RT-Thread下的文件系统上。</p>
</section>
<section id="id15">
<h3>功能简介<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h3>
<p>动态模块为 RT-Thread 提供了动态加载程序模块的机制，因为也独立于内核编译，所以使用方式比较灵活。从实现上讲，这是一种将内核和动态模块分开的机制，通过这种机制，内核和动态模块可以分开编译，并在运行时通过内核中的模块加载器将编译好的动态模块加载到内核中运行。</p>
<p>在 RT-Thread 的动态模块中，目前支持两种格式：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.mo</span></code> 则是编译出来时以 <code class="docutils literal notranslate"><span class="pre">.mo</span></code> 做为后缀名的可执行动态模块；它可以被加载，并且系统中会自动创建一个主线程执行这个动态模块中的 <code class="docutils literal notranslate"><span class="pre">main</span></code> 函数；同时这个 <code class="docutils literal notranslate"><span class="pre">main(int</span> <span class="pre">argc,</span> <span class="pre">char**argv)</span></code> 函数也可以接受命令行上的参数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.so</span></code> 则是编译出来时以 <code class="docutils literal notranslate"><span class="pre">.so</span></code> 做为后缀名的动态库；它可以被加载，并驻留在内存中，并提供一些函数集供其他程序（内核里的代码或动态模块）来使用。</p></li>
</ul>
<p>当前 RT-Thread 支持动态模块的架构主要包括 ARM 类架构和 x86 架构，未来会扩展到 MIPS，以及 RISC-V 等架构上。RT-Thread 内核固件部分可使用多种编译器工具链，如 GCC、ARMCC、IAR等工具链；但动态模块部分编译当前只支持 GNU GCC 工具链编译。因此编译 RT-Thread 模块需下载 GCC 工具，例如 CodeSourcery 的 arm-none-eabi 工具链。一般的，最好内核和动态模块使用一样的工具链进行编译（这样不会在 libc 上产生不一致的行为）。另外，动态模块一般只能加载到 RAM 中使用，并进行符号解析绑定到内核导出的 API 地址上，而不能基于 Flash 直接以 XIP 方式运行（因为 Flash 上也不能够再行修改其中的代码段）。</p>
</section>
<section id="id16">
<h3>使用动态模块<a class="headerlink" href="#id16" title="此标题的永久链接"></a></h3>
<p>当要在系统中测试使用动态模块，需要编译一份支持动态模块的固件，以及需要运行的动态模块。下面将固件和动态模块的编译方式分为两部分进行介绍。</p>
<section id="id17">
<h4>编译固件<a class="headerlink" href="#id17" title="此标题的永久链接"></a></h4>
<ul>
<li><p>当要使用动态模块时，需要在固件的配置中打开对应的选项，使用 menuconfig 打开如下配置：</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626231801792.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626231801792.png" /></p>
</li>
<li><p>bsp 对应的 rtconfig.py 中设置动态模块编译时需要用到的配置参数，修改点如下
<img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626233107983.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626233107983.png" /></p></li>
<li><p>上面修改内容，说明如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>STRIP  = PREFIX + &#39;strip&#39;
CXXFLAGS = CFLAGS 
M_CFLAGS = CFLAGS + &#39; -mlong-calls -fPIC &#39;
M_CXXFLAGS = CXXFLAGS + &#39; -mlong-calls -fPIC&#39;
M_LFLAGS = DEVICE + CXXFLAGS + &#39; -Wl,--gc-sections,-z,max-page-size=0x4&#39; +\
                                &#39; -shared -fPIC -nostartfiles -nostdlib -static-libgcc&#39;
M_POST_ACTION = STRIP + &#39; -R .hash $TARGET\n&#39; + SIZE + &#39; $TARGET \n&#39;
#M_BIN_PATH = r&#39;E:\qemu-dev310\fatdisk\root&#39;  # 这个配置可以注释掉

相关的解释如下：

M_CFLAGS - 动态模块编译时用到的 C 代码编译参数，一般此处以 PIC 方式进行编译（即代码地址支持浮动方式执行）；
M_CXXFLAGS - 动态模块编译时用到的 C++ 代码编译参数，参数和上面的 M_CFLAGS 类似；
M_LFLAGS - 动态模块进行链接时的参数。同样是 PIC 方式，并且是按照共享库方式链接（部分链接）；
M_POST_ACTIOn - 动态模块编译完成后要进行的动作，这里会对 elf 文件进行 strip 下，以减少 elf 文件的大小；
M_BIN_PATH - 当动态模块编译成功时，对应的动态模块文件是否需要复制到统一的地方；
基本上来说，ARM9、Cortex-A、Cortex-M 系列的这些编译配置参数是一样的。
</pre></div>
</div>
</li>
<li><p>内核固件也会通过 <code class="docutils literal notranslate"><span class="pre">RTM(function)</span></code> 的方式导出一些函数 API 给动态模块使用，这些导出符号可以在 msh 下通过命令<code class="docutils literal notranslate"><span class="pre">list_symbols</span></code>列出固件中所有导出的符号信息。<code class="docutils literal notranslate"><span class="pre">dlmodule</span></code> 加载器也是把动态模块中需要解析的符号按照这里导出的符号表来进行解析，完成最终的绑定动作。</p></li>
<li><p>这段符号表会放在一个专门的，名字是 RTMSymTab 的 section 中，所以对应的固件链接脚本也需要保留这块区域，而不会被链接器优化移除掉。可以在链接脚本中添加对应的信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">section</span> <span class="n">information</span> <span class="k">for</span> <span class="n">modules</span> <span class="o">*/</span>
<span class="o">.</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">__rtmsymtab_start</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
<span class="n">KEEP</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">RTMSymTab</span><span class="p">))</span>
<span class="n">__rtmsymtab_end</span> <span class="o">=</span> <span class="o">.</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>编译时提示没有定义<code class="docutils literal notranslate"><span class="pre">rt_hw_us_delay</span></code>函数，我们参考其他bsp，在board.c中添加该函数</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * The time delay function.</span>
<span class="cm"> *</span>
<span class="cm"> * @param microseconds.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">rt_hw_us_delay</span><span class="p">(</span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">us</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">ticks</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">told</span><span class="p">,</span><span class="w"> </span><span class="n">tnow</span><span class="p">,</span><span class="w"> </span><span class="n">tcnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">LOAD</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">ticks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1000000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">RT_TICK_PER_SECOND</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">told</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">tnow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SysTick</span><span class="o">-&gt;</span><span class="n">VAL</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tnow</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">told</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tnow</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">told</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">tcnt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">told</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tnow</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">tcnt</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">reload</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tnow</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">told</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">told</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tnow</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tcnt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">ticks</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>BSP 工程目录下执行 <code class="docutils literal notranslate"><span class="pre">scons</span></code> 正确无误地生成固件</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626233747143.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626233747143.png" /></p>
</li>
<li><p>在 BSP 工程目录下执行一下命令<code class="docutils literal notranslate"><span class="pre">scons</span> <span class="pre">--target=ua</span> <span class="pre">-s</span></code>来生成编译动态模块时需要包括的内核头文件搜索路径及全局宏定义，执行成功，有如下LOG打印</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626234057287.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626234057287.png" /></p>
</li>
<li><p>生成了rtup.py文件</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626234230023.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626234230023.png" /></p>
</li>
<li><p>至此，相当于内核运行环境已经编译好了，并导出了编译动态模块时所需要到的一些头文件搜索路径。</p></li>
</ul>
</section>
<section id="id18">
<h4>编译动态模块<a class="headerlink" href="#id18" title="此标题的永久链接"></a></h4>
<p>在 github 上有一份独立仓库： <a class="reference external" href="https://github.com/RT-Thread/rtthread-apps">rtthread-apps</a> ，这份仓库中放置了一些和动态模块，动态库相关的示例。</p>
<ul class="simple">
<li><p>目录结构如下：
| <strong>目录名</strong> | <strong>说明</strong>                                          |
| ———- | ————————————————- |
| cxx        | 演示了如何在动态模块中使用 C++ 进行编程           |
| hello      | 最简单的 <code class="docutils literal notranslate"><span class="pre">hello</span> <span class="pre">world</span></code> 示例                       |
| lib        | 动态库的示例                                      |
| md5        | 为一个文件产生 md5 码                             |
| tools      | 动态模块编译时需要使用到的 Python/SConscript 脚本 |
| ymodem     | 通过串口以 YModem 协议下载一个文件到文件系统上    |</p></li>
</ul>
<p>可以把这份 git clone 到本地，然后在命令行下以 scons 工具进行编译，如果是 Windows 平台，推荐使用 RT-Thread/ENV 工具。</p>
<p>进入控制台命令行后，进入到这个 rtthread-apps repo 所在的目录（同样的，请保证这个目录所在全路径不包含空格，中文字符等字符），并设置好两个变量：</p>
<ul class="simple">
<li><p>RTT_ROOT - 指向到 RT-Thread 代码的根目录；</p></li>
<li><p>BSP_ROOT - 指向到 BSP 的工程目录；</p></li>
</ul>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626235108103.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626235108103.png" /></p>
<p>在rtthread-apps目录中，打开env环境，使用命令scons –app=hello编译hello动态模块，下面报错了，提示找不到rtua.py。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626235205391.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210626235205391.png" /></p>
<p>出现上面的错误，请查看电脑系统环境变量是否设置了RTT_ROOT了，如果有，请先删除，这里编译动态模块所需要的的RTT_ROOT必须是和编译BSP在一起的RTT。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001200423.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001200423.png" /></p>
<ul>
<li><p>排除以上错误后，再次编译动态模块，又提示如下错误</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001437840.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001437840.png" /></p>
</li>
<li><p>上面的错误，是有bsp目录下rtconfig.py中未定义CXX导致，定义后，再次编译</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001544143.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001544143.png" /></p>
</li>
<li><p>继续编译，又提示错误</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001609272.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627001609272.png" /></p>
</li>
<li><p>上面的错误，经过定位是rt-thread/tools/building.py中，执行时，交叉编译工具链的位置没有找到，暂时还不清楚哪里配置不对，暂且写死，绕过，后续再继续查找原因。</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627004513306.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627004513306.png" /></p>
</li>
<li><p>继续编译，成功</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627004624812.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627004624812.png" /></p>
</li>
</ul>
</section>
</section>
<section id="id19">
<h3>加载动态模块<a class="headerlink" href="#id19" title="此标题的永久链接"></a></h3>
<p>接下来需要将成功编译后的动态模块加载到文件系统中，动态执行。由于我们是内部的flash，无法将编译生成的hello.mo拷贝到文件系统中，那么至少有两种方法，一种，使用ymodem协议，下载hello.mo文件到文件系统中，另一种是在程序中，将hello.mo，写死到文件系统中。这里我们先使用相对简单的方法二测试，方法一，等后续有时间继续实现。</p>
<ul>
<li><p>测试，当执行hello.mo时，出现hardfault</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627005956196.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627005956196.png" /></p>
</li>
<li><p>经过调查，是因为fal分区时，给app应用程序分别的存储空间小于固件编译后的尺寸，因此在加载动态模块时，出现了hardfault。调整fal_cfg.h中的分区，大于固件编译后的尺寸（229032Bytes）</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010230310.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010230310.png" /></p>
</li>
<li><p>fal_cfg.h调整内容如下</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010317832.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010317832.png" /></p>
</li>
<li><p>成功执行动态模块hello.mo</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010503922.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010503922.png" /></p>
</li>
<li><p>修改文件列表如下</p>
<p><img alt="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010654594.png" src="https://gitee.com/chenyingchun0312/pic_md/raw/master/image-20210627010654594.png" /></p>
</li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="elf_introduce.html" class="btn btn-neutral float-left" title="3. 程序员的自我修养" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="stm32l496.html" class="btn btn-neutral float-right" title="5. STM32L496 USB CDC适配" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>