<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RTTHREAD移植新的芯片BSP开发板 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">RTTHREAD移植新的芯片BSP开发板</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/RTTHREAD/03_bsp_porting/05_rtthread_bsp_porting_new_bsp.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="rtthreadbsp">
<h1>RTTHREAD移植新的芯片BSP开发板<a class="headerlink" href="#rtthreadbsp" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2>简介<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p>你是否有一款新的开发板或者新的芯片，RTTHREAD  <a class="reference external" href="https://github.com/RT-Thread/rt-thread">Master</a>分支上还没有支持？想要支持RT-THREAD怎么做呢？这篇文章主要讲解的是如何在一颗新的芯片或者平台上上移植rtthread，按照文档的步骤一步一步的来porting，基本上可以慢慢掌握如何把你的新平台或者芯片如何PR到master分支上。</p>
<p>预备资料：</p>
<p>在看本文之前，请先大概过一遍文档中心的<a class="reference external" href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/porting/porting">内核移植</a></p>
<p>看完这篇文章，应该有个大概的了解，不需要完全掌握，文档中心的这篇文章是一些很理论的知识点。</p>
<p>没有具体教你怎么一步一步做，下面我这篇文章会大概总结一下，我是怎么一步一步操作的，你也可以根据我这个，如果有更好的方法也可以提供给我。我们可以称之为“<strong>RTTHRED</strong>“。</p>
</section>
<section id="id2">
<h2>移植前准备<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>本文场景是一颗内核架构已经在RTTHREAD上面支持了，例如MAX32660,这是一颗ARM-M4F的内核，但是这颗芯片RTTHREAD上还没有支持起来。</p>
<p>首先你得先具备熟悉以下两方面，芯片方面和RTTHREAD方面</p>
<section id="id3">
<h3>芯片方面<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h3>
<p>我们得先熟悉当前芯片的官方服务例程如何跑的，找到具体的sample和一些网上的资料，分以下一些方面</p>
<ul class="simple">
<li><p>官方服务例程，这边MAX是eclipse，熟悉eclipse</p></li>
<li><p>keil pack 里面的服务例程，这个往往大家会忽略，其实有些厂商支持keil pack装好之后里面都有一些服务例程，熟悉keil的朋友用起来会比较方便。<a class="reference external" href="https://www.keil.com/dd2/Pack/">网址</a></p></li>
<li><p>对于移植主要了解以下几个例程，Systick(其他定时器也可以，了解一款)，UART(console需要)， GPIO(点亮小灯需要) ，初期把整个框架搭起来，console可以使用，了解这几个例程就可以了，</p></li>
</ul>
</section>
<section id="rtthread">
<h3>RTTHREAD方面<a class="headerlink" href="#rtthread" title="此标题的永久链接"></a></h3>
<p>rtthread方面有以下文档需要熟悉</p>
<p>首先你要对RTTHREAD用法比较熟悉一些，</p>
<p>官方文档地址：<a class="reference external" href="https://www.rt-thread.org/document/site/">RTTHREAD文档中心</a></p>
<p>RTTHREAD支持的最好的是STM32系列，如果你有一款STM32的开发板，可以先跑一下熟悉一下。</p>
<p>和本文相关的一些文档下面我先列出来：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/tutorial/quick-start/stm32f103-simulator/stm32f103-simulator/#_3">Keil 模拟器 STM32F103 上手指南</a></p></li>
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/tutorial/nano/nano-port-principle/an0044-nano-port-principle/#startups">RT-Thread Nano 移植原理</a></p></li>
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/tutorial/nano/nano-port-gcc-riscv/an0042-nano-port-gcc-riscv/#starts">移植 RT-Thread Nano 到 RISC-V</a></p></li>
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/tutorial/nano/nano-port-keil/an0039-nano-port-keil/">基于 Keil MDK 移植 RT-Thread Nano</a></p></li>
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/programming-manual/basic/basic/#rt-thread_1">RT-Thread 启动流程</a></p></li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s/o6j9VJz7q4-higxJeQLXBw">如何向RTTHREAD提交BSP</a></p></li>
</ul>
</section>
</section>
<section id="id4">
<h2>移植步骤<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<p>这边我讲下我的移植顺序</p>
<section id="id5">
<h3>点亮小灯<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>官方服务例程里面通常会有GPIO点亮小灯的例程，通常有开GPIO时钟，设置GPIO管脚的功能为输出，然后就可以闪灯了。找到这几步的函数。</p>
</section>
<section id="systick">
<h3>熟悉Systick例程<a class="headerlink" href="#systick" title="此标题的永久链接"></a></h3>
<p>熟悉下Systick服务例程，定时器如何定时的触发，这个通常是CMSIS接口设置的，一般是通用的，不排除有些特殊配置，根据官方给的例程来就好了。</p>
</section>
<section id="bsp">
<h3>可以编译通过的bsp<a class="headerlink" href="#bsp" title="此标题的永久链接"></a></h3>
<p>这边可以找STM32F4或者L4系列都可以，拷贝到你需要的文件夹下面</p>
<p>对于keil，可以先改下template.uvprojx 文件，把target改成你对应的开发板</p>
<p><img alt="../../_images/image-20210212105925977.png" src="../../_images/image-20210212105925977.png" /></p>
<p>改完之后需要修改rtconfig.h来适应一些配置</p>
<p>这边提供一个最小的rtconfig.h来方便下次配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#ifndef RT_CONFIG_H__</span>
<span class="c1">#define RT_CONFIG_H__</span>

<span class="o">/*</span> <span class="n">Automatically</span> <span class="n">generated</span> <span class="n">file</span><span class="p">;</span> <span class="n">DO</span> <span class="n">NOT</span> <span class="n">EDIT</span><span class="o">.</span> <span class="o">*/</span>
<span class="o">/*</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Configuration</span> <span class="o">*/</span>

<span class="o">/*</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Kernel</span> <span class="o">*/</span>

<span class="c1">#define RT_NAME_MAX 8</span>
<span class="c1">#define RT_ALIGN_SIZE 4</span>
<span class="c1">#define RT_THREAD_PRIORITY_32</span>
<span class="c1">#define RT_THREAD_PRIORITY_MAX 32</span>
<span class="c1">#define RT_TICK_PER_SECOND 100</span>
<span class="c1">#define RT_USING_IDLE_HOOK</span>
<span class="c1">#define RT_IDLE_HOOK_LIST_SIZE 4</span>
<span class="c1">#define IDLE_THREAD_STACK_SIZE 256</span>
<span class="c1">#define RT_USING_TIMER_SOFT</span>
<span class="c1">#define RT_TIMER_THREAD_PRIO 4</span>
<span class="c1">#define RT_TIMER_THREAD_STACK_SIZE 512</span>

<span class="o">/*</span> <span class="n">Inter</span><span class="o">-</span><span class="n">Thread</span> <span class="n">communication</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_SEMAPHORE</span>
<span class="c1">#define RT_USING_MUTEX</span>

<span class="o">/*</span> <span class="n">Memory</span> <span class="n">Management</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_MEMPOOL</span>
<span class="c1">#define RT_USING_SMALL_MEM</span>
<span class="c1">#define RT_USING_HEAP</span>

<span class="o">/*</span> <span class="n">Kernel</span> <span class="n">Device</span> <span class="n">Object</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_DEVICE</span>
<span class="c1">#define RT_USING_CONSOLE</span>
<span class="c1">#define RT_CONSOLEBUF_SIZE 128</span>
<span class="c1">#define RT_CONSOLE_DEVICE_NAME &quot;uart1&quot;</span>
<span class="c1">#define RT_VER_NUM 0x40003</span>

<span class="o">/*</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Components</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_COMPONENTS_INIT</span>
<span class="c1">#define RT_USING_USER_MAIN</span>
<span class="c1">#define RT_MAIN_THREAD_STACK_SIZE 2048</span>
<span class="c1">#define RT_MAIN_THREAD_PRIORITY 10</span>

<span class="o">/*</span> <span class="n">C</span><span class="o">++</span> <span class="n">features</span> <span class="o">*/</span>


<span class="o">/*</span> <span class="n">Command</span> <span class="n">shell</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_FINSH</span>
<span class="c1">#define FINSH_THREAD_NAME &quot;tshell&quot;</span>
<span class="c1">#define FINSH_USING_HISTORY</span>
<span class="c1">#define FINSH_HISTORY_LINES 5</span>
<span class="c1">#define FINSH_USING_SYMTAB</span>
<span class="c1">#define FINSH_USING_DESCRIPTION</span>
<span class="c1">#define FINSH_THREAD_PRIORITY 20</span>
<span class="c1">#define FINSH_THREAD_STACK_SIZE 4096</span>
<span class="c1">#define FINSH_CMD_SIZE 80</span>
<span class="c1">#define FINSH_USING_MSH</span>
<span class="c1">#define FINSH_USING_MSH_DEFAULT</span>
<span class="c1">#define FINSH_USING_MSH_ONLY</span>
<span class="c1">#define FINSH_ARG_MAX 10</span>

<span class="o">/*</span> <span class="n">Device</span> <span class="n">virtual</span> <span class="n">file</span> <span class="n">system</span> <span class="o">*/</span>


<span class="o">/*</span> <span class="n">Device</span> <span class="n">Drivers</span> <span class="o">*/</span>

<span class="c1">#define RT_USING_DEVICE_IPC</span>
<span class="c1">#define RT_PIPE_BUFSZ 512</span>
<span class="c1">#define RT_USING_SERIAL</span>
<span class="c1">#define RT_SERIAL_USING_DMA</span>
<span class="c1">#define RT_SERIAL_RB_BUFSZ 64</span>


<span class="c1">#define SOC_MAX32660</span>
<span class="c1">#define SOC_MAXIM</span>

<span class="o">/*</span> <span class="n">On</span><span class="o">-</span><span class="n">chip</span> <span class="n">Peripheral</span> <span class="n">Drivers</span> <span class="o">*/</span>

<span class="c1">#define BSP_USING_UART</span>
<span class="c1">#define BSP_USING_UART1</span>

<span class="c1">#endif</span>
</pre></div>
</div>
<p>最后两个是需要手动添加的，后面可以手动添加。</p>
<p><code class="docutils literal notranslate"><span class="pre">scons</span> <span class="pre">--target=mdk5</span></code>，然后打开project, 删除所有的和芯片相关的内容，保留RTTHREAD内核相关的内容，编译完成之后，根据GPIO里面的需要的文件，添加到RTTHREAD里面</p>
<p>通常对于ARM CORTEX-M4来讲，需要库里面的两个startup文件即可，</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>		<span class="o">-</span> <span class="n">system_max32660</span><span class="o">.</span><span class="n">c</span>  <span class="n">这个是C语言写的SystemInit函数</span>
		<span class="o">-</span> <span class="n">startup_max32660</span><span class="o">.</span><span class="n">s</span>  <span class="n">这个是汇编写的启动函数</span>
</pre></div>
</div>
<p>这两个文件基本都是不需要修改的。</p>
<p>剩下的就是一个board.c和application.c</p>
<p>application.c</p>
<p>参考demo</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">2020</span><span class="p">,</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Development</span> <span class="n">Team</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Change</span> <span class="n">Logs</span><span class="p">:</span>
 <span class="o">*</span> <span class="n">Date</span>           <span class="n">Author</span>       <span class="n">Notes</span>
 <span class="o">*</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span>     <span class="n">supperthomas</span> <span class="n">first</span> <span class="n">version</span>
 <span class="o">*</span>
 <span class="o">*/</span>

<span class="c1">#include &lt;rtthread.h&gt;</span>
<span class="c1">#include &lt;rtdevice.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
    
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>    
        <span class="n">rt_thread_mdelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>                    
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">RT_EOK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>board.c 参考demo</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">2020</span><span class="p">,</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Development</span> <span class="n">Team</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Change</span> <span class="n">Logs</span><span class="p">:</span>
 <span class="o">*</span> <span class="n">Date</span>           <span class="n">Author</span>       <span class="n">Notes</span>
 <span class="o">*</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">29</span>     <span class="n">supperthomas</span> <span class="n">first</span> <span class="n">version</span>
 <span class="o">*</span>
 <span class="o">*/</span>
<span class="c1">#include &lt;rtthread.h&gt;</span>
<span class="c1">#include &lt;rthw.h&gt;</span>

<span class="c1">#include &quot;board.h&quot;</span>

<span class="o">/**</span>
 <span class="o">*</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">timer</span> <span class="n">interrupt</span> <span class="n">service</span> <span class="n">routine</span><span class="o">.</span>
 <span class="o">*</span>
 <span class="o">*/</span>
<span class="n">void</span> <span class="n">SysTick_Handler</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">enter</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="n">rt_interrupt_enter</span><span class="p">();</span>

    <span class="n">rt_tick_increase</span><span class="p">();</span>

    <span class="o">/*</span> <span class="n">leave</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="n">rt_interrupt_leave</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">rt_hw_systick_init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">enter</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="n">rt_interrupt_enter</span><span class="p">();</span>

    <span class="n">rt_tick_increase</span><span class="p">();</span>

    <span class="o">/*</span> <span class="n">leave</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="n">rt_interrupt_leave</span><span class="p">();</span>
<span class="p">}</span>


<span class="n">void</span> <span class="n">rt_hw_board_init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="o">//</span> <span class="n">rt_hw_interrupt_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">sd_power_dcdc_mode_set</span><span class="p">(</span><span class="n">NRF_POWER_DCDC_ENABLE</span><span class="p">);</span>
    <span class="o">/*</span> <span class="n">Activate</span> <span class="n">deep</span> <span class="n">sleep</span> <span class="n">mode</span> <span class="o">*/</span>

    <span class="n">rt_hw_systick_init</span><span class="p">();</span>

<span class="o">//</span><span class="c1">#if defined(RT_USING_HEAP)</span>
<span class="o">//</span>    <span class="n">rt_system_heap_init</span><span class="p">((</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">HEAP_BEGIN</span><span class="p">,</span> <span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">HEAP_END</span><span class="p">);</span>
<span class="o">//</span><span class="c1">#endif</span>

<span class="o">//</span><span class="c1">#ifdef RT_USING_SERIAL</span>
<span class="o">//</span>    <span class="n">rt_hw_uart_init</span><span class="p">();</span>
<span class="o">//</span><span class="c1">#endif</span>

<span class="o">//</span><span class="c1">#ifdef RT_USING_CONSOLE</span>
<span class="o">//</span>    <span class="n">rt_console_set_device</span><span class="p">(</span><span class="n">RT_CONSOLE_DEVICE_NAME</span><span class="p">);</span>
<span class="o">//</span><span class="c1">#endif</span>

<span class="c1">#ifdef RT_USING_COMPONENTS_INIT</span>
    <span class="n">rt_components_board_init</span><span class="p">();</span>
<span class="c1">#endif</span>

<span class="p">}</span>
</pre></div>
</div>
<p>board.h参考demo</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*
 * Copyright (c) 2006-2020, RT-Thread Development Team
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs:
 * Date           Author       Notes
 * 2020-04-29     supperthomas first version
 */
#ifndef _BOARD_H_
#define _BOARD_H_

#include &lt;rtthread.h&gt;
#include &lt;rthw.h&gt;

#if defined(__CC_ARM) || defined(__CLANG_ARM)
extern int Image$$RW_IRAM1$$ZI$$Limit;
#define HEAP_BEGIN      ((void *)&amp;Image$$RW_IRAM1$$ZI$$Limit)
#elif __ICCARM__
#pragma section=&quot;CSTACK&quot;
#define HEAP_BEGIN      (__segment_end(&quot;CSTACK&quot;))
#else
extern int __bss_end__;
#define HEAP_BEGIN      ((void *)&amp;__bss_end__)
#endif

#define HEAP_END       (0x20001000)

void rt_hw_board_init(void);

#endif
</pre></div>
</div>
<p>上面3个文件都是可以直接编译通过的，根据GPIO例程，添加对应的一些.c文件即可。</p>
<p>这一步保证编译通过即可。</p>
</section>
<section id="id6">
<h3>调试systick<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p>systick可以是ARM里面的systick，也可以使用TIMER来代替。</p>
<p>TIMER分两步走，先配置时钟，设置timer的触发tick间隔，然后设置中断服务例程。</p>
<p>这个在官方服务例程中找对应的初始化，放到函数rt_hw_systick_init()中，</p>
<p>这个里面把timer设置成RT_TICK_PER_SECOND即可，这个通常是1000或者100，代表1s， timer起来1000次，1ms一次。</p>
<p><strong>中断服务例程</strong></p>
<p>systick有专门的服务例程SysTick_Handler，根据startup_max32660.s的中断向量表来的，其他TIMER可以找到对应的服务例程。</p>
<p>这边demo中已经写好了，只需要调rt_tick_increase函数即可。</p>
<p>这个时候编译通过，通过DEBUG 断点到main里面的while循环，看是否是0.5s触发一次断点即可。</p>
<p>如果这里调通了证明系统起来就快了。</p>
<p>如果这里调不通，需要整理main的入口等关系问题，</p>
</section>
<section id="gpio">
<h3>添加小灯GPIO<a class="headerlink" href="#gpio" title="此标题的永久链接"></a></h3>
<p>这个时候就可以点亮一个小灯来看看了。GPIO点亮小灯根据厂商给的demo来设置。无外乎是初始化GPIO然后翻转GPIO。这个时候可以根据厂商的demo来添加相关的文件，可能要添加库文件</p>
<p>添加到main函数里面，看下效果就好了，这一步编译完成之后，可以看到小灯一闪一闪亮晶晶了。这边基本系统已经跑起来了。</p>
</section>
<section id="drv-uart-c">
<h3>添加drv_uart.c<a class="headerlink" href="#drv-uart-c" title="此标题的永久链接"></a></h3>
<p>GPIO其实主要方便来看演示效果的，当然rtthread有个非常好的shell系统finsh，这个需要把drv_uart.c support起来就可以用了，当然如果你只用个内核不用finsh的话，也是可以的，但是通常上传到master分支上最好有个finsh功能，方便后面人在你的基础上继续完善其他功能。</p>
<p>这边提供一个可以编译通过的drv_uart.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
 <span class="o">*</span> <span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">2018</span><span class="p">,</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Development</span> <span class="n">Team</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">SPDX</span><span class="o">-</span><span class="n">License</span><span class="o">-</span><span class="n">Identifier</span><span class="p">:</span> <span class="n">Apache</span><span class="o">-</span><span class="mf">2.0</span>
 <span class="o">*</span>
 <span class="o">*</span> <span class="n">Change</span> <span class="n">Logs</span><span class="p">:</span>
 <span class="o">*</span> <span class="n">Date</span>           <span class="n">Author</span>       <span class="n">Notes</span>
 <span class="o">*</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">08</span>     <span class="n">Supperthomas</span> <span class="n">first</span> <span class="n">version</span>
 <span class="o">*/</span>

<span class="c1">#include &quot;board.h&quot;</span>
<span class="c1">#include &quot;uart.h&quot;</span>
<span class="c1">#include &quot;rtdevice.h&quot;</span>

<span class="c1">#define UART0_CONFIG                                                \</span>
    <span class="p">{</span>                                                               \
        <span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;uart0&quot;</span><span class="p">,</span>                                            \
        <span class="o">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">MXC_UART_GET_UART</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>                           \
        <span class="o">.</span><span class="n">irq_type</span> <span class="o">=</span> <span class="n">MXC_UART_GET_IRQ</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>                            \
    <span class="p">}</span>

    
<span class="c1">#define UART1_CONFIG                                                \</span>
    <span class="p">{</span>                                                               \
        <span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;uart1&quot;</span><span class="p">,</span>                                            \
        <span class="o">.</span><span class="n">Instance</span> <span class="o">=</span> <span class="n">MXC_UART_GET_UART</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                           \
        <span class="o">.</span><span class="n">irq_type</span> <span class="o">=</span> <span class="n">MXC_UART_GET_IRQ</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                            \
    <span class="p">}</span>

<span class="n">struct</span> <span class="n">mcu_uart_config</span>
<span class="p">{</span>
    <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">mxc_uart_regs_t</span> <span class="o">*</span><span class="n">Instance</span><span class="p">;</span>
    <span class="n">IRQn_Type</span> <span class="n">irq_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">struct</span> <span class="n">mcu_uart</span>
<span class="p">{</span>
    <span class="n">mxc_uart_regs_t</span> <span class="n">handle</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">mcu_uart_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

    <span class="n">rt_uint16_t</span> <span class="n">uart_dma_flag</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">rt_serial_device</span> <span class="n">serial</span><span class="p">;</span>
<span class="p">};</span>


<span class="c1">#ifdef RT_USING_SERIAL</span>

<span class="o">//</span><span class="c1">#define DRV_DEBUG</span>
<span class="o">//</span><span class="c1">#define LOG_TAG             &quot;drv.usart&quot;</span>
<span class="o">//</span><span class="c1">#include &lt;drv_log.h&gt;</span>

<span class="c1">#if !defined(BSP_USING_UART0) &amp;&amp; !defined(BSP_USING_UART1)</span>

<span class="c1">#error &quot;Please define at least one BSP_USING_UARTx&quot;</span>
<span class="o">/*</span> <span class="n">this</span> <span class="n">driver</span> <span class="n">can</span> <span class="n">be</span> <span class="n">disabled</span> <span class="n">at</span> <span class="n">menuconfig</span> <span class="o">-&gt;</span> <span class="n">RT</span><span class="o">-</span><span class="n">Thread</span> <span class="n">Components</span> <span class="o">-&gt;</span> <span class="n">Device</span> <span class="n">Drivers</span> <span class="o">*/</span>
<span class="c1">#endif</span>

<span class="n">enum</span>
<span class="p">{</span>
<span class="c1">#ifdef BSP_USING_UART0</span>
    <span class="n">UART0_INDEX</span><span class="p">,</span>
<span class="c1">#endif</span>
<span class="c1">#ifdef BSP_USING_UART1</span>
    <span class="n">UART1_INDEX</span><span class="p">,</span>
<span class="c1">#endif</span>

<span class="p">};</span>

<span class="n">static</span> <span class="n">struct</span> <span class="n">mcu_uart_config</span> <span class="n">uart_config</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="c1">#ifdef BSP_USING_UART0</span>
    <span class="n">UART0_CONFIG</span><span class="p">,</span>
<span class="c1">#endif</span>
<span class="c1">#ifdef BSP_USING_UART1</span>
    <span class="n">UART1_CONFIG</span><span class="p">,</span>
<span class="c1">#endif</span>
<span class="p">};</span>

<span class="n">static</span> <span class="n">struct</span> <span class="n">mcu_uart</span> <span class="n">uart_obj</span><span class="p">[</span><span class="n">sizeof</span><span class="p">(</span><span class="n">uart_config</span><span class="p">)</span> <span class="o">/</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">uart_config</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="n">static</span> <span class="n">rt_err_t</span> <span class="n">mcu_configure</span><span class="p">(</span><span class="n">struct</span> <span class="n">rt_serial_device</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">struct</span> <span class="n">serial_configure</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">mcu_uart</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>
    <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">);</span>
    <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">cfg</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">RT_EOK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">rt_err_t</span> <span class="n">mcu_control</span><span class="p">(</span><span class="n">struct</span> <span class="n">rt_serial_device</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="nb">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">mcu_uart</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>

    <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">);</span>
    <span class="n">uart</span> <span class="o">=</span> <span class="n">rt_container_of</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">struct</span> <span class="n">mcu_uart</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="o">/*</span> <span class="n">disable</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="k">case</span> <span class="n">RT_DEVICE_CTRL_CLR_INT</span><span class="p">:</span>
        <span class="o">/*</span> <span class="n">disable</span> <span class="n">rx</span> <span class="n">irq</span> <span class="o">*/</span>
        <span class="n">NVIC_DisableIRQ</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">irq_type</span><span class="p">);</span>
        <span class="o">/*</span> <span class="n">disable</span> <span class="n">interrupt</span> <span class="o">*/</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">enable</span> <span class="n">interrupt</span> <span class="o">*/</span>
    <span class="k">case</span> <span class="n">RT_DEVICE_CTRL_SET_INT</span><span class="p">:</span>
        <span class="o">/*</span> <span class="n">enable</span> <span class="n">rx</span> <span class="n">irq</span> <span class="o">*/</span>
        <span class="o">/*</span> <span class="n">enable</span> <span class="n">interrupt</span> <span class="o">*/</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">RT_DEVICE_CTRL_CLOSE</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="n">RT_EOK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">mcu_putc</span><span class="p">(</span><span class="n">struct</span> <span class="n">rt_serial_device</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">mcu_uart</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>
    <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">);</span>

    <span class="n">uart</span> <span class="o">=</span> <span class="n">rt_container_of</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">struct</span> <span class="n">mcu_uart</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>

    <span class="o">//</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="nb">int</span> <span class="n">mcu_getc</span><span class="p">(</span><span class="n">struct</span> <span class="n">rt_serial_device</span> <span class="o">*</span><span class="n">serial</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="n">ch</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">mcu_uart</span> <span class="o">*</span><span class="n">uart</span><span class="p">;</span>
    <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">);</span>
    <span class="n">uart</span> <span class="o">=</span> <span class="n">rt_container_of</span><span class="p">(</span><span class="n">serial</span><span class="p">,</span> <span class="n">struct</span> <span class="n">mcu_uart</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>

    <span class="n">ch</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="o">//</span><span class="k">if</span> <span class="p">(</span><span class="n">__HAL_UART_GET_FLAG</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">uart</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">),</span> <span class="n">UART_FLAG_RXNE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RESET</span><span class="p">)</span>
   <span class="o">//</span> <span class="p">{</span>
       <span class="o">//</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">uart</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">DR</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
   <span class="o">//</span> <span class="p">}</span>
    <span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">rt_uart_ops</span> <span class="n">mcu_uart_ops</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="o">.</span><span class="n">configure</span> <span class="o">=</span> <span class="n">mcu_configure</span><span class="p">,</span>
    <span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">mcu_control</span><span class="p">,</span>
    <span class="o">.</span><span class="n">putc</span> <span class="o">=</span> <span class="n">mcu_putc</span><span class="p">,</span>
    <span class="o">.</span><span class="n">getc</span> <span class="o">=</span> <span class="n">mcu_getc</span><span class="p">,</span>
<span class="p">};</span>

<span class="nb">int</span> <span class="n">rt_hw_usart_init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">rt_size_t</span> <span class="n">obj_num</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">uart_obj</span><span class="p">)</span> <span class="o">/</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">mcu_uart</span><span class="p">);</span>
    <span class="n">struct</span> <span class="n">serial_configure</span> <span class="n">config</span> <span class="o">=</span> <span class="n">RT_SERIAL_CONFIG_DEFAULT</span><span class="p">;</span>
    <span class="n">rt_err_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">/*</span> <span class="n">init</span> <span class="n">UART</span> <span class="nb">object</span> <span class="o">*/</span>
        <span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uart_config</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">ops</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">mcu_uart_ops</span><span class="p">;</span>
        <span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">register</span> <span class="n">UART</span> <span class="n">device</span> <span class="o">*/</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">rt_hw_serial_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">RT_DEVICE_FLAG_RDWR</span>
                                       <span class="o">|</span> <span class="n">RT_DEVICE_FLAG_INT_RX</span>
                                       <span class="o">|</span> <span class="n">RT_DEVICE_FLAG_INT_TX</span>
                                       <span class="o">|</span> <span class="n">uart_obj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uart_dma_flag</span>
                                       <span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
        <span class="n">RT_ASSERT</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RT_EOK</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span><span class="n">INIT_BOARD_EXPORT</span><span class="p">(</span><span class="n">rt_hw_usart_init</span><span class="p">);</span>
<span class="c1">#endif /* RT_USING_SERIAL */</span>
</pre></div>
</div>
<p>这边简单讲解一下这些函数作用，你就大概知道如何支持uart了。</p>
<ul class="simple">
<li><p>rt_hw_uart_init</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_usart_init</span></code> 这个函数在<code class="docutils literal notranslate"><span class="pre">rt_hw_board_init</span></code>里面systick初始化之后会调用</p>
<p>然后调用rt_console_set_device来设置console，这里是通过名称来关联的。</p>
<p><code class="docutils literal notranslate"><span class="pre">rt_hw_usart_init</span></code> 这个函数并不负责初始化uart串口，只是把下面的uart的所有操作注册进去，</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">rt_uart_ops</span> <span class="n">mcu_uart_ops</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="o">.</span><span class="n">configure</span> <span class="o">=</span> <span class="n">mcu_configure</span><span class="p">,</span>
    <span class="o">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">mcu_control</span><span class="p">,</span>
    <span class="o">.</span><span class="n">putc</span> <span class="o">=</span> <span class="n">mcu_putc</span><span class="p">,</span>
    <span class="o">.</span><span class="n">getc</span> <span class="o">=</span> <span class="n">mcu_getc</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>putc和getc</p></li>
</ul>
<p>这个比较好理解，就是你的uart驱动发送一个字节，和接收一个字节</p>
<p>这边通常是读取一个字节和发送一个字节的寄存器即可。这边不会涉及到中断等</p>
<ul class="simple">
<li><p>mcu_configure</p></li>
</ul>
<p>这个函数主要初始化uart寄存器，设置波特率等一些静态的参数</p>
<ul class="simple">
<li><p>mcu_control</p></li>
</ul>
<p>这里负责打开中断，开始接受串口数据</p>
<ul class="simple">
<li><p>中断服务例程</p></li>
</ul>
<p>中断服务例程需要通知rtthread去掉getc取数据</p>
<p>这边需要知道中断如何清中断，并且掉rt_hw_serial_isr函数来通知来取数据</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">UART1_IRQHandler</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">rt_interrupt_enter</span><span class="p">();</span>

    <span class="n">rt_hw_serial_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">uart_obj</span><span class="p">[</span><span class="n">UART1_INDEX</span><span class="p">]</span><span class="o">.</span><span class="n">serial</span><span class="p">),</span> <span class="n">RT_SERIAL_EVENT_RX_IND</span><span class="p">);</span>

    <span class="n">uint32_t</span>  <span class="n">intst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">intst</span> <span class="o">=</span> <span class="n">MXC_UART1</span><span class="o">-&gt;</span><span class="n">int_fl</span><span class="p">;</span>
    <span class="n">MXC_UART1</span><span class="o">-&gt;</span><span class="n">int_fl</span> <span class="o">=</span> <span class="n">intst</span><span class="p">;</span>

    <span class="n">rt_interrupt_leave</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>这边可以先支持putc就是UART TX，先看到串口有数据发出来就可以了。之后比较难的就是UART RX了。</p>
<p>这部分要根据官方例程做一些实验，我这边是要知道UART 的IDLE中断什么时候触发，或者一些其他FIFO满中断如何触发。然后设置对应的寄存器即可。</p>
<p>UART调通之后，会看到串口可以打印响应的信息了</p>
<p><img alt="../../_images/image-20210212172232785.png" src="../../_images/image-20210212172232785.png" /></p>
<p>能达到这个效果就不错了，可以做很多事情了。</p>
<p>这边调好一个UART之后，可以试着调另外一个UART。把这个放到对应的.c里面即可或者放到application.c里面即可，我们通过命令来测试下即可，这边需要将UART TX RX两个引脚对连起来。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;rtthread.h&gt;
// you can connect the uart tx with rx 
#define SAMPLE_UART_NAME       &quot;uart0&quot;      /* ?????? */
#define UART_DATA_TEST_SIZE         10

static struct rt_semaphore rx_sem;
static rt_device_t serial;
static char tx_data[UART_DATA_TEST_SIZE];
static char rx_data[UART_DATA_TEST_SIZE];

static rt_err_t uart_input(rt_device_t dev, rt_size_t size)
{

    rt_sem_release(&amp;rx_sem);

    return RT_EOK;
}

static void serial_thread_entry(void *parameter)
{
    char ch;
    int index=0;

    while (1)
    {

        while (rt_device_read(serial, -1, &amp;ch, 1) != 1)
        {
            rt_sem_take(&amp;rx_sem, RT_WAITING_FOREVER);
        }
        rx_data[index++] = ch;
        rt_kprintf(&quot;\r\n transmit data:%x\r\n&quot;,ch);
        if(index &gt;=UART_DATA_TEST_SIZE)
        {
            rt_kprintf(&quot;\r\n transmit done\r\n&quot;);
            index = 0;
            break;
        }
    }
}

static int uart_sample(int argc, char *argv[])
{
    rt_err_t ret = RT_EOK;
    char uart_name[RT_NAME_MAX];

    for(int i = 0;i&lt; UART_DATA_TEST_SIZE;i++)
    {
        tx_data[i] = i;
    }
    if (argc == 2)
    {
        rt_strncpy(uart_name, argv[1], RT_NAME_MAX);
    }
    else
    {
        rt_strncpy(uart_name, SAMPLE_UART_NAME, RT_NAME_MAX);
    }

    serial = rt_device_find(uart_name);
    if (!serial)
    {
        rt_kprintf(&quot;find %s failed!\n&quot;, uart_name);
        return RT_ERROR;
    }

    rt_sem_init(&amp;rx_sem, &quot;rx_sem&quot;, 0, RT_IPC_FLAG_FIFO);
    rt_device_open(serial, RT_DEVICE_FLAG_INT_RX);
    rt_device_set_rx_indicate(serial, uart_input);
    rt_device_write(serial, 0, tx_data, UART_DATA_TEST_SIZE);

    rt_thread_t thread = rt_thread_create(&quot;serial&quot;, serial_thread_entry, RT_NULL, 1024, 25, 10);

    if (thread != RT_NULL)
    {
        rt_thread_startup(thread);
    }
    else
    {
        ret = RT_ERROR;
    }

    return ret;
}
MSH_CMD_EXPORT(uart_sample, uart device sample);
</pre></div>
</div>
</section>
<section id="pr">
<h3>PR工程<a class="headerlink" href="#pr" title="此标题的永久链接"></a></h3>
<p>PR工程是个比较浩大的工程，需要了解bsp里面的每一个细节：</p>
<p>这边你可以学一下scons如何使用的来对对应的文件进行修改：<a class="reference external" href="https://www.rt-thread.org/document/site/programming-manual/scons/scons/">SCons 构建工具</a></p>
<p>以及Kconfig语法：<a class="reference external" href="https://www.rt-thread.org/document/site/programming-manual/kconfig/kconfig/">Kconfig 语法</a></p>
<section id="kconfig">
<h4>Kconfig<a class="headerlink" href="#kconfig" title="此标题的永久链接"></a></h4>
<p>Kconfig主要用来生成#define头文件，主要服务于rtconfig.h的，所以如果你之前手动在rtconfig.h里添加的宏定义如果想做的比较好的话，需要在对应的Kconfig里面添加。这个主要看你需要menuconfig在哪个目录下面，通常是bsp目录下面的Kconfig索引到其他的例如board/Kconfig</p>
<p>通常在board/Kconfig里面需要添加一些模块UART和GPIO</p>
<p>主要是改board/Kconfig</p>
</section>
<section id="scons">
<h4>scons<a class="headerlink" href="#scons" title="此标题的永久链接"></a></h4>
<p>这个就比较复杂了，耗时也比较多。</p>
<p>首先在你scons的目录下，通常bsp目录下面</p>
<ul class="simple">
<li><p>SConstruct</p></li>
</ul>
<p>这个文件是用来包含一些其他文件夹中的SConscript的</p>
<ul class="simple">
<li><p>SConscript</p></li>
</ul>
<p>所有你需要单独包含的文件夹，都需要用SConscript这个文件来索引该目录下面的需要的配置文件，</p>
<p>board下面的SConscript需要重点维护，其他如果官方的HAL库需要对应的文件，也是需要修改的。</p>
<ul class="simple">
<li><p>rtconfig.py</p></li>
</ul>
<p>这个文件用来修改编译器相关的一些配置，和选项的，这部分比较复杂一些，可以学习一下一些编译选项</p>
<ul class="simple">
<li><p>link_scripts</p></li>
</ul>
<p>这个文件夹里面主要存放的是link相关的一些配置，比如RAM地址和ROM地址</p>
<p>大概需要修改的就是这些文件，其他可能还有比较多，主要的离不开这几个，有些参数可以放到template里面现行设置，后期等找到合适的方式再继续整理。</p>
</section>
</section>
<section id="readme-md">
<h3>写下readme.md<a class="headerlink" href="#readme-md" title="此标题的永久链接"></a></h3>
</section>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>