<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. GATT &amp; ATT &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="4. SMP（BLE)" href="../03_ble_smp/SMP.html" />
    <link rel="prev" title="2. BLE 广播和扫描" href="../01_ble_adv/ble_adv_scan_all.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">BLE STACK篇</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../00_ble_introduce/BLE_introduce.html">1. 蓝牙基本知识介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01_ble_adv/ble_adv_scan_all.html">2. BLE 广播和扫描</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. GATT &amp; ATT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#att">3.1. ATT简介</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">协议内容：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">ATT 定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#att-pdu">ATT PDU</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gatt">3.2. GATT 简介</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">GATT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">框架结构：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#service">service 的定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#include">include 定义：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#characteristic">characteristic 定义：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#value">value 定义：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#descriptor">descriptor 定义</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">GATT常用类型：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">GATT常规操作：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#clientvalue">client读value数据：</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client">client写数据：</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">3.3. client搜索服务</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../03_ble_smp/SMP.html">4. SMP（BLE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_ble%E5%AE%89%E5%85%A8/%E8%B5%84%E6%96%99.html">5. BLE 配对机制</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">BLE STACK篇</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>GATT &amp; ATT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/ble/02_ble_gatt/GATT.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="gatt-att">
<h1><span class="section-number">3. </span>GATT &amp; ATT<a class="headerlink" href="#gatt-att" title="此标题的永久链接"></a></h1>
<section id="att">
<h2><span class="section-number">3.1. </span>ATT简介<a class="headerlink" href="#att" title="此标题的永久链接"></a></h2>
<p>ATT（attribute protocol） 这个是一个protocol，是用于搜索发现和读写对端设备属性的通信协议。</p>
<section id="id1">
<h3>协议内容：<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h3>
<p>有两种角色： Service role 和client role。这个是标准的CS模型。</p>
<p>每个属性由4部分组成：</p>
<ul class="simple">
<li><p>属性type，由UUID设定，UUID，由<a class="reference external" href="https://www.bluetooth.com/specifications/assigned-numbers">Assigned Numbe</a>r</p></li>
<li><p>属性handle</p></li>
<li><p>一系列的权限permission。</p></li>
<li><p>value值</p></li>
</ul>
<p><img alt="../../_images/att_struct.jpg" src="../../_images/att_struct.jpg" /></p>
</section>
<section id="id2">
<h3>ATT 定义<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h3>
<section id="attribute-type">
<h4>attribute TYPE<a class="headerlink" href="#attribute-type" title="此标题的永久链接"></a></h4>
<p>type类型，都是由UUID来标志的。</p>
<p>UUID:</p>
<p>(Universally Unique IDentifier):唯一标识符</p>
<p>uuid有16bit，也有32bit，也有128bit的。</p>
<p>总体来讲，最后都会变成128bit。比如16bit，这个会嵌入到一个通用的蓝牙基准UUID</p>
<p><img alt="../../_images/uuid.jpg" src="../../_images/uuid.jpg" /></p>
<p>比如battery电池服务是0x180F</p>
<p>转换成128bit就是：</p>
<p>000000180f-0000-1000-8000-00805f9b34fb.</p>
<p>可以这么理解，16bit只是方便一些标志的profile设置uuid，但是最终如果解析不出来或者central不认识这个profile，会以128bit显示给客户告知客户这个uuid不认识。</p>
</section>
<section id="att-handle">
<h4>ATT HANDLE<a class="headerlink" href="#att-handle" title="此标题的永久链接"></a></h4>
<p>handle的取值范围0x0001-0xFFFF， 0xFFFF就是最大的handle值了，这个有2个byte来代表。</p>
</section>
<section id="att-handl-grouping">
<h4>ATT handl grouping<a class="headerlink" href="#att-handl-grouping" title="此标题的永久链接"></a></h4>
<p>这个用的不是很多，暂时不介绍</p>
</section>
<section id="att-value">
<h4>ATT value<a class="headerlink" href="#att-value" title="此标题的永久链接"></a></h4>
<p>ATT的值，也就是每个属性里面的值，通常是由UUID决定的TYPE来决定的，如果uuid未定义，或者自行定义的一个UUID，则双方协商好即可，实际上黑盒的情况下，client端是无法知道这个值的长度的，只能通过read 读出来看看，长度是怎样的。write的时候，实际上也是可以随便写的，由service端判断数据的正确性，当然要符合MTU size大小。</p>
<p><img alt="图片" src="../../_images/att_handle.jpg" /></p>
</section>
<section id="id3">
<h4>ATT 权限<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h4>
<p>service端的ATT权限并不能被client获取到，只能client来读取的时候，service端反馈给client端，该ATT是否需要权限，如果有权限需要加密，则返回client端没有权限，返回ERROR权限不够，这个时候client端会去做bond相关的动作以达到权限。</p>
<p>权限分为以下等级：</p>
<section id="id4">
<h5>访问权限<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h5>
<ul class="simple">
<li><p>可读</p></li>
<li><p>可写</p></li>
<li><p>可读可写</p></li>
</ul>
<p>当读取属性值时，需要判断这个属性值是否可读。如果不可读。服务器会返回一个属性不可读的状态。当写入属性值时，也需要检测这个属性是否可写，否则会收到属性值不可写的状态信息</p>
</section>
<section id="encryption">
<h5>encryption 权限<a class="headerlink" href="#encryption" title="此标题的永久链接"></a></h5>
<ul class="simple">
<li><p>需要加密</p></li>
<li><p>不需要加密</p></li>
</ul>
</section>
<section id="authentication">
<h5>authentication权限<a class="headerlink" href="#authentication" title="此标题的永久链接"></a></h5>
<ul class="simple">
<li><p>需要认证</p></li>
<li><p>不需要认证</p></li>
</ul>
</section>
<section id="authorization">
<h5>authorization 权限<a class="headerlink" href="#authorization" title="此标题的永久链接"></a></h5>
<ul class="simple">
<li><p>需要授权</p></li>
<li><p>不需要授权</p></li>
</ul>
<p>再次强调：属性许可不能通过属性协议访问到这个 handle属性值的权限，这个权限只有当客户端访问服务器时才会将需要访问这个属性权限的条件(错误码)返回给服务器，进而服务器做出相应的处理。</p>
</section>
</section>
<section id="exchange-mtu-size">
<h4>exchange MTU size<a class="headerlink" href="#exchange-mtu-size" title="此标题的永久链接"></a></h4>
<p>MTU(max transmission unit）最大传输单元， 这个是两边协商得来的。</p>
<p>连上之后通常第一笔ATT包就要两边相互协商好MTU size。</p>
<p><img alt="图片" src="../../_images/att.jpg" /></p>
<ul class="simple">
<li><p>client端发送如下图</p></li>
</ul>
<p><img alt="图片" src="../../_images/att_mtu.jpg" /></p>
<p>Master告诉对端自己的RX能力是517 Byte</p>
<ul class="simple">
<li><p>service 回复如下：</p></li>
</ul>
<p><img alt="图片" src="../../_images/service.jpg" /></p>
<p>service 回复自己的RX能力是244。</p>
<p>在低功耗蓝牙连接中，属性协议默认的 MTU 为 23 字节。一般客户端是不会发起这个请求的，它的默认值就是 23，当双方交换的值不同时，用较小的那个作为最终使用的值。</p>
<p>通常这个MTU 默认值是23.</p>
</section>
<section id="control-point-attibutes">
<h4>Control-Point Attibutes<a class="headerlink" href="#control-point-attibutes" title="此标题的永久链接"></a></h4>
<p>一种特殊的属性，不可被读，可以被写</p>
</section>
<section id="long-attribute-value">
<h4>long attribute value<a class="headerlink" href="#long-attribute-value" title="此标题的永久链接"></a></h4>
<p>一个att最长是MTU-1，如果长度大于该值，如果要读整个value值，就要使用ATT_READ_BLOB_REQ。如果只读第一个ATT_MTU-1就可以用ATT_READ_REQ</p>
</section>
<section id="find-information-reqeust-response">
<h4>Find information reqeust/ response<a class="headerlink" href="#find-information-reqeust-response" title="此标题的永久链接"></a></h4>
<p><img alt="../../_images/find_information.jpg" src="../../_images/find_information.jpg" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   查找信息请求和回复用来查找一系列属性的句柄和类型信息。这是唯一一个能让客户端发现任意属性类型的消息。查找信息请求包含有两个句柄：起始句柄和结束句柄。它们定义了该请求用到的属性句柄范围。为了找到所有数值的属性，该请求的起始句柄将是 0x0001，结束句柄设为 0xFFFF。但是回复的信息中因为长度限制，并不能包含所有的属性，所以需要再次请求，只是将起始句柄改为查找到的最大句柄的后一个句柄开始。
</pre></div>
</div>
<p><img alt="图片" src="../../_images/att_find_information_req.jpg" /></p>
<p><img alt="图片" src="../../_images/att_role.jpg" /></p>
<p><img alt="图片" src="../../_images/att_find_information_rsp.jpg" /></p>
<p><img alt="图片" src="../../_images/bt_snoopy.jpg" /></p>
</section>
<section id="find-information-by-type-value-response">
<h4>find information by type value/response<a class="headerlink" href="#find-information-by-type-value-response" title="此标题的永久链接"></a></h4>
<p>根据类型值查找information/应答</p>
<p>这个就是比上面多了一个type value类型，可以根据类型查找。</p>
<p><img alt="图片" src="../../_images/att_find_by_type_value_req.jpg" /></p>
<p><img alt="图片" src="../../_images/find_by_type_value_request.jpg" /></p>
</section>
<section id="read-by-type-request-response">
<h4>read by type request /response<a class="headerlink" href="#read-by-type-request-response" title="此标题的永久链接"></a></h4>
<p>这个通常根据type来读取该属性的value值。</p>
<p><img alt="图片" src="../../_images/211_btsnoopy.jpg" /></p>
<p>返回：</p>
<p><img alt="图片" src="../../_images/211_btsnoopy2.jpg" /></p>
<p><img alt="图片" src="https://uploader.shimo.im/f/ZYIzwmGYg7MBq0zE.png%21thumbnail" /></p>
</section>
</section>
<section id="att-pdu">
<h3>ATT PDU<a class="headerlink" href="#att-pdu" title="此标题的永久链接"></a></h3>
<p>有6种PDU 类型：</p>
<p><img alt="图片" src="../../_images/ATT_PDU.jpg" /></p>
<ul class="simple">
<li><p>commands - client -&gt; server</p></li>
<li><p>requests     - client-&gt;server  需要有回复</p></li>
<li><p>responses  - server-&gt;client 回复，和request是一对</p></li>
<li><p>Notification  -    server-&gt;client 发送通知。</p></li>
<li><p>indications  -    server-&gt;client 这个和notify作用一样，但是要等到client端回复。</p></li>
<li><p>confirmations - client-&gt; server，这个和indications是一对。</p></li>
</ul>
<ol class="simple">
<li><p>ERROR CODE</p></li>
</ol>
<p>每一个error code都是由4部分组成</p>
<p><img alt="图片" src="../../_images/ATT_WRITE_CMD.jpg" /></p>
<ul class="simple">
<li><p>ATT OPCODE                                      必须为0x01 ATT_ERROR_RSP</p></li>
<li><p>REQUEST OPCODE IN ERROR        上一次request的OPCODE</p></li>
<li><p>ATTRIBUTE HANDLE INERROR        操作的handle</p></li>
<li><p>ERROR CODE                                    错误码</p></li>
<li></li>
</ul>
<p><img alt="图片" src="../../_images/error_code.jpg" /></p>
<p><img alt="图片" src="../../_images/app_error_code.jpg" /></p>
<p><img alt="图片" src="../../_images/att_snoopy_1.jpg" /></p>
</section>
</section>
<section id="gatt">
<h2><span class="section-number">3.2. </span>GATT 简介<a class="headerlink" href="#gatt" title="此标题的永久链接"></a></h2>
<section id="id5">
<h3>GATT<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>Generic attribute profile规定了一个profile并用att protocol来进行处理两边设备的交互。</p>
<p>这个是GATT 和GAP的一个简单的关系</p>
<p><img alt="图片" src="../../_images/gap_image.jpg" /></p>
<p><img alt="图片" src="../../_images/gatt_handle.jpg" /></p>
<p>这个是两个角色通常：</p>
<p>client： 通常手机或者电脑这些由人操作的设备都是client端</p>
<p>servcie：通常sensor 温度计这种就是service端。</p>
</section>
<section id="id6">
<h3>框架结构：<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p><img alt="图片" src="../../_images/gatt_profile.jpg" /></p>
<ul class="simple">
<li><p>service</p></li>
<li><p>include</p></li>
<li><p>characteristic</p></li>
</ul>
<p>一个service 代表一个profile，比如电池服务，配网服务。</p>
<p>一个include 代表这个service需要包含其他服务才能工作。（这个用的不多）</p>
<p>characteristic 这个是属性的真实值，这张表中每个属性叫做characteristic，每个characteristic都会有一个properites（就是属性的属性值，这个值是有规范的，下面讲，）</p>
<p>value：就是该属性代表的值</p>
<p>desriptor: 这个可有可无，用来描述该属性的。</p>
</section>
<section id="service">
<h3>service 的定义<a class="headerlink" href="#service" title="此标题的永久链接"></a></h3>
<p><img alt="图片" src="../../_images/service_define.jpg" /></p>
<p>对于service，只有有个uuid即可。通常service为primary service，这个是主服务。</p>
<p>比如：</p>
<p>handle：0x0001</p>
<p>attribute type: 0x2800 (这个代表是primary service 的uuid)</p>
<p>attribute value: (这里存放的是uuid，可以是16bit，或者128bit的)</p>
<p>permission: service 的permission默认是read only</p>
</section>
<section id="include">
<h3>include 定义：<a class="headerlink" href="#include" title="此标题的永久链接"></a></h3>
<p><img alt="图片" src="../../_images/include.jpg" /></p>
<p>这个用的比较少，就不详细说了，就是这个attribute value会指示这个service里面的多少到多少是include 的service</p>
</section>
<section id="characteristic">
<h3>characteristic 定义：<a class="headerlink" href="#characteristic" title="此标题的永久链接"></a></h3>
<p>这个比较重要：</p>
<p><img alt="图片" src="../../_images/characteristic.jpg" /></p>
<section id="properties">
<h4>properties<a class="headerlink" href="#properties" title="此标题的永久链接"></a></h4>
<p>这个是该属性的初步的是否可以读写的属性（注意，并不是该属性是否需要建立加密信息的标志），这个是给client端，告诉他，你可以对这个属性做哪些基本操作。</p>
<p><img alt="../../_images/properties.jpg" src="../../_images/properties.jpg" /></p>
<p><img alt="../../_images/properties2.jpg" src="../../_images/properties2.jpg" /></p>
<p>这里面每一位代表一些意思：</p>
<ul class="simple">
<li><p>broadcast：这个用的比较少，应该跟广播相关</p></li>
<li><p>read permitted：允许读</p></li>
<li><p>write without response ：允许write cmd</p></li>
<li><p>wirte ： 可以write</p></li>
<li><p>notify：可以notify</p></li>
<li><p>indicated： 可以indicated</p></li>
<li><p>authenticated signed writes: 需要签名才可以写。</p></li>
<li><p>extened properits： 额外的属性需要设置(用的比较少）</p></li>
</ul>
</section>
<section id="handle">
<h4>handle<a class="headerlink" href="#handle" title="此标题的永久链接"></a></h4>
<p>charactertistic 的handle值，基本上是GATT比较精髓的地方。</p>
</section>
<section id="uuid">
<h4>uuid<a class="headerlink" href="#uuid" title="此标题的永久链接"></a></h4>
<p>这个表示该属性的类型uuid，和身份证号码差不多。</p>
</section>
</section>
<section id="value">
<h3>value 定义：<a class="headerlink" href="#value" title="此标题的永久链接"></a></h3>
<p>为啥要有个value定义呢，就是每个专门的属性需要一个handle来存放具体的value值，最后read或者write都是对这个value 的定义来操作，上面characteristic也占一个handle，用来表示这个value的有哪些操作可以做。</p>
<p><img alt="图片" src="../../_images/value.jpg" /></p>
</section>
<section id="descriptor">
<h3>descriptor 定义<a class="headerlink" href="#descriptor" title="此标题的永久链接"></a></h3>
<p>descriptor的定义和上面属性不同，大体上意思就是这个descritor就是用来修饰上面的characteristic属性的。比如你自定义某个uuid的时候，蓝牙SIG没有规定这个uuid是哪个profile。但是你又想要告诉对端这个uuid显示成哪个字符串，就可以加 一个descriptor来修饰一下上面的characteristic。</p>
<p>另外description有个重要的作用：</p>
<p><img alt="图片" src="https://uploader.shimo.im/f/jb6CvJ1DzWJO6yBd.png%21thumbnail" /></p>
<p><img alt="图片" src="../../_images/descriptor.jpg" /></p>
<p>这个可以修饰该characteristic是否可以让service发数据给client端。</p>
<p>一共有两个BIT</p>
<p><img alt="../../_images/notification.jpg" src="../../_images/notification.jpg" /></p>
<p><img alt="图片" src="../../_images/descript.jpg" /></p>
<p>这个通常简称是CCCD， 是用来给service的属性来开关的额，只有当这个属性值写yes的时候，service才能发送对应的notify。</p>
<p>所以理论上，手机和sensor连上之后，sensor是不允许发数据给手机的。只能手机通过打开这个开关，sensor才能发数据给手机（协议上是这样规定的）。</p>
<p>这个标志在上面properties就有对应的说明，</p>
<p>用手机上nrf connect连上之后，这个由上角的3个箭头的，就是CCCD，点击就是打开，</p>
<p><img alt="图片" src="../../_images/nrf_connect1.jpg" /></p>
<p>打开之后，就可以看到service 端发数据过来，也能看到notify enable了：</p>
<p><img alt="图片" src="../../_images/batter_level.jpg" /></p>
</section>
<section id="id7">
<h3>GATT常用类型：<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>GATT profile规定了以下类型：</p>
<p><img alt="图片" src="../../_images/att_profile.jpg" /></p>
<p><img alt="图片" src="../../_images/att_type.jpg" /></p>
<p>这些都是特定的uuid，在SIG中明确规定：</p>
<p>常用的就是以下几个：</p>
<ul class="simple">
<li><p>primary service 0x2800</p></li>
<li><p>secondary service 0x2801</p></li>
<li><p>include    0x2802</p></li>
<li><p>characteristic   0x2803</p></li>
<li><p>client charcteristic config  0x2902</p></li>
</ul>
<p>其他不是特别常用，就不介绍了。</p>
<p>讲了这么多，最好能举个例子：</p>
<p>我们就以最简单的电池管理协议（battery service）</p>
<p>电池管理协议就一个属性：</p>
<p>电池level： 0~100</p>
<p>一个byte：</p>
<p>蓝牙规定了两个UUID:</p>
<p>0x180F: 电池管理服务 battery service</p>
<p>0x2A19: battery level 电池电量属性</p>
<p>我们来看下spec：</p>
<p><img alt="图片" src="../../_images/spec.jpg" /></p>
<p>这个servie就一个可以read的属性battery level</p>
<p>notify属性是可选的。可以有，可以没有：</p>
<p>可以这么理解：</p>
<p><img alt="图片" src="../../_images/batt.jpg" /></p>
<p>我们先来看下一些协议栈对这张表如何来写：</p>
<p>比如nimble：</p>
<p><img alt="图片" src="../../_images/nimble.jpg" /></p>
<p>其实这张表的本质和精髓就是handle，我们可以从handle上面理解。</p>
<p>(当然这个handle是根据不同service会有所变化的，我们现在就以只有一个battery service的sensor为例)</p>
<ul class="simple">
<li><p>handle: 0x0001</p></li>
</ul>
<p>type: primary servive  (0x2800)</p>
<p>value: 0x180f(battery service uuid)</p>
<p><img alt="图片" src="../../_images/handle.jpg" /></p>
<ul class="simple">
<li><p>handle 0x0002</p></li>
</ul>
<p>type: charactertistic (0x2803)</p>
<p>properties: notify(yes), read(yes)</p>
<p><img alt="图片" src="../../_images/handle_2.jpg" /></p>
<ul class="simple">
<li><p>handle 0x0003</p></li>
</ul>
<p>type: uuid：0x2A19</p>
<p>这是一个value</p>
<p><img alt="图片" src="../../_images/2a19.jpg" /></p>
<ul class="simple">
<li><p>handle 0x0004</p></li>
</ul>
<p>type: uuid:  0x2902(CCCD)</p>
<p><img alt="图片" src="../../_images/ccd.jpg" /></p>
<p>value:这个实际上没有值，都是由client端来保存的。</p>
<p>当client端需要来读电池电量的值时，只要发read request给对端，要读handle为0x0003的值，service端即把值通过read response返回给client端。</p>
<p><img alt="图片" src="../../_images/gatt.jpg" /></p>
<p>如果要打开CCCD，打开之后，service 就可以主动给client端发送电量数据，可以通过send notify 这个PDU 来发送，用handle 0x0003即可：</p>
</section>
<section id="id8">
<h3>GATT常规操作：<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h3>
<p>对于GATT service而言，就是把上面那张表注册到协议栈即可，后续的client端来读写数据，都是根据handle来的。我们先来讲一下CS如何读写数据，这边就要和ATT相联系起来了。</p>
</section>
<section id="clientvalue">
<h3>client读value数据：<a class="headerlink" href="#clientvalue" title="此标题的永久链接"></a></h3>
<p>读写操作都是根据handle来的，只要知道handle，就可以读数据：</p>
<p>读值</p>
<p><img alt="图片" src="../../_images/6_1_1.jpg" /></p>
<p>如果数据太长的话，后面要用BLOB来读。</p>
</section>
<section id="client">
<h3>client写数据：<a class="headerlink" href="#client" title="此标题的永久链接"></a></h3>
<section id="write-with-no-response">
<h4>write with no response<a class="headerlink" href="#write-with-no-response" title="此标题的永久链接"></a></h4>
<p><img alt="图片" src="../../_images/6_2_1.jpg" /></p>
<p>write cmd就是不需要对端回应的cmd</p>
</section>
<section id="write-request">
<h4>write request<a class="headerlink" href="#write-request" title="此标题的永久链接"></a></h4>
<p><img alt="图片" src="../../_images/6_2_2.jpg" /></p>
<p>write request 就是需要对端回response的，让service知道的操作。</p>
</section>
<section id="id9">
<h4>service 写数据：<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h4>
<p>service 写数据分两种notify和indicated，（和write cmd reqest类似）。</p>
</section>
<section id="notify">
<h4>notify<a class="headerlink" href="#notify" title="此标题的永久链接"></a></h4>
<p>notify是不需要做出响应的：</p>
<p><img alt="图片" src="../../_images/6_3_1.jpg" /></p>
</section>
<section id="indicate">
<h4>indicate<a class="headerlink" href="#indicate" title="此标题的永久链接"></a></h4>
<p>indicated是需要做出响应的：</p>
<p><img alt="图片" src="../../_images/6_3_2.jpg" /></p>
<p>主要就是上面的基本操作，其他的都是拓展出来的，比较多，这边就不展开介绍了。理解这几个概念比较常用了。</p>
</section>
</section>
</section>
<section id="id10">
<h2><span class="section-number">3.3. </span>client搜索服务<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p>剩下的操作就是client搜索服务了。client端刚连上service的时候，会需要获取到这张表，这张表怎么获取就因表而异了。比如central端可以只搜索特定的服务，也可以把整张表都查出来。这个流程比较繁琐。拿个表稍微讲下即可。</p>
<ol class="simple">
<li><p>各个协议栈对handle的操作：</p></li>
</ol>
<p>通常常规做法，都是分治思想，每个service 管理自己的handle。但是这个handle又是动态的，所以有两种处理方法：</p>
<ul class="simple">
<li><p>由协议栈返回相对handle，offset_handle， profile提供对应的callback处理函数，处理offset_handle</p></li>
<li><p>由协议栈返回绝对handle，这个时候各个profile就要拿一个全局变量来保存这个handle。</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../01_ble_adv/ble_adv_scan_all.html" class="btn btn-neutral float-left" title="2. BLE 广播和扫描" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../03_ble_smp/SMP.html" class="btn btn-neutral float-right" title="4. SMP（BLE)" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>