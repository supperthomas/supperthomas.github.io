<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6. MCUBOOT &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="7. ARM-MPU 详解" href="../08_MPU/01_MPU.html" />
    <link rel="prev" title="5. 嵌入式调试" href="../06_embeded_debug/jlink.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">MASTER:supperthomas</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_introduce/01_intruduce.html">2. BLE 相关资料</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_mbed/01_mbed_quick_syart.html">3. mbed OS  quick start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_AI/01_intruduce.html">4. 深度学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_embeded_debug/jlink.html">5. 嵌入式调试</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6. MCUBOOT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">6.1. 什么是MCUBOOT</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">6.2. 固件签名</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">6.3. 为什么要签名固件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ecdsa">6.4. ECDSA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">6.5. MCUBOOT 的使用情况</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">6.6. MCUBOOT依赖情况</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">6.7. MCUBOOT大小</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">6.8. MCUBOOT支持的软件加密模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">6.9. MCUBOOT 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">6.10. MCUBOOT 一些概念</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">6.11. MCUBOOT 更新方式</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overwrite">覆盖模式 OVERWRITE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">交换模式</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id12">6.12. 加密部分</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nordic-mcuboot">6.13. Nordic MCUBOOT 的使用</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bin">BIN文件如何生成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">BIN头部</a></li>
<li class="toctree-l4"><a class="reference internal" href="#slot">SLOT尾部</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bin-tlv">BIN 尾部tlv</a></li>
<li class="toctree-l4"><a class="reference internal" href="#imgtool-py">imgtool.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id14">6.14. MCUBOOT 运行流程及注意事项</a></li>
<li class="toctree-l3"><a class="reference internal" href="#swap">6.15. SWAP类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">6.16. 参考文档</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../08_MPU/01_MPU.html">7. ARM-MPU 详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_doxygen/doxygen.html">8. 玩转doxygen 之RT-THREAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_lvgl/lvgl_app.html">9. LVGL 学习小计 –（一） 应用层</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">MASTER:supperthomas</a></li>
      <li class="breadcrumb-item active"><span class="section-number">6. </span>MCUBOOT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/00_supperthomas/07_mcuboot/mcuboot.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mcuboot">
<h1><span class="section-number">6. </span>MCUBOOT<a class="headerlink" href="#mcuboot" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2><span class="section-number">6.1. </span>什么是MCUBOOT<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p><a class="reference external" href="https://mcuboot.com">mcuboot</a> 和常用的BootLoader有一些区别，实际上mcuboot相当于一个安全的引导程序，（注意这里的mcuboot只关注于安全引导，像我们常用的BootLoader的传输啊什么之类的，并不在mcuboot定义范围内）</p>
<p>mcuboot有以下功能</p>
<ul class="simple">
<li><p>固件更新的安全性检查，固件签名</p></li>
<li><p>标准的FLASH MAP分配规则</p></li>
<li><p>移植起来比较方便</p></li>
</ul>
<p>还可以通过添加config的方式添加如下功能：</p>
<ul class="simple">
<li><p>加解密固件二进制</p></li>
<li><p>容错升级（意外重启之后恢复）</p></li>
<li><p>恢复系统</p></li>
</ul>
<p>参考链接</p>
<p><a class="reference external" href="https://mcuboot.com">MCUBOOT 官网</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/">MCUBOOT 文档</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/design/">MCUBOOT 设计文档</a></p>
<p><a class="reference external" href="https://github.com/mcu-tools/mcuboot">MCUBOOT GITHUB</a></p>
</section>
<section id="id2">
<h2><span class="section-number">6.2. </span>固件签名<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>通常BootLoader基本不会涉及到固件签名，那什么是固件签名呢？通常理解可以理解为银行卡签名，只要你的固件firmware的bin里面一个字节改动了，都无法获取相同的签名，意思是签名很难伪造，比如有时候有些人把固件反汇编一下，改了里面某个初始化值，那签名就要重新签，通常如果没有签名，就可以直接用了，但是如果有签名，会发现固件有改动。主要为了防止不法分子来修改firmware
生成签名就要密钥生成。</p>
</section>
<section id="id3">
<h2><span class="section-number">6.3. </span>为什么要签名固件<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<p>首先防止攻击者修改固件，或者替换为自己的固件，窥探固件中的信息，并且修改。 签名是安全中的重要组成部分，固件签名不能做什么？</p>
<ul>
<li><p>并不能防止反汇编</p></li>
<li><p>没有硬件防篡改</p></li>
<li><p>JTAG防止调试</p>
<p>这些mcuboot都是没有的。</p>
</li>
</ul>
<p>签名有公钥和私钥，应该保密，公钥可以自由分发用于验证签名</p>
</section>
<section id="ecdsa">
<h2><span class="section-number">6.4. </span>ECDSA<a class="headerlink" href="#ecdsa" title="此标题的永久链接"></a></h2>
<p>Elliptic Curve Digital Signature Algorithm</p>
<p>椭圆曲线数字签名算法</p>
<p>这个是签名算法，签名算法有很多，比如RSA、DSA、ECDSA。</p>
<p>这个算法其实在很多场景中会用到，蓝牙，加密传输等等。</p>
<p>想深入了解可以参考这篇文章</p>
<p><a class="reference external" href="https://www.instructables.com/Understanding-how-ECDSA-protects-your-data/">Understanding-how-ECDSA-protects-your-data</a></p>
<p><a class="reference external" href="https://zhuanlan.zhihu.com/p/97953640">一文读懂ECDSA算法如何保护数据</a></p>
<p>这个是mcuboot里面的用到的一种加密算法</p>
</section>
<section id="id4">
<h2><span class="section-number">6.5. </span>MCUBOOT 的使用情况<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<p>目前mcuboot支持的平台</p>
<ul class="simple">
<li><p>Zephyr</p></li>
<li><p>Mynewt</p></li>
<li><p>RIOT</p></li>
<li><p>MBED-OS</p></li>
<li><p>Simulator</p></li>
</ul>
<p>支持的开发板</p>
<ul class="simple">
<li><p>zephyr里面的nrf52840 等基本开发板都可以使用</p></li>
<li><p>cypress PSoC 6 芯片</p></li>
</ul>
<p>从目前的来看，运行的最好的硬件平台是zephyr+nRF52840-DK</p>
</section>
<section id="id5">
<h2><span class="section-number">6.6. </span>MCUBOOT依赖情况<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h2>
<p>实际上MCUBOOT并不完全依赖OS，MCUBOOT依赖以下驱动</p>
<ul class="simple">
<li><p>FLASH驱动（这个读写FLASH需要使用到）</p></li>
<li><p>UART驱动（这个主要用来调试和打log）</p></li>
<li><p>加密模块（这个用硬件软件都可以实现）</p></li>
<li><p>MCU启动APP和初始化部分（这部分依赖于平台相关的内容）</p></li>
</ul>
<p>实际上你可能会有一种感觉，mcuboot什么都没有做，实际上它解决的是安全问题。</p>
</section>
<section id="id6">
<h2><span class="section-number">6.7. </span>MCUBOOT大小<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h2>
<p>MCUBOOT大小实际上不是很大，但是有一块加密这块，如果没有对应的硬件实现的话，软件实现的medlt，代码会比较大，差不多不带mbedtls的话会&lt;64KB左右，如果用软件实现加密的话可能会大于64KB左右。这个对嵌入式里面来说的话，还是比较大的，所以有些小型的MCU例如M0之类的就不用考虑这个MCUBOOT了，直接上BootLoader了。至少你的FLASH 256KB以上。
一般MCUBOOT 设置为0x20000是保险的，一般不会超过128KB。</p>
</section>
<section id="id7">
<h2><span class="section-number">6.8. </span>MCUBOOT支持的软件加密模块<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
<p>MCUBOOT提供两种软件加密的方式</p>
<ul class="simple">
<li><p>MBEDTLS</p></li>
<li><p>TINYCRYPT</p></li>
</ul>
</section>
<section id="id8">
<h2><span class="section-number">6.9. </span>MCUBOOT 配置<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<p>带有MCUBOOT_头部的
./build/zephyr/include/generated/autoconf.h 这个文件会生成所有的zephyr的相关的配置，这些都是根据boot/Kconfig里面的配置生成的</p>
</section>
<section id="id9">
<h2><span class="section-number">6.10. </span>MCUBOOT 一些概念<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h2>
<ul class="simple">
<li><p>images 这个指固件，对于trustzone还分为安全固件和非安全固件</p></li>
<li><p>slots 每个固件都可以保存在<code class="docutils literal notranslate"><span class="pre">primary</span></code> 或者 <code class="docutils literal notranslate"><span class="pre">secondary</span></code>的slot（插槽）里面。<code class="docutils literal notranslate"><span class="pre">primary</span></code>就是执行的程序，<code class="docutils literal notranslate"><span class="pre">secondary</span></code>可以用来更新程序</p></li>
</ul>
</section>
<section id="id10">
<h2><span class="section-number">6.11. </span>MCUBOOT 更新方式<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<section id="overwrite">
<h3>覆盖模式 OVERWRITE<a class="headerlink" href="#overwrite" title="此标题的永久链接"></a></h3>
<p>这种模式无法恢复到primary之前的状态，直接将secondary直接覆盖替换</p>
<ul class="simple">
<li><p>MCUBOOT_OVERWRITE_ONLY 覆盖模式，更新的时候，通常使用的就是这个模式</p></li>
</ul>
</section>
<section id="id11">
<h3>交换模式<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h3>
<p>这种模式对源版本是一种保护，将primary的先放到SWAP区域，然后再用secondary替换primary，如果失败则从SWAP降级到源版本。这个对FLASH需求会大一些，同样对FLASH的使用次数也是成倍的上升，如果没有特别需求，可以不用这个模式。</p>
<ul class="simple">
<li><p>MCUBOOT_SWAP_USING_MOVE</p></li>
</ul>
<p>这个模式主要是会把primary先保存到SWAP区域，然后更新代码，之后如果运行不了，会再次将SWAP里面的代码更新回来。</p>
</section>
</section>
<section id="id12">
<h2><span class="section-number">6.12. </span>加密部分<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h2>
<p>MCUboot 没有实现自己的加密库。Tinycrypt和Mbed TLS有可用的默认端口，可以分别使用MCUBOOT_USE_TINYCRYPT和MCUBOOT_USE_MBED_TLS标志启用它们。</p>
<p>如果有可用的硬件加速器，也可以实现一个端口来利用它。NRF 平台加密引擎已经有一个实现，可以使用MCUBOOT_USE_CC310。</p>
<p>nordic的硬件代码实现在ext/nrf/cc310_glue.c文件中，该硬件实现了P256和ECDSA。这边加密部分我并没有去深究太深，感觉也是一块比较通用的模块。</p>
<p>该MCUBOOT_VALIDATE_PRIMARY_SLOT标志控制是否在每次启动时验证映像。默认（和推荐）设置是在每次启动时验证。如果您的映像很大或您的 MCU 时钟很慢，则硬件加密加速器可能会对您的启动时间产生显着差异。</p>
<p>对于初始移植，我建议从软件加密库之一开始，测量引导和升级时间的样子，并根据这些结果决定是否需要硬件加速器。</p>
</section>
<section id="nordic-mcuboot">
<h2><span class="section-number">6.13. </span>Nordic MCUBOOT 的使用<a class="headerlink" href="#nordic-mcuboot" title="此标题的永久链接"></a></h2>
<p>如果你手上有一块nordic 52840的开发板，恭喜你，你可以比较完整的运行mcuboot，并且在硬件上运行起来。</p>
<p>这边我可以提供3个bin文件。</p>
<p>是根据官方生成的mcuboot.bin、signed-hello1.bin、signed-hello2.bin</p>
<p>mcuboot.bin是BootLoader， 烧入地址是0x0</p>
<p>signed-hello1.bin是app1在primary中，烧入的FLASH偏移是0xc000 size是67000</p>
<p>signed-hello2.bin是app2在secondary，烧入的FLASH偏移是0x73000  size是67000</p>
<section id="bin">
<h3>BIN文件如何生成<a class="headerlink" href="#bin" title="此标题的永久链接"></a></h3>
<p>首先需要了解下<a class="reference external" href="https://docs.zephyrproject.org/latest/boards/arm/nrf52840dk_nrf52840/doc/index.html">zephyr 的nordic52840</a>如何运行，比如跑一个hello world</p>
<p>之后根据Nordic的<a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/wrapper.html">nrf_MCUBOOT官方文档</a></p>
<p>根据<a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/readme-zephyr.html">NRF_编译步骤</a> 这个可以搭建环境</p>
<p>再根据nordic的<a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/testplan-zephyr.html">test plan</a></p>
<p>可以生成mcuboot.bin、signed-hello1.bin、signed-hello2.bin</p>
<p>需要提醒的是，官方给的sample是<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test-good-rsa</span> </code></p>
<p>实际上通过实践证明，其实我们如果想要烧入hello2之后可以执行hello2的话，需要使用命令<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">test-overwrite</span></code></p>
<p>之后的烧入命令<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">flash_boot</span></code> 是烧入mcuboot</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">flash_hello1</span></code> 是烧入hello1这个烧完之后会直接运行hello1的代码。</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">flash_hello2</span></code> 这个是烧入hello2这个烧完之后reset会从hello2的代码进行运行。</p>
<p>从Makefile里面的代码可以看出来</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>flash_boot:
        $(PYOCD) flash -a 0 mcuboot.bin --target nrf52840

flash_hello1:
        $(PYOCD) flash -a 0xc000 signed-hello1.bin --target nrf52840

flash_hello2:
        $(PYOCD) flash -a 0x73000 signed-hello2.bin --target nrf52840

flash_full:
        $(PYOCD) flash -e chip -a 0 full.bin --target nrf52840
</pre></div>
</div>
</section>
<section id="id13">
<h3>BIN头部<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<p>IMAGE头部有部分版本信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">image_version</span> <span class="p">{</span>
    <span class="n">uint8_t</span> <span class="n">iv_major</span><span class="p">;</span>
    <span class="n">uint8_t</span> <span class="n">iv_minor</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">iv_revision</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">iv_build_num</span><span class="p">;</span>
<span class="p">};</span>

<span class="o">/**</span> <span class="n">Image</span> <span class="n">header</span><span class="o">.</span>  <span class="n">All</span> <span class="n">fields</span> <span class="n">are</span> <span class="ow">in</span> <span class="n">little</span> <span class="n">endian</span> <span class="n">byte</span> <span class="n">order</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">struct</span> <span class="n">image_header</span> <span class="p">{</span>
    <span class="n">uint32_t</span> <span class="n">ih_magic</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">ih_load_addr</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">ih_hdr_size</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">image</span> <span class="n">header</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">)</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint16_t</span> <span class="n">ih_protect_tlv_size</span><span class="p">;</span>   <span class="o">/*</span> <span class="n">Size</span> <span class="n">of</span> <span class="n">protected</span> <span class="n">TLV</span> <span class="n">area</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">)</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint32_t</span> <span class="n">ih_img_size</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">Does</span> <span class="ow">not</span> <span class="n">include</span> <span class="n">header</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">uint32_t</span> <span class="n">ih_flags</span><span class="p">;</span>              <span class="o">/*</span> <span class="n">IMAGE_F_</span><span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">struct</span> <span class="n">image_version</span> <span class="n">ih_ver</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">_pad1</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>image_header 仔细数下，差不多是8*4个字节（32个字节）。 差不多是0x20个字节下面我们dump出signed-hello1.bin的头部</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0000000</span> <span class="n">b83d</span> <span class="mi">96</span><span class="n">f3</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0200</span> <span class="mi">0000</span> <span class="mf">3e54</span> <span class="mi">0000</span>
<span class="mi">0000010</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0201</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span>
<span class="mi">0000020</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span> <span class="mi">0000</span>
<span class="o">*</span>
<span class="mi">0000200</span> <span class="mi">0</span><span class="n">b60</span> <span class="mi">2000</span> <span class="n">d2f9</span> <span class="mi">0000</span> <span class="n">f68d</span> <span class="mi">0000</span> <span class="n">d34d</span> <span class="mi">0000</span>
</pre></div>
</div>
<p>从中间你可以读出以下信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=</span><span class="n">ih_magic</span><span class="o">=</span><span class="mi">96</span><span class="n">f3b83d</span><span class="o">=====</span>
<span class="o">=</span><span class="n">ih_load_addr</span><span class="o">=</span><span class="mi">0</span><span class="o">=====</span>
<span class="o">=</span><span class="n">ih_hdr_size</span><span class="o">=</span><span class="mi">200</span><span class="o">=====</span>
<span class="o">=</span><span class="n">ih_protect_tlv_size</span><span class="o">=</span><span class="mi">0</span><span class="o">=====</span>
<span class="o">=</span><span class="n">ih_img_size</span><span class="o">=</span><span class="mf">3e54</span><span class="o">=====</span>
<span class="o">=</span><span class="n">ih_flags</span><span class="o">=</span><span class="mi">0</span><span class="o">=====</span>
<span class="n">Image</span> <span class="n">version</span><span class="p">:</span><span class="mf">01.02</span> <span class="p">(</span><span class="n">Rev</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Build</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="o">=</span><span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="o">=====</span>
</pre></div>
</div>
<p>这边ih_hdr_size设定了是0x200。所以前0x200都是头部。头部信息就差不多这么多。</p>
</section>
<section id="slot">
<h3>SLOT尾部<a class="headerlink" href="#slot" title="此标题的永久链接"></a></h3>
<p>SLOT其实是你插槽的最后部分，并不是image大小的最后部分，这部分的内容是固定位置的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>     <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
     <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">~</span>                                                               <span class="o">~</span>
    <span class="o">~</span>    <span class="n">Swap</span> <span class="n">status</span> <span class="p">(</span><span class="n">BOOT_MAX_IMG_SECTORS</span> <span class="o">*</span> <span class="nb">min</span><span class="o">-</span><span class="n">write</span><span class="o">-</span><span class="n">size</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>    <span class="o">~</span>
    <span class="o">~</span>                                                               <span class="o">~</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>                 <span class="n">Encryption</span> <span class="n">key</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">16</span> <span class="n">octets</span><span class="p">)</span> <span class="p">[</span><span class="o">*</span><span class="p">]</span>              <span class="o">|</span>
    <span class="o">|</span>                                                               <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>                 <span class="n">Encryption</span> <span class="n">key</span> <span class="mi">1</span> <span class="p">(</span><span class="mi">16</span> <span class="n">octets</span><span class="p">)</span> <span class="p">[</span><span class="o">*</span><span class="p">]</span>              <span class="o">|</span>
    <span class="o">|</span>                                                               <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>                      <span class="n">Swap</span> <span class="n">size</span> <span class="p">(</span><span class="mi">4</span> <span class="n">octets</span><span class="p">)</span>                     <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>   <span class="n">Swap</span> <span class="n">info</span>   <span class="o">|</span>           <span class="mh">0xff</span> <span class="n">padding</span> <span class="p">(</span><span class="mi">7</span> <span class="n">octets</span><span class="p">)</span>             <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>   <span class="n">Copy</span> <span class="n">done</span>   <span class="o">|</span>           <span class="mh">0xff</span> <span class="n">padding</span> <span class="p">(</span><span class="mi">7</span> <span class="n">octets</span><span class="p">)</span>             <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>   <span class="n">Image</span> <span class="n">OK</span>    <span class="o">|</span>           <span class="mh">0xff</span> <span class="n">padding</span> <span class="p">(</span><span class="mi">7</span> <span class="n">octets</span><span class="p">)</span>             <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
    <span class="o">|</span>                       <span class="n">MAGIC</span> <span class="p">(</span><span class="mi">16</span> <span class="n">octets</span><span class="p">)</span>                       <span class="o">|</span>
    <span class="o">|</span>                                                               <span class="o">|</span>
    <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<p>尾部有以下信息比较重要MAGIC、copy_done、swap_info、image_ok、</p>
<p>在函数<code class="docutils literal notranslate"><span class="pre">boot_read_swap_state_by_id</span></code> 中有读取这些信息的代码</p>
<p>在函数<code class="docutils literal notranslate"><span class="pre">boot_swap_type_multi</span></code>中有校验这些信息的代码</p>
<p>这里的计算SWAP_TYPE的内容尤为重要，因为这个决定你的BootLoader如何做下一步动作，之前我就是因为嫌弃hello2.bin比较大，修改了以下，导致这里计算SWAP_TYPE出了问题。 SWAP_TYPE_NONE就是什么动作都不会做。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   for (i = 0; i &lt; BOOT_SWAP_TABLES_COUNT; i++) {
        table = boot_swap_tables + i;

        if (boot_magic_compatible_check(table-&gt;magic_primary_slot,
                                        primary_slot.magic) &amp;&amp;
            boot_magic_compatible_check(table-&gt;magic_secondary_slot,
                                        secondary_slot.magic) &amp;&amp;
            (table-&gt;image_ok_primary_slot == BOOT_FLAG_ANY   ||
                table-&gt;image_ok_primary_slot == primary_slot.image_ok) &amp;&amp;
            (table-&gt;image_ok_secondary_slot == BOOT_FLAG_ANY ||
                table-&gt;image_ok_secondary_slot == secondary_slot.image_ok) &amp;&amp;
            (table-&gt;copy_done_primary_slot == BOOT_FLAG_ANY  ||
                table-&gt;copy_done_primary_slot == primary_slot.copy_done)) {
            BOOT_LOG_INF(&quot;Swap type: %s&quot;,
                         table-&gt;swap_type == BOOT_SWAP_TYPE_TEST   ? &quot;test&quot;   :
                         table-&gt;swap_type == BOOT_SWAP_TYPE_PERM   ? &quot;perm&quot;   :
                         table-&gt;swap_type == BOOT_SWAP_TYPE_REVERT ? &quot;revert&quot; :
                         &quot;BUG; can&#39;t happen&quot;);
            if (table-&gt;swap_type != BOOT_SWAP_TYPE_TEST &amp;&amp;
                    table-&gt;swap_type != BOOT_SWAP_TYPE_PERM &amp;&amp;
                    table-&gt;swap_type != BOOT_SWAP_TYPE_REVERT) {
                return BOOT_SWAP_TYPE_PANIC;
            }
            return table-&gt;swap_type;
        }
    }
</pre></div>
</div>
<p>这部分内容如果想要彻底理解的话需要查看内容</p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/design/#image-trailers">image-trailers</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">uint32_t</span> <span class="n">boot_img_magic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="mh">0xf395c277</span><span class="p">,</span>
    <span class="mh">0x7fefd260</span><span class="p">,</span>
    <span class="mh">0x0f505235</span><span class="p">,</span>
    <span class="mh">0x8079b62c</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>以下是image-hello2.bin的尾部应该从0x4054之后就是对应的一些信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0004050</span> <span class="mi">0000</span> <span class="mi">0000</span> 

<span class="mi">6907</span> <span class="mi">0150</span> 

<span class="mi">0010</span> <span class="mi">0020</span> 
<span class="mi">653</span><span class="n">e</span> <span class="mi">02</span><span class="n">df</span> <span class="mi">5</span><span class="n">f24</span> <span class="mi">8</span><span class="n">f46</span> <span class="mi">07</span><span class="n">b5</span> <span class="mi">440</span><span class="n">b</span> <span class="mf">05e6</span> <span class="n">e3b6</span> <span class="n">e434</span> <span class="n">ab01</span> <span class="mi">9</span><span class="n">d23</span> <span class="n">a56c</span> <span class="mi">168</span><span class="n">f</span> <span class="n">de43</span> <span class="mi">1421</span> <span class="mi">6</span><span class="n">a6c</span> 

<span class="mi">0001</span> <span class="mi">0020</span> 
<span class="mi">57</span><span class="n">fc</span> <span class="n">dc01</span> <span class="mi">3561</span> <span class="mf">32e1</span> <span class="mi">4738</span> <span class="n">c4bd</span> <span class="mi">040</span><span class="n">f</span> <span class="n">e5d2</span> <span class="n">e5be</span> <span class="mi">3</span><span class="n">b83</span> <span class="n">c223</span> <span class="mi">939</span><span class="n">f</span> <span class="mi">3</span><span class="n">d59</span> <span class="mi">0100</span> <span class="n">fa8c</span> <span class="mi">9499</span>

<span class="mi">0020</span> <span class="mi">0100</span> 
<span class="n">bf7e</span> <span class="mi">8362</span> <span class="n">f93e</span> <span class="n">eab7</span> <span class="mf">2e7</span><span class="n">e</span> <span class="mi">0998</span>
<span class="mi">00040</span><span class="n">b0</span> <span class="mf">1e5</span><span class="n">a</span> <span class="mf">69e2</span> <span class="n">e126</span> <span class="mi">13</span><span class="n">b9</span> <span class="mi">854</span><span class="n">e</span> <span class="n">b19e</span> <span class="n">e2bd</span> <span class="n">d6a6</span>
<span class="mi">00040</span><span class="n">c0</span> <span class="mi">4</span><span class="n">c90</span> <span class="mi">3</span><span class="n">eef</span> <span class="n">e89f</span> <span class="mi">3</span><span class="n">a62</span> <span class="mi">7337</span> <span class="mi">9</span><span class="n">cc8</span> <span class="mi">3</span><span class="n">a76</span> <span class="mf">2e4</span><span class="n">e</span>
<span class="mi">00040</span><span class="n">d0</span> <span class="n">b33d</span> <span class="mi">2962</span> <span class="n">d2c4</span> <span class="mf">5e47</span> <span class="n">d40d</span> <span class="mi">44</span><span class="n">b9</span> <span class="mi">196</span><span class="n">f</span> <span class="mi">4791</span>
<span class="mf">00040e0</span> <span class="n">e159</span> <span class="n">ff9b</span> <span class="mi">4</span><span class="n">a0b</span> <span class="n">e592</span> <span class="n">d65d</span> <span class="mi">76</span><span class="n">fa</span> <span class="n">bd8e</span> <span class="mi">1</span><span class="n">a15</span>
<span class="mi">00040</span><span class="n">f0</span> <span class="mi">1708</span> <span class="n">b271</span> <span class="n">eeea</span> <span class="n">e1de</span> <span class="mi">18</span><span class="n">f2</span> <span class="mi">0</span><span class="n">ab7</span> <span class="mi">9173</span> <span class="n">d92f</span>
<span class="mi">0004100</span> <span class="mi">9651</span> <span class="mi">3</span><span class="n">d5a</span> <span class="n">d432</span> <span class="n">eca0</span> <span class="mi">653</span><span class="n">a</span> <span class="n">cd5c</span> <span class="mi">8766</span> <span class="n">f255</span>
<span class="mi">0004110</span> <span class="n">fc1d</span> <span class="mi">87</span><span class="n">ca</span> <span class="mf">23e1</span> <span class="mi">28</span><span class="n">d2</span> <span class="mi">537</span><span class="n">a</span> <span class="n">bd61</span> <span class="n">a7bf</span> <span class="mi">7</span><span class="n">b12</span>
<span class="mi">0004120</span> <span class="n">f786</span> <span class="mi">5</span><span class="n">a7e</span> <span class="mi">3</span><span class="n">cad</span> <span class="n">e9a8</span> <span class="mi">8</span><span class="n">c36</span> <span class="n">d68a</span> <span class="n">b11c</span> <span class="mi">910</span><span class="n">a</span>
<span class="mi">0004130</span> <span class="n">cf3f</span> <span class="mi">7</span><span class="n">c96</span> <span class="mi">9</span><span class="n">ca6</span> <span class="mi">51</span><span class="n">a1</span> <span class="mf">6e2</span><span class="n">a</span> <span class="mi">7</span><span class="n">d07</span> <span class="mi">92</span><span class="n">ea</span> <span class="mi">0117</span>
<span class="mi">0004140</span> <span class="mi">7</span><span class="n">adc</span> <span class="n">d048</span> <span class="n">efab</span> <span class="mi">0</span><span class="n">d7d</span> <span class="n">b47d</span> <span class="mi">2253</span> <span class="n">be28</span> <span class="n">a662</span>
<span class="mi">0004150</span> <span class="n">d52d</span> <span class="mi">0539</span> <span class="n">eab4</span> <span class="n">b18d</span> <span class="mf">6e27</span> <span class="mi">5959</span> <span class="mf">17e7</span> <span class="mi">94</span><span class="n">c5</span>
<span class="mi">0004160</span> <span class="mi">03</span><span class="n">d5</span> <span class="mi">6</span><span class="n">b23</span> <span class="n">a0e4</span> <span class="mi">9092</span> <span class="mi">7</span><span class="n">eb5</span> <span class="mi">21</span><span class="n">c6</span> <span class="n">bf1a</span> <span class="mi">1</span><span class="n">f39</span>
<span class="mi">0004170</span> <span class="n">f627</span> <span class="mi">276</span><span class="n">d</span> <span class="mi">2927</span> <span class="mi">300</span><span class="n">b</span> <span class="n">d497</span> <span class="n">a5a2</span> <span class="n">d7aa</span> <span class="n">efca</span>
<span class="mi">0004180</span> <span class="n">a259</span> <span class="mi">1</span><span class="n">c8e</span> <span class="mi">61</span><span class="n">d1</span> <span class="n">cee5</span> <span class="mi">425</span><span class="n">e</span> <span class="n">c47c</span> <span class="mi">8</span><span class="n">a85</span> <span class="n">e0c3</span>
<span class="mi">0004190</span> <span class="mi">95</span><span class="n">f9</span> <span class="mi">76</span><span class="n">cc</span> <span class="n">b871</span> <span class="mi">2</span><span class="n">a3e</span> <span class="n">b934</span> <span class="mi">7093</span> <span class="n">b148</span> <span class="mi">7</span><span class="n">ec9</span>
<span class="mi">00041</span><span class="n">a0</span> <span class="n">e87f</span> <span class="mi">6</span><span class="n">ffa</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span>
<span class="mi">00041</span><span class="n">b0</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span> <span class="n">ffff</span>
<span class="o">*</span>
<span class="mi">0066</span><span class="n">ff0</span> <span class="n">c277</span> <span class="n">f395</span> <span class="n">d260</span> <span class="mi">7</span><span class="n">fef</span> <span class="mi">5235</span> <span class="mi">0</span><span class="n">f50</span> <span class="n">b62c</span> <span class="mi">8079</span>
<span class="mi">0067000</span>
</pre></div>
</div>
</section>
<section id="bin-tlv">
<h3>BIN 尾部tlv<a class="headerlink" href="#bin-tlv" title="此标题的永久链接"></a></h3>
<p>紧接着image之后的是一个bin tlv等信息，这个里面会有对应的加密信息，这部分位置是随着image大小而变化的。</p>
<p>这里的实现主要在函数<code class="docutils literal notranslate"><span class="pre">bootutil_img_validate</span></code> 在文件  <code class="docutils literal notranslate"><span class="pre">boot/bootutil/src/image_validate.c</span></code>里面</p>
<p>有以下信息</p>
<ol class="simple">
<li><p>image  image_tlv_info  4个字节</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">image_tlv_info</span> <span class="p">{</span>
    <span class="n">uint16_t</span> <span class="n">it_magic</span><span class="p">;</span>
    <span class="n">uint16_t</span> <span class="n">it_tlv_tot</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">size</span> <span class="n">of</span> <span class="n">TLV</span> <span class="n">area</span> <span class="p">(</span><span class="n">including</span> <span class="n">tlv_info</span> <span class="n">header</span><span class="p">)</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="n">offset</span><span class="p">:</span> <span class="mi">4054</span>

<span class="n">data</span><span class="p">:</span> <span class="mi">6907</span> <span class="mi">0150</span> 

<span class="c1">#define IMAGE_TLV_INFO_MAGIC        0x6907</span>
<span class="c1">#define IMAGE_TLV_PROT_INFO_MAGIC   0x6908</span>
</pre></div>
</div>
<ol class="simple">
<li><p>tlv 信息</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>struct image_tlv {
    uint8_t  it_type;   /* IMAGE_TLV_[...]. */
    uint8_t  _pad;
    uint16_t it_len;    /* Data length (not including TLV header). */
};
这里也是先读4个字节，然后读后面的it_len

0010 0020 IMAGE_TLV_SHA256    这个hash检查
653e 02df 5f24 8f46 07b5 440b 05e6 e3b6 e434 ab01 9d23 a56c 168f de43 1421 6a6c 

0001 0020   IMAGE_TLV_KEYHASH  这个是ky
57fc dc01 3561 32e1 4738 c4bd 040f e5d2 e5be 3b83 c223 939f 3d59 0100 fa8c 9499

0020 0100 IMAGE_TLV_RSA2048_PSS   这个是签名验证
bf7e 8362 f93e eab7 2e7e 0998。。。

/*
 * Image trailer TLV types.
 */
#define IMAGE_TLV_KEYHASH           0x01   /* hash of the public key */
#define IMAGE_TLV_SHA256            0x10   /* SHA256 of image hdr and body */
#define IMAGE_TLV_RSA2048_PSS       0x20   /* RSA2048 of hash output */
#define IMAGE_TLV_ECDSA224          0x21   /* ECDSA of hash output */
#define IMAGE_TLV_ECDSA256          0x22   /* ECDSA of hash output */
#define IMAGE_TLV_RSA3072_PSS       0x23   /* RSA3072 of hash output */
#define IMAGE_TLV_ED25519           0x24   /* ED25519 of hash output */
#define IMAGE_TLV_ENC_RSA2048       0x30   /* Key encrypted with RSA-OAEP-2048 */
#define IMAGE_TLV_ENC_KW128         0x31   /* Key encrypted with AES-KW-128 */
#define IMAGE_TLV_ENC_EC256         0x32   /* Key encrypted with ECIES-P256 */
#define IMAGE_TLV_ENC_X25519        0x33   /* Key encrypted with ECIES-X25519 */
#define IMAGE_TLV_DEPENDENCY        0x40   /* Image depends on other image */
#define IMAGE_TLV_SEC_CNT           0x50   /* security counter */
</pre></div>
</div>
</section>
<section id="imgtool-py">
<h3>imgtool.py<a class="headerlink" href="#imgtool-py" title="此标题的永久链接"></a></h3>
<p>生成通常的image之后，需要加头加尾，这个主要在这个<code class="docutils literal notranslate"><span class="pre">script\imgtool.py</span></code>中实现的。这个里面的细节就不去研究了，这个还有很多参数</p>
<p>这边就不展开了</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hello1: check
        (mkdir -p $(BUILD_DIR_HELLO1) &amp;&amp; \
                cd $(BUILD_DIR_HELLO1) &amp;&amp; \
                cmake -DFROM_WHO=hello1 \
                        -G&quot;Ninja&quot; \
                        -DBOARD=$(BOARD) \
                        $(SOURCE_DIRECTORY)/hello-world &amp;&amp; \
                ninja)
        $(IMGTOOL) sign \
                --key $(SIGNING_KEY) \
                --header-size $(BOOT_HEADER_LEN) \
                --align $(FLASH_ALIGNMENT) \
                --version 1.2 \
                --slot-size 0x67000 \
                $(BUILD_DIR_HELLO1)/zephyr/zephyr.bin \
                signed-hello1.bin
hello2: check
        (mkdir -p $(BUILD_DIR_HELLO2) &amp;&amp; \
                cd $(BUILD_DIR_HELLO2) &amp;&amp; \
                cmake -DFROM_WHO=hello2 \
                        -G&quot;Ninja&quot; \
                        -DBOARD=$(BOARD) \
                        $(SOURCE_DIRECTORY)/hello-world &amp;&amp; \
                ninja)
        $(IMGTOOL) sign \
                --key $(SIGNING_KEY) \
                --header-size $(BOOT_HEADER_LEN) \
                --align $(FLASH_ALIGNMENT) \
                --version 1.3 \
                --slot-size 0x67000 \
                --pad \
                $(BUILD_DIR_HELLO2)/zephyr/zephyr.bin \
                signed-hello2.bin

</pre></div>
</div>
<p>主要之前有个–pad这个好像是填充，之前因为感觉烧入太慢，被我去掉了，导致后面一系列的问题，但是同样解决问题也是学习的最好的方法，通过解决这个问题，基本理解mcuboot里面的运行机制。</p>
</section>
</section>
<section id="id14">
<h2><span class="section-number">6.14. </span>MCUBOOT 运行流程及注意事项<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h2>
<p>运行流程</p>
<p>在主函数里面</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">boot_go</span><span class="p">(</span><span class="n">struct</span> <span class="n">boot_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fih_int</span> <span class="n">fih_rc</span> <span class="o">=</span> <span class="n">FIH_FAILURE</span><span class="p">;</span>
    <span class="n">FIH_CALL</span><span class="p">(</span><span class="n">context_boot_go</span><span class="p">,</span> <span class="n">fih_rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">boot_data</span><span class="p">,</span> <span class="n">rsp</span><span class="p">);</span>
    <span class="n">FIH_RET</span><span class="p">(</span><span class="n">fih_rc</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>boot_go=&gt; context_boot_go</p>
<p>然后进入到<code class="docutils literal notranslate"><span class="pre">boot_prepare_image_for_update</span></code> 这个函数，这个函数比较重要</p>
<p>这个函数里面</p>
<p><code class="docutils literal notranslate"><span class="pre">boot_read_image_headers</span></code>   这个是读出头部信息</p>
<p>接下来</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1632</span>             <span class="k">if</span> <span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">swap_type</span> <span class="o">==</span> <span class="n">BOOT_SWAP_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
<span class="mi">1634</span>                 <span class="n">BOOT_SWAP_TYPE</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">=</span> <span class="n">boot_validated_swap_type</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">bs</span><span class="p">);</span>
<span class="mi">1635</span>             <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</pre></div>
</div>
<p>这里会去读取SLOT尾部信息，判断是否需要更新然后计算出SWAP_TYPE</p>
<p>接下来</p>
<p>boot_validate_slot这个是验证image的有效性的。</p>
<p>之后就开始更新代码</p>
<p>回到context_boot_go</p>
<p>进行更新替换。</p>
<p>在secondary烧入到primary之后，还需要注意mcuboot会擦除掉一些信息，让下次不会再去校验头部和尾部。</p>
<p>erase fa_id=2,fa_off=73000 off=0, len=1000
erase fa_id=2,fa_off=73000 off=66000, len=1000
烧完secondary之后，会擦除头部和尾部。</p>
</section>
<section id="swap">
<h2><span class="section-number">6.15. </span>SWAP类型<a class="headerlink" href="#swap" title="此标题的永久链接"></a></h2>
<p>SWAP类型决定了是否启动的关键</p>
<p>BOOT_SWAP_TYPE_NONE：“通常”或“不升级”的情况；尝试引导主插槽的内容。</p>
<p>BOOT_SWAP_TYPE_TEST：通过交换映像来引导辅助插槽的内容。除非交换是永久性的，否则在下次启动时恢复。</p>
<p>BOOT_SWAP_TYPE_PERM：永久交换镜像，并启动升级后的镜像固件。</p>
<p>BOOT_SWAP_TYPE_REVERT：之前的测试交换不是永久性的；交换回旧image，其数据现在位于辅助插槽中。如果旧映像在启动时将自身标记为“OK”，则下次启动将具有交换类型BOOT_SWAP_TYPE_NONE。</p>
<p>BOOT_SWAP_TYPE_FAIL: 交换失败，因为要运行的图像无效。</p>
<p>BOOT_SWAP_TYPE_PANIC: 交换遇到不可恢复的错误。</p>
</section>
<section id="id15">
<h2><span class="section-number">6.16. </span>参考文档<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h2>
<p><a class="reference external" href="https://interrupt.memfault.com/blog/mcuboot-overview?query=from%20zero%20to%20main">MCUboot Walkthrough and Porting Guide</a></p>
<p><a class="reference external" href="https://mcuboot.com">MCUBOOT官方主页</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/">MCUBOOT官方文档</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/design/">MCUBOOT 官方设计文档</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/encrypted-images/">加密相关</a></p>
<p><a class="reference external" href="https://www.mcuboot.com/documentation/imgtool/">imgtool工具命令使用</a></p>
<p>签名设计文档：</p>
<p>https://www.mcuboot.com/documentation/ecdsa/               EC256 签名</p>
<p>https://www.mcuboot.com/documentation/signed-images/</p>
<p><a class="reference external" href="https://github.com/mcu-tools/mcuboot">MCUBOOTgithub主分支</a></p>
<p><a class="reference external" href="https://github.com/nrfconnect/sdk-mcuboot.git">nrf-connect MCUBOOT相关文档</a></p>
<p><a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/wrapper.html">Nordic MCUBOOT的参考文档</a></p>
<p>ZEPHYR操作系统：</p>
<p>https://github.com/zephyrproject-rtos/zephyr</p>
<p><a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/testplan-zephyr.html">zephyr mcuboot nrf52840 测试计划</a></p>
<p><a class="reference external" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/mcuboot/readme-zephyr.html">编译mcuboot nrf52840</a></p>
<p><a class="reference external" href="https://blog.csdn.net/iotisan/article/details/80167804">zephyr笔记 5.3.1 Zephyr 版本 MCUboot 的编译和使用</a></p>
<p><a class="reference external" href="https://blog.csdn.net/u010018991/article/details/79483899">Zephyr应用笔记：mcuboot引导程序简单介绍</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../06_embeded_debug/jlink.html" class="btn btn-neutral float-left" title="5. 嵌入式调试" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../08_MPU/01_MPU.html" class="btn btn-neutral float-right" title="7. ARM-MPU 详解" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>