<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. ble_app_blinky 介绍 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="5. ble_app_uart 介绍" href="../05/ble_uart_app.html" />
    <link rel="prev" title="3. Nordic FAQ" href="../FAQ/01_introduce.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Nordic 篇</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01/01_introduce.html">1. Nordic 相关资料</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/02_task.html">2. Nordic 相关task</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FAQ/01_introduce.html">3. Nordic FAQ</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. ble_app_blinky 介绍</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">4.1. 简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">4.2. 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">4.3. 软硬件平台</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">4.4. 试验</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">4.4.1. 试验板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">4.4.2. 程序配置设置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">4.4.3. 配置编译</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">4.4.4. 编译下载程序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">4.4.5. 手机连接验证</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">4.5. 软件结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">4.6. 程序</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id12">4.6.1. 创建ble_app_blinky任务</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">4.6.2. 任务里的初始化工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#led">4.6.3. led和按钮初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">4.6.4. 协议栈初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">4.6.5. 通用访问协议参数初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">4.6.6. 通用属性规范初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">4.6.7. led和按钮的服务初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">4.6.8. 广播初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">4.6.9. 连接参数初始化</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">4.6.10. 开启广播</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">4.6.11. led切换操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">4.6.12. 按钮状态通知操作</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05/ble_uart_app.html">5. ble_app_uart 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_nordic_i2c/nRF5x_I2C.html">6. nRF5x_BSP I2C 移植指南</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Nordic 篇</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>ble_app_blinky 介绍</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/nordic/03/ble_app_blinky.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ble-app-blinky">
<h1><span class="section-number">4. </span>ble_app_blinky 介绍<a class="headerlink" href="#ble-app-blinky" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2><span class="section-number">4.1. </span>简介<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p>​		此ble_app_blinky是nordic nrf5x系列芯片的蓝牙从设备（Slave）应用程序。基于Nordic nRF5_SDK_16 的软件包移植而成。</p>
<p>​		支持RT-Thread实时嵌入式系统。作为RT-Thread软件包nrf5x_sdk的例程，可通过RT-Thread 开发辅助工具Env直接配置到RT-Thread系统工程中。</p>
<p>​		nrf5x_sdk软件包网址：https://github.com/supperthomas/nrf5x_sdk</p>
</section>
<section id="id2">
<h2><span class="section-number">4.2. </span>功能<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>​		ble_app_blinky应用程序实现了通过蓝牙主设备（Master）控制从设备（Slave）的led灯闪烁，并且能监测按钮的按压、抬起状态。</p>
<p>​		功能集成到一个服务中，服务包括LED和Button两个特性。LED特性支持读、写，Button特性支持读、通知。</p>
</section>
<section id="id3">
<h2><span class="section-number">4.3. </span>软硬件平台<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<p>​		硬件平台是nordic的nrf5x系列开发板。</p>
<p>​		软件平台是nrf5x系列芯片的RT-Thread嵌入式系统工程，工程需要包含nrfx和nrf5x_sdk两个软件包，Nordic ble协议栈s140，片上外设配置包含UART和GPIO。</p>
</section>
<section id="id4">
<h2><span class="section-number">4.4. </span>试验<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<section id="id5">
<h3><span class="section-number">4.4.1. </span>试验板<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>​		以nrf52840开发板试验。如下图：</p>
<p><img alt="../../_images/202010111833411.jpg" src="../../_images/202010111833411.jpg" /></p>
</section>
<section id="id6">
<h3><span class="section-number">4.4.2. </span>程序配置设置<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<ul>
<li><p>下载RT-Thread的nrf52840 BSP工程模板，下载地址是 https://github.com/RT-Thread/rt-thread</p></li>
<li><p>下载并安装RT-Thread 开发辅助工具Env。参考RTT安装介绍，下载地址 https://www.rt-thread.org/page/download.html</p></li>
<li><p>进入nrf52840工程文件夹</p>
<p>\rt-thread\bsp\nrf5x\nrf52840</p>
<p><img alt="../../_images/16024140080061.png" src="../../_images/16024140080061.png" /></p>
</li>
<li><p>打开env配置工具</p>
<p>在工程中右击选择ConEmu Here</p>
<p><img alt="1602414635016" src="../../_images/16024146350161.png" /></p>
</li>
<li><p>然后弹出如下界面</p>
<p><img alt="1602414731322" src="../../_images/16024147313221.png" /></p>
</li>
<li><p>输入menuconfig弹出如下界面</p>
<p><img alt="1602414840083" src="../../_images/16024148400831.png" /></p>
</li>
<li><p>使用方向键选择配置UART和GPIO</p>
<p><img alt="1602415188693" src="../../_images/16024151886931.png" /></p>
</li>
</ul>
<p><img alt="1602415356435" src="../../_images/16024153564351.png" /></p>
<p><img alt="1602416377390" src="../../_images/16024163773901.png" /></p>
<p>在Enable UART中可以选择UART0或者UART1，可以配置rx和tx的引脚编号。此开发板选择默认。</p>
<p><img alt="1602415971201" src="../../_images/16024159712011.png" /></p>
<ul>
<li><p>配置ble协议栈</p>
<p><img alt="1602416110142" src="../../_images/16024161101421.png" /></p>
</li>
</ul>
<p><img alt="1602416513402" src="../../_images/16024165134021.png" /></p>
<ul>
<li><p>配置nrfx和nrf5x_sdk软件包</p>
<p><img alt="1602416646372" src="../../_images/16024166463721.png" /></p>
</li>
</ul>
<p><img alt="1602416691268" src="../../_images/16024166912681.png" /></p>
<p><img alt="1602416784531" src="../../_images/16024167845311.png" /></p>
<p>在nrf5x_sdk中选择ble_app_blinky应用例程</p>
<p><img alt="1602417315424" src="../../_images/16024173154241.png" /></p>
<p>ble_app_blinky例程中可以配置应用使用的引脚编号（要与开发板对应），此开发板选择默认值。引脚编号是rtt驱动层drv_gpio.c对nrf5x芯片定义的引脚编号。从1-47依次对应gpio端口0的32个引脚和gpio端口1的16个引脚。</p>
</section>
<section id="id7">
<h3><span class="section-number">4.4.3. </span>配置编译<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>按Esc退到该界面</p>
<p><img alt="1602416971612" src="../../_images/16024169716121.png" /></p>
<p>选择yes保存，出现如下界面</p>
<p><img alt="1602417099315" src="../../_images/16024170993151.png" /></p>
<p>输入scons –target=mdk5回车编译工程，因为使用mdk5开发环境，也可以根据具体环境选择mdk4或者iar等。</p>
<p>编译需要一段时间，完成后退出env工具。</p>
</section>
<section id="id8">
<h3><span class="section-number">4.4.4. </span>编译下载程序<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h3>
<p>打开项目中的工程文件</p>
<p><img alt="../../_images/16025132524741.png" src="../../_images/16025132524741.png" /></p>
<p>编译工程</p>
<p><img alt="../../_images/16025136200181.png" src="../../_images/16025136200181.png" /></p>
<p>连接开发板，选择softdevice，下载程序</p>
<p><img alt="../../_images/16025137474161.png" src="../../_images/16025137474161.png" /></p>
<p>选择rtthread，下载程序</p>
<p><img alt="../../_images/16025138519801.png" src="../../_images/16025138519801.png" /></p>
<p>打开串口调试助手，首次启动运行出现如下信息</p>
<p><img alt="1602514582172" src="../../_images/16025145821721.png" /></p>
<p>输入help，按压回车，出现如下信息</p>
<p><img alt="1602514666270" src="../../_images/16025146662701.png" /></p>
<p>输入ble_app_blinky，启动ble_app_blinky应用例程。开发板的广播指示灯亮。</p>
<p><img alt="1602514860424" src="../../_images/16025148604241.png" /></p>
</section>
<section id="id9">
<h3><span class="section-number">4.4.5. </span>手机连接验证<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<p>手机端下载nRF Connect工具。下载地址是</p>
<p>https://www.nordicsemi.com/Software-and-tools/Development-Tools/nRF-Connect-for-mobile</p>
<p><img alt="1602515417544" src="../../_images/16025154175441.png" /></p>
<p>打开手机蓝牙功能，打开该app，搜索到Nordic_Blinky。</p>
<p><img alt="1602515696197" src="../../_images/16025156961971.png" /></p>
<p>点击CONNECT，连接并打开按钮和LED服务</p>
<p><img alt="1602516049884" src="../../_images/16025160498841.png" /></p>
<p>按照下面操作，可蓝牙无线控制开发板。</p>
<p><img alt="1602516464739" src="../../_images/16025164647391.png" /></p>
</section>
</section>
<section id="id10">
<h2><span class="section-number">4.5. </span>软件结构<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p><img alt="1602603891075" src="../../_images/1602603891075.png" /></p>
</section>
<section id="id11">
<h2><span class="section-number">4.6. </span>程序<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h2>
<p>程序调用接口主要有：</p>
<p>协议栈softdevice s140的通用接口函数，在nrf5x_sdk包softdevice的文件夹下。</p>
<p>rt-thread与nrf5x_sdk适配接口函数，在nrf5x_sdk包rtt_adapter文件夹下。</p>
<p>nrf5x_sdk包含的ble服务组件层针对led和按钮的接口函数，在ble_lbs.c和ble_lbs.h里面。ble_lbs.c和ble_lbs.h是在协议栈softdevice s140的API接口之上封装的模块工具，可用于为包含有led和按钮服务的app提供添加服务，添加特性，注册事件句柄。</p>
<p>rt-thread的pin组件接口函数，配置nrf5x芯片的gpio口。</p>
<section id="id12">
<h3><span class="section-number">4.6.1. </span>创建ble_app_blinky任务<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">ble_app_blinky</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">static</span><span class="w"> </span><span class="n">rt_thread_t</span><span class="w"> </span><span class="n">tid1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RT_NULL</span><span class="p">;</span><span class="w"></span>

<span class="w">   	</span><span class="n">tid1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_thread_create</span><span class="p">(</span><span class="s">&quot;softdevice&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">ble_app_softdevice</span><span class="p">,</span><span class="w"> </span><span class="n">RT_NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mi">4096</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"></span>
<span class="w">   	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tid1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RT_NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_thread_startup</span><span class="p">(</span><span class="n">tid1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">RT_EOK</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id13">
<h3><span class="section-number">4.6.2. </span>任务里的初始化工作<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ble_app_softdevice</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">leds_init</span><span class="p">();</span><span class="w">			</span><span class="c1">//led初始化</span>
<span class="w">    </span><span class="n">buttons_init</span><span class="p">();</span><span class="w">			</span><span class="c1">//按钮初始化</span>
<span class="w">    </span><span class="n">ble_stack_init</span><span class="p">();</span><span class="w">		</span><span class="c1">//蓝牙协议栈初始化</span>
<span class="w">    </span><span class="n">gap_params_init</span><span class="p">();</span><span class="w">		</span><span class="c1">//通用访问协议初始化</span>
<span class="w">    </span><span class="n">gatt_init</span><span class="p">();</span><span class="w">			</span><span class="c1">//通用属性规范初始化</span>
<span class="w">    </span><span class="n">services_init</span><span class="p">();</span><span class="w">		</span><span class="c1">//服务初始化</span>
<span class="w">    </span><span class="n">advertising_init</span><span class="p">();</span><span class="w"> 	</span><span class="c1">//广播初始化</span>
<span class="w">    </span><span class="n">conn_params_init</span><span class="p">();</span><span class="w"> 	</span><span class="c1">//连接参数初始化</span>
<span class="w">    </span><span class="n">rt_kprintf</span><span class="p">(</span><span class="s">&quot;Blinky example started.</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">advertising_start</span><span class="p">();</span><span class="w">	</span><span class="c1">//开启广播</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="led">
<h3><span class="section-number">4.6.3. </span>led和按钮初始化<a class="headerlink" href="#led" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">leds_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_mode</span><span class="p">(</span><span class="n">ADVERTISING_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_MODE_OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_mode</span><span class="p">(</span><span class="n">CONNECTED_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_MODE_OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_mode</span><span class="p">(</span><span class="n">LEDBUTTON_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_MODE_OUTPUT</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*led off*/</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">ADVERTISING_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">CONNECTED_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">LEDBUTTON_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">buttons_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_err_t</span><span class="w"> </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="cm">/*illustrate last parameter.</span>
<span class="cm">    true: hi_accuracy(IN_EVENT),</span>
<span class="cm">    false: lo_accuracy(PORT_EVENT)</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">rt_pin_attach_irq</span><span class="p">(</span><span class="n">LEDBUTTON_BUTTON</span><span class="p">,</span><span class="w"> 		       									</span><span class="n">PIN_IRQ_MODE_RISING_FALLING</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">button_event_handler</span><span class="p">,</span><span class="w"> </span><span class="c1">//按钮状态处理的回调函数</span>
<span class="w">                                 </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="nb">false</span><span class="p">);</span><span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>其中接口函数是rt-thread的pin组件层gpio操作接口函数。</p>
<p>按钮引脚配置为端口触发事件，注册了中断回调函数button_event_handler。</p>
</section>
<section id="id14">
<h3><span class="section-number">4.6.4. </span>协议栈初始化<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ble_stack_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w"> </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ram_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_sdh_enable_request</span><span class="p">();</span><span class="c1">//向所有监视器请求启用ble协议栈</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Configure the BLE stack using the default settings.</span>
<span class="w">    </span><span class="c1">// Fetch the start address of the application RAM.</span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_sdh_ble_default_cfg_set</span><span class="p">(</span><span class="n">APP_BLE_CONN_CFG_TAG</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ram_start</span><span class="p">);</span><span class="c1">//用默认参数配置ble协议栈</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Enable BLE stack.</span>
<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_sdh_ble_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ram_start</span><span class="p">);</span><span class="c1">//使能ble协议栈</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Register a handler for BLE events.</span>
<span class="w">    </span><span class="n">NRF_SDH_BLE_OBSERVER</span><span class="p">(</span><span class="n">m_ble_observer</span><span class="p">,</span><span class="w"> </span><span class="n">APP_BLE_OBSERVER_PRIO</span><span class="p">,</span><span class="w"> </span><span class="n">ble_evt_handler</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="c1">//注册ble连接相关状态处理事件的句柄</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>协议栈在使用前必须征得所有监视器确认，然后使用默认参数配置协议栈并启动协议栈。最后注册一个监视连接状态的处理句柄。</p>
</section>
<section id="id15">
<h3><span class="section-number">4.6.5. </span>通用访问协议参数初始化<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">gap_params_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w">              </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_gap_conn_params_t</span><span class="w">   </span><span class="n">gap_conn_params</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_gap_conn_sec_mode_t</span><span class="w"> </span><span class="n">sec_mode</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">BLE_GAP_CONN_SEC_MODE_SET_OPEN</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec_mode</span><span class="p">);</span><span class="c1">//设置该设备为开发连接</span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_gap_device_name_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec_mode</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="p">(</span><span class="n">constuint8_t</span><span class="o">*</span><span class="p">)</span><span class="n">DEVICE_NAME</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">strlen</span><span class="p">(</span><span class="n">DEVICE_NAME</span><span class="p">));</span><span class="w"></span>
<span class="w">    									</span><span class="c1">//设置gap设备名，即蓝牙搜索名</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gap_conn_params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">gap_conn_params</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">gap_conn_params</span><span class="p">.</span><span class="n">min_conn_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIN_CONN_INTERVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gap_conn_params</span><span class="p">.</span><span class="n">max_conn_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_CONN_INTERVAL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gap_conn_params</span><span class="p">.</span><span class="n">slave_latency</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">SLAVE_LATENCY</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gap_conn_params</span><span class="p">.</span><span class="n">conn_sup_timeout</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">CONN_SUP_TIMEOUT</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_gap_ppcp_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gap_conn_params</span><span class="p">);</span><span class="c1">//设置gap的连接参数</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>设置内容包括，安全属性为开放连接，设备搜索名称，最大最小连接间隔，延时的连接事件数（即累计多少个连接事件后再处理），未连接溢出时间（即超出该时间未进行一次连接就溢出）。</p>
</section>
<section id="id16">
<h3><span class="section-number">4.6.6. </span>通用属性规范初始化<a class="headerlink" href="#id16" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">gatt_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w"> </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_ble_gatt_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_gatt</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>再nrf_ble_gatt_init中初始化内容主要是中心设备和外围设备的GATT层一包最大传输字节数，GAP层一包最大传输字节数。</p>
</section>
<section id="id17">
<h3><span class="section-number">4.6.7. </span>led和按钮的服务初始化<a class="headerlink" href="#id17" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">services_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w">         </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_lbs_init_t</span><span class="w">     </span><span class="n">init</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">nrf_ble_qwr_init_t</span><span class="w"> </span><span class="n">qwr_init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Initialize Queued Write Module.</span>
<span class="w">    </span><span class="n">qwr_init</span><span class="p">.</span><span class="n">error_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_qwr_error_handler</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrf_ble_qwr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_qwr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">qwr_init</span><span class="p">);</span><span class="c1">//写队列初始化</span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Initialize LBS.</span>
<span class="w">    </span><span class="n">init</span><span class="p">.</span><span class="n">led_write_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">led_write_handler</span><span class="p">;</span><span class="c1">//led切换操作句柄</span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ble_lbs_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_lbs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">init</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">uint32_t</span><span class="w"> </span><span class="nf">ble_lbs_init</span><span class="p">(</span><span class="n">ble_lbs_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_lbs</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">ble_lbs_init_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_lbs_init</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w">              </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_uuid_t</span><span class="w">            </span><span class="n">ble_uuid</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_add_char_params_t</span><span class="w"> </span><span class="n">add_char_params</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Initialize service structure.</span>
<span class="w">    </span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">led_write_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_lbs_init</span><span class="o">-&gt;</span><span class="n">led_write_handler</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add service.</span>
<span class="w">    </span><span class="n">ble_uuid128_t</span><span class="w"> </span><span class="n">base_uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">LBS_UUID_BASE</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_uuid_vs_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_uuid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">uuid_type</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">VERIFY_SUCCESS</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ble_uuid</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">uuid_type</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_uuid</span><span class="p">.</span><span class="n">uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LBS_UUID_SERVICE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_gatts_service_add</span><span class="p">(</span><span class="n">BLE_GATTS_SRVC_TYPE_PRIMARY</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ble_uuid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">service_handle</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">VERIFY_SUCCESS</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add Button characteristic.</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_char_params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">add_char_params</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">uuid</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">LBS_UUID_BUTTON_CHAR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">uuid_type</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">uuid_type</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">init_len</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">max_len</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">char_props</span><span class="p">.</span><span class="n">read</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">char_props</span><span class="p">.</span><span class="n">notify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">read_access</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">SEC_OPEN</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">cccd_write_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SEC_OPEN</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">characteristic_add</span><span class="p">(</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">service_handle</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="o">&amp;</span><span class="n">add_char_params</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="o">&amp;</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">button_char_handles</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NRF_SUCCESS</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add LED characteristic.</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">add_char_params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">add_char_params</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">uuid</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">LBS_UUID_LED_CHAR</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">uuid_type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">uuid_type</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">init_len</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">max_len</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">char_props</span><span class="p">.</span><span class="n">read</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">char_props</span><span class="p">.</span><span class="n">write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">read_access</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">SEC_OPEN</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">add_char_params</span><span class="p">.</span><span class="n">write_access</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SEC_OPEN</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">characteristic_add</span><span class="p">(</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">service_handle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">add_char_params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p_lbs</span><span class="o">-&gt;</span><span class="n">led_char_handles</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>ble_lbs_init为添加led和按钮的服务，设置服务UUID，把led和按钮服务添加到服务属性表。服务里添加led特性和按钮特性。设置特性的读，写，通知等参数内容。</p>
</section>
<section id="id18">
<h3><span class="section-number">4.6.8. </span>广播初始化<a class="headerlink" href="#id18" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">advertising_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w">    </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_advdata_t</span><span class="w"> </span><span class="n">advdata</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_advdata_t</span><span class="w"> </span><span class="n">srdata</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">ble_uuid_t</span><span class="w"> </span><span class="n">adv_uuids</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="n">LBS_UUID_SERVICE</span><span class="p">,</span><span class="w"> </span><span class="n">m_lbs</span><span class="p">.</span><span class="n">uuid_type</span><span class="p">}};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Build and set advertising data.</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">advdata</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">advdata</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">advdata</span><span class="p">.</span><span class="n">name_type</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_ADVDATA_FULL_NAME</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">advdata</span><span class="p">.</span><span class="n">include_appearance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">advdata</span><span class="p">.</span><span class="n">flags</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_GAP_ADV_FLAGS_LE_ONLY_GENERAL_DISC_MODE</span><span class="p">;</span><span class="w"></span>


<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srdata</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">srdata</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">srdata</span><span class="p">.</span><span class="n">uuids_complete</span><span class="p">.</span><span class="n">uuid_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">adv_uuids</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">adv_uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="n">srdata</span><span class="p">.</span><span class="n">uuids_complete</span><span class="p">.</span><span class="n">p_uuids</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">adv_uuids</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ble_advdata_encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">advdata</span><span class="p">,</span><span class="w"> </span><span class="n">m_adv_data</span><span class="p">.</span><span class="n">adv_data</span><span class="p">.</span><span class="n">p_data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_adv_data</span><span class="p">.</span><span class="n">adv_data</span><span class="p">.</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ble_advdata_encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">srdata</span><span class="p">,</span><span class="w"> </span><span class="n">m_adv_data</span><span class="p">.</span><span class="n">scan_rsp_data</span><span class="p">.</span><span class="n">p_data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_adv_data</span><span class="p">.</span><span class="n">scan_rsp_data</span><span class="p">.</span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">ble_gap_adv_params_t</span><span class="w"> </span><span class="n">adv_params</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Set advertising parameters.</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adv_params</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">adv_params</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">primary_phy</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_GAP_PHY_1MBPS</span><span class="p">;</span><span class="c1">//1 Mbps PHY主信道</span>
<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">duration</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">APP_ADV_DURATION</span><span class="p">;</span><span class="c1">//广播溢出时间为无线大</span>
<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">properties</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_GAP_ADV_TYPE_CONNECTABLE_SCANNABLE_UNDIRECTED</span><span class="p">;</span><span class="c1">//无处理的可连接和可扫描</span>
<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">p_peer_addr</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">filter_policy</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_GAP_ADV_FP_ANY</span><span class="p">;</span><span class="c1">//允许任意设备扫描和连接</span>
<span class="w">    </span><span class="n">adv_params</span><span class="p">.</span><span class="n">interval</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">APP_ADV_INTERVAL</span><span class="p">;</span><span class="c1">//广播时间间隔</span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_gap_adv_set_configure</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_adv_handle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_adv_data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">adv_params</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id19">
<h3><span class="section-number">4.6.9. </span>连接参数初始化<a class="headerlink" href="#id19" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">conn_params_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w">             </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_conn_params_init_t</span><span class="w"> </span><span class="n">cp_init</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_init</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cp_init</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">p_conn_params</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">first_conn_params_update_delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20000</span><span class="p">;</span><span class="c1">//FIRST_CONN_PARAMS_UPDATE_DELAY;//第一次更新连接参数的延时时间</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">next_conn_params_update_delay</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="c1">//NEXT_CONN_PARAMS_UPDATE_DELAY;//除第一次外的更新连接参数的延时时间</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">max_conn_params_update_count</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_CONN_PARAMS_UPDATE_COUNT</span><span class="p">;</span><span class="c1">//放弃连接前的尝试连接次数</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">start_on_notify_cccd_handle</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">BLE_GATT_HANDLE_INVALID</span><span class="p">;</span><span class="c1">//在启动连接时候开启cccd</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">disconnect_on_fail</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="c1">//更新连接参数失败后不断开连接</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">evt_handler</span><span class="w">                    </span><span class="o">=</span><span class="w"> </span><span class="n">on_conn_params_evt</span><span class="p">;</span><span class="c1">//接收连接参数的句柄</span>
<span class="w">    </span><span class="n">cp_init</span><span class="p">.</span><span class="n">error_handler</span><span class="w">                  </span><span class="o">=</span><span class="w"> </span><span class="n">conn_params_error_handler</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ble_conn_params_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_init</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id20">
<h3><span class="section-number">4.6.10. </span>开启广播<a class="headerlink" href="#id20" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">advertising_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w"> </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sd_ble_gap_adv_start</span><span class="p">(</span><span class="n">m_adv_handle</span><span class="p">,</span><span class="w"> </span><span class="n">APP_BLE_CONN_CFG_TAG</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">//LED on</span>
<span class="w">    </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">ADVERTISING_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_LOW</span><span class="p">);</span><span class="c1">//广播指示灯亮</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id21">
<h3><span class="section-number">4.6.11. </span>led切换操作<a class="headerlink" href="#id21" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">led_write_handler</span><span class="p">(</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">conn_handle</span><span class="p">,</span><span class="w"> </span><span class="n">ble_lbs_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p_lbs</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">led_state</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">led_state</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">LEDBUTTON_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_LOW</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">NRF_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Received LED ON!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_pin_write</span><span class="p">(</span><span class="n">LEDBUTTON_LED</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_HIGH</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">NRF_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Received LED OFF!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在服务初始化的时候注册的操作句柄，接收到主设备的led控制后在此处切换led亮灭。</p>
</section>
<section id="id22">
<h3><span class="section-number">4.6.12. </span>按钮状态通知操作<a class="headerlink" href="#id22" title="此标题的永久链接"></a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">button_event_handler</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">pin_no</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_action</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ret_code_t</span><span class="w"> </span><span class="n">err_code</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button_status</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="n">button_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt_pin_read</span><span class="p">(</span><span class="n">LEDBUTTON_BUTTON</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="n">NRF_LOG_INFO</span><span class="p">(</span><span class="s">&quot;Send button state change.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">err_code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ble_lbs_on_button_change</span><span class="p">(</span><span class="n">m_conn_handle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_lbs</span><span class="p">,</span><span class="w"> 											</span><span class="n">button_status</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NRF_SUCCESS</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">err_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BLE_ERROR_INVALID_CONN_HANDLE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">err_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NRF_ERROR_INVALID_STATE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"></span>
<span class="w">                </span><span class="n">err_code</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BLE_ERROR_GATTS_SYS_ATTR_MISSING</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">APP_ERROR_CHECK</span><span class="p">(</span><span class="n">err_code</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>按钮状态变化时调用，其中读取了引脚的电平状态，利用接口函数ble_lbs_on_button_change通知主设备改变按钮特性值。注意，按钮pressed值应为1，released应为0，所以引脚的电平状态应该取反处理。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../FAQ/01_introduce.html" class="btn btn-neutral float-left" title="3. Nordic FAQ" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../05/ble_uart_app.html" class="btn btn-neutral float-right" title="5. ble_app_uart 介绍" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>