<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3. 程序员的自我修养 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="4. nRF52832 RT-Thread dmodule适配" href="nrf52832_rtthread_dlmodule.html" />
    <link rel="prev" title="2. POSIX 介绍" href="02_posix_dfs/rt_thread_posix_dfs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">NORDIC:chenyingchun0312</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_posix_dfs/rt_thread_posix_dfs.html">2. POSIX 介绍</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. 程序员的自我修养</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">3.1. 第二章节 静态链接</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">预编译</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">编译</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">汇编</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">链接</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">模块拼装</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">3.2. 第三章节 目标文件里有什么</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#elf">为什么要学习elf的格式?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">什么叫目标文件？</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">什么叫做可执行文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">可执行文件的存储格式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">ELF文件存储格式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">ELF文件结构描述</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">链接的接口-符号</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id24">调试信息</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id25">3.3. </a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="nrf52832_rtthread_dlmodule.html">4. nRF52832 RT-Thread dmodule适配</a></li>
<li class="toctree-l2"><a class="reference internal" href="stm32l496.html">5. STM32L496 USB CDC适配</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb.html">6. USB</a></li>
<li class="toctree-l2"><a class="reference internal" href="i2s.html">7. I2S总线介绍</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">NORDIC:chenyingchun0312</a></li>
      <li class="breadcrumb-item active"><span class="section-number">3. </span>程序员的自我修养</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/06_chenyingchun0312/elf_introduce.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1><span class="section-number">3. </span>程序员的自我修养<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<section id="id2">
<h2><span class="section-number">3.1. </span>第二章节 静态链接<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>这个章节相对简单，我们简单说明下</p>
<p>在linux下，当我们使用gcc来编译hello world程序时，值需要简单的使用命令gcc hello.c ，就会生成一个可执行的文件a.out。</p>
<p>事实上上面的步骤有4个，分别是预处理，编译，汇编和链接</p>
<p><img alt="image-20210424145410780" src="../_images/image-20210424145410780.png" /></p>
<section id="id3">
<h3>预编译<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h3>
<p>对源文件预编译，会生成一个.i文件</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt2$ gcc -E hello.c -o hello.i
cyc@ubuntu:~/workspace/chapt2$ ls
a.out  hello.c  hello.i
</pre></div>
</div>
<p><img alt="image-20210424150236734" src="../_images/image-20210424150236734.png" /></p>
</section>
<section id="id4">
<h3>编译<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h3>
<p>编译就是将.c文件编译成汇编文件，生成hello .s文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcc</span> <span class="o">-</span><span class="n">S</span> <span class="n">hello</span><span class="o">.</span><span class="n">i</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">s</span>
<span class="n">或者</span>
<span class="n">gcc</span> <span class="o">-</span><span class="n">S</span> <span class="n">hello</span><span class="o">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span><span class="o">.</span><span class="n">s</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>汇编<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>执行下面3条中的任意一条都可以，生成目标二进制文件hello.o</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt2$ gcc -c hello.s -o hello.o
cyc@ubuntu:~/workspace/chapt2$ gcc -c hello.c -o hello.o
cyc@ubuntu:~/workspace/chapt2$ as hello.s -o hello.o
</pre></div>
</div>
</section>
<section id="id6">
<h3>链接<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h3>
<p><img alt="image-20210424151809380" src="../_images/image-20210424151809380.png" /></p>
<p>简单说明下各个参数的含义，-L+链接库路径，-l+链接库名称，链接又分为动态链接和静态链接，-l后面链接库的名字是省略了lib和链接库的后缀后的名称，比如-lgcc其实链接的是libgcc.a</p>
</section>
<section id="id7">
<h3>模块拼装<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h3>
<p>按照一定的规则将各个.o文件，链接在一个可执行文件</p>
</section>
</section>
<section id="id8">
<h2><span class="section-number">3.2. </span>第三章节 目标文件里有什么<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h2>
<section id="elf">
<h3>为什么要学习elf的格式?<a class="headerlink" href="#elf" title="此标题的永久链接"></a></h3>
<p>我感觉，可能是为了更好的理解编译原理，理解编译底层的一些东西，了解编译后的一个可执行文件中，会包含哪些东西</p>
</section>
<section id="id9">
<h3>什么叫目标文件？<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<p>目标文件，就是源代码经过编译，但是未经过链接的文件，比如linux中的.o文件，windows中的.obj文件，都属于目标文件</p>
</section>
<section id="id10">
<h3>什么叫做可执行文件<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h3>
<p>可执行文件，就是在目标平台上，可以执行的文件，比如linux中的elf文件，windows中的exe文件</p>
</section>
<section id="id11">
<h3>可执行文件的存储格式<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h3>
<p>windows下，可执行文件的存储格式为PE-COFF格式，linux下为elf格式，通常我们关心elf格式的比较多，不光可执行文件（windows下.exe，linux下.elf）是按照可执行文件格式存储，动态链接库（windows下的.dll，linux下的.so）以及静态链接库（windows下的*.lib，linux下的*.a）都是按照可执行文件的存储格式存储的，那么我们有必要研究下可执行文件的存储格式，我们以elf可执行文件的存储格式为例子，详细介绍下elf的文件格式</p>
</section>
<section id="id12">
<h3>ELF文件存储格式<a class="headerlink" href="#id12" title="此标题的永久链接"></a></h3>
<p>elf格式的文件，可以归为4类</p>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: left;">ELF文件类型</th>
<th>说明</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">可重定位文件</td>
<td>包含代码和数据，可以被用来链接成可执行文件elf或者动态/静态链接链接库</td>
<td>linux <em>.o, </em>.a, <em>.so文件，Windows </em>.obj, <em>.lib, </em>.dll文件</td>
</tr>
<tr>
<td style="text-align: left;">可执行文件</td>
<td>直接可执行的程序</td>
<td>Linux中的/bin/bash中的，elf文件，windows中的exe</td>
</tr>
<tr>
<td style="text-align: left;">共享目标文件</td>
<td>包含代码和数据，和其他可重定位文件，一起链接成可执行文件</td>
<td>linux <em>.so，windows </em>.dll</td>
</tr>
<tr>
<td style="text-align: left;">核心转储文件</td>
<td>当进程意外终止时，系统将该进程的地址空间的内容以及一些其他文件转储到核心转储文件</td>
<td>linux下的Core dump文件</td>
</tr>
</tbody>
</table><p><img alt="image-20210421093830190" src="../_images/image-20210421093830190.png" /></p>
<p>elf格式文件，有文件头，文件头描述了文件属性，包括文件是否为可执行，还是静态链接，动态练级库，如果是可执行文件的话，那么可执行文件的入口地址是多少，目标硬件，目标操作系统等信息</p>
<p>代码，编译后的执行语句为机器代码，保存在.text段</p>
<p>.bss段存放未初始化的全局变量或者未初始化的静态局部变量，或者初始化为0的全局，静态局部变量，.bss段只是为未初始化的全局变量和局部静态变量预留位置而已，在elf文件，或者bin文件中，不占用实际的空间</p>
<p>测试源文件</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// SimpleSection.c</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">printf</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">global_init_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">84</span><span class="p">;</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">global_uninit_var</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">func1</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">85</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">static_var2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">func1</span><span class="p">(</span><span class="n">static_var</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">static_var2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>我这边的测试环境：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ uname -a
Linux ubuntu <span class="m">3</span>.13.0-32-generic <span class="c1">#57-Ubuntu SMP Tue Jul 15 03:51:12 UTC 2014 i686 i686 i686 GNU/Linux</span>
</pre></div>
</div>
<p>编译源代码：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ gcc -c SimpleSection.c   <span class="c1">#其中-c表示只编译源文件，不链接</span>
</pre></div>
</div>
<p>编译后生成SimpleSection.o</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ ll
total <span class="m">16</span>
drwxrwxr-x <span class="m">2</span> cyc cyc <span class="m">4096</span> Apr <span class="m">23</span> <span class="m">09</span>:27 ./
drwxrwxr-x <span class="m">4</span> cyc cyc <span class="m">4096</span> Apr <span class="m">23</span> <span class="m">09</span>:19 ../
-rw-rw-r-- <span class="m">1</span> cyc cyc  <span class="m">319</span> Apr <span class="m">23</span> <span class="m">09</span>:16 SimpleSection.c
-rw-rw-r-- <span class="m">1</span> cyc cyc <span class="m">1312</span> Apr <span class="m">23</span> <span class="m">09</span>:25 SimpleSection.o
</pre></div>
</div>
<p>查看编译后的.o文件类型为可重定位类型，一般叫做目标文件，该文件类型可以被用来链接成可执行文件</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ file SimpleSection.o
SimpleSection.o: ELF <span class="m">32</span>-bit LSB  relocatable, Intel <span class="m">80386</span>, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, not stripped
</pre></div>
</div>
<p>查看编译后的目标文件所包含的段信息</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ objdump -h SimpleSection.o

SimpleSection.o:     file format elf32-i386

Sections:
段名               段占字节数                     该段在文件中的偏移
Idx Name          Size      VMA       LMA       File off  Algn
  <span class="m">0</span> .text         <span class="m">00000053</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000034</span>  <span class="m">2</span>**0
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  <span class="m">1</span> .data         <span class="m">00000008</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000088</span>  <span class="m">2</span>**2
                  CONTENTS, ALLOC, LOAD, DATA
  <span class="m">2</span> .bss          <span class="m">00000004</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000090</span>  <span class="m">2</span>**2
                  ALLOC
  <span class="m">3</span> .rodata       <span class="m">00000004</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000090</span>  <span class="m">2</span>**0
                  CONTENTS, ALLOC, LOAD, READONLY, DATA
  <span class="m">4</span> .comment      0000002c  <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000094</span>  <span class="m">2</span>**0
                  CONTENTS, READONLY
  <span class="m">5</span> .note.GNU-stack <span class="m">00000000</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  000000c0  <span class="m">2</span>**0
                  CONTENTS, READONLY
  <span class="m">6</span> .eh_frame     <span class="m">00000058</span>  <span class="m">00000000</span>  <span class="m">00000000</span>  000000c0  <span class="m">2</span>**2
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, DATA
</pre></div>
</div>
<p>接下来，我们就需要仔细的分析下编译后生成的目标文件了,这里我们主要研究.text段（代码段）.data段（全局数据段）.bss段（0数据段）其余几个段，比如.rodata段）（只读数据段）.comment(注释段) .note.GNU-stack (堆栈提示段)，.eh_frame 表示的是调试时使用的一些数据，便于展开调试，可以暂时先不关心</p>
<p>Size: 段的长度，单位字节</p>
<p>File Off ：该段的起始地址在目标文件中的偏移</p>
<p>CONTENTS: 段属性，表示该段在文件中存在， 一般.bss段就没有CONTENTS属性，因为bss在文件中不占用实际大小</p>
<p>ALLOC： 段属性，</p>
<p>根据文件的偏移，画出该目标文件在elf中的结构图</p>
<p><img alt="image-20210423164014169" src="../_images/image-20210423164014169.png" /></p>
<p>有一个专门的命令叫做size,可以查看elf文件的代码段，数据段和bss段的长度</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ size SimpleSection.o 
   text	   data	    bss	    dec	    hex	filename
    <span class="m">175</span>	      <span class="m">8</span>	      <span class="m">4</span>	    <span class="m">187</span>	     bb	SimpleSection.o
解释：
<span class="m">1</span>. text 表示的是.text段和rodata段和eh_frame段的三者之和
<span class="m">2</span>. data 表示的就是可读可写的数据段的长度
<span class="m">3</span>. bss 表示bss段的大小
<span class="m">4</span>. dec表示的是 text + data + bss
<span class="m">5</span>. hex就是 dec的16进制表示
</pre></div>
</div>
<p><strong>查看代码段</strong>  : -s 参数可以将所有段的内容以16进制的方式打印出来，-d参数可以将所有包含指令的段反汇编</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ objdump -s -d SimpleSection.o

SimpleSection.o:     file format elf32-i386

Contents of section .text:  # 该段的长度为0x53，即和上面objdump -h出来的.text段长度一致
 0000 5589e583 ec188b45 08894424 04c70424  U......E..D$...$
 0010 00000000 e8fcffff ffc9c355 89e583e4  ...........U....
 0020 f083ec20 c7442418 01000000 8b150400  ... .D$.........
 0030 0000a100 00000001 c28b4424 1801c28b  ..........D$....
 0040 44241c01 d0890424 e8fcffff ff8b4424  D$.....$......D$
 0050 18c9c3                               ...             
Contents of section .data:
 0000 54000000 55000000                    T...U...        
Contents of section .rodata:
 0000 25640a00                             %d..            
Contents of section .comment:
 0000 00474343 3a202855 62756e74 7520342e  .GCC: (Ubuntu 4.
 0010 382e342d 32756275 6e747531 7e31342e  8.4-2ubuntu1~14.
 0020 30342e34 2920342e 382e3400           04.4) 4.8.4.    
Contents of section .eh_frame:
 0000 14000000 00000000 017a5200 017c0801  .........zR..|..
 0010 1b0c0404 88010000 1c000000 1c000000  ................
 0020 00000000 1b000000 00410e08 8502420d  .........A....B.
 0030 0557c50c 04040000 1c000000 3c000000  .W..........&lt;...
 0040 1b000000 38000000 00410e08 8502420d  ....8....A....B.
 0050 0574c50c 04040000                    .t......        

Disassembly of section .text:

00000000 &lt;func1&gt;:
   0:	55                   	push   %ebp
   1:	89 e5                	mov    %esp,%ebp
   3:	83 ec 18             	sub    $0x18,%esp
   6:	8b 45 08             	mov    0x8(%ebp),%eax
   9:	89 44 24 04          	mov    %eax,0x4(%esp)
   d:	c7 04 24 00 00 00 00 	movl   $0x0,(%esp)
  14:	e8 fc ff ff ff       	call   15 &lt;func1+0x15&gt;
  19:	c9                   	leave  
  1a:	c3                   	ret    

0000001b &lt;main&gt;:
  1b:	55                   	push   %ebp
  1c:	89 e5                	mov    %esp,%ebp
  1e:	83 e4 f0             	and    $0xfffffff0,%esp
  21:	83 ec 20             	sub    $0x20,%esp
  24:	c7 44 24 18 01 00 00 	movl   $0x1,0x18(%esp)
  2b:	00 
  2c:	8b 15 04 00 00 00    	mov    0x4,%edx
  32:	a1 00 00 00 00       	mov    0x0,%eax
  37:	01 c2                	add    %eax,%edx
  39:	8b 44 24 18          	mov    0x18(%esp),%eax
  3d:	01 c2                	add    %eax,%edx
  3f:	8b 44 24 1c          	mov    0x1c(%esp),%eax
  43:	01 d0                	add    %edx,%eax
  45:	89 04 24             	mov    %eax,(%esp)
  48:	e8 fc ff ff ff       	call   49 &lt;main+0x2e&gt;
  4d:	8b 44 24 18          	mov    0x18(%esp),%eax
  51:	c9                   	leave  
  52:	c3                   	ret 
</pre></div>
</div>
<p>.text段的第一个字节“0x55”就是func1()函数的第一条“push   %ebp” 指令，而最后一个字节0xc3就是main函数的最后一条指令“ret”</p>
<p>.data段保存的是那些已经初始化了的全局变量和静态局部变量，刚好是8个字节</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">就是下面这两个变量</span>
<span class="nb">int</span> <span class="n">global_init_var</span> <span class="o">=</span> <span class="mi">84</span><span class="p">;</span>
<span class="n">static</span> <span class="nb">int</span> <span class="n">static_var</span> <span class="o">=</span> <span class="mi">85</span><span class="p">;</span>
</pre></div>
</div>
<p>对应如下</p>
<p><img alt="image-20210423171129401" src="../_images/image-20210423171129401.png" /></p>
<p>SimpleSection.c里面，我们调用了printf的时候，用到了一个字符串常量“%d\n”,它是一种只读数据，所以被放到.rodata段，通过查阅ASSIC码表， 0x25对应的ASSIC码为%d， 0x64对应字母d, 0x0a对应\n，最后的0x0表示\0</p>
<p><img alt="image-20210423171325178" src="../_images/image-20210423171325178.png" /></p>
<p>.rodata段存放的是只读数据，一般是程序里面的只读变量，如const修饰的变量和字符串常量，一般会存放到只读存储器中，提一下，有时编译器会把字符串常量放到.data段，不常见，暂时可以忽略</p>
<p>.bss段，存放的是未初始化的全局变量和局部静态变量，.bss段为他们预留了空间，我们的测试程序有2个4字节的变量，按理.bss段占8个字节，但是我们看到的结果是占4个字节，与我们期望的不符，我们通过<strong>符号表 <strong>Symbol Table(后面介绍)，只有static_var2被放在了.bss段，而global_uninit_var却没有被放到任何段，只是一个未定义的“COMMON符号”，这其实是跟不同的语言与不同的编译器实现有关，有些编译器会将全局未初始化的变量放到.bss段，有些则不这样做，只是</strong>预留一个未定义的全局变量符号</strong>等到链接成可执行文件的时候，再分配到.bss段上，这个我们后续再讨论，<strong>原则上讲我们可以简单的把它们全部认为存放在.bss段</strong></p>
<p>注意一个问题：</p>
<p>static int x1 = 0;</p>
<p>static int x2 = 1;</p>
<p>那么x1会被放到.bss段，x2会被放到.data段，为啥呢，这样做更加省最后的elf或者bin文件的空间</p>
<p>其他段</p>
<p><img alt="image-20210423172835189" src="../_images/image-20210423172835189.png" /></p>
<p>以.作为前缀的段，表示这些表的名字是系统保留的，应用程序可以使用非系统保留的段自定义，还有一些段，比如.sdata, .tdesc.sbss等等，是elf文件历史遗留问题造成的，可以不用理会，已经被遗弃了。</p>
<p>正常情况下，gcc编译出来的目标文件中，代码会放到.text段，全局变量和静态变量会被放到.data段和.bss段，但是当我们系统你定义的某些变量或者部分代码放到你所指定的段中去，如何实现呢？gcc提供了扩展机制，可以让程序猿指定变量所在的段</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>__attribute__((section(“FOO”))) int global_val = 43;
__attribute__((section(“BAR”))) void foo()
{
    
}
</pre></div>
</div>
<p>我们再全局变量或者函数之前加上__attribute__((section(“name”))) 属性就可以把相应的变量或者函数放到“name”为段名的段中了</p>
</section>
<section id="id13">
<h3>ELF文件结构描述<a class="headerlink" href="#id13" title="此标题的永久链接"></a></h3>
<p><img alt="image-20210423173937330" src="../_images/image-20210423173937330.png" /></p>
<p>elf格式文件最前部分时elf文件头(Section Header)，它包含了面熟整个文件的基本属性，比如elf的文件版本，目标机器型号，程序入口地址，紧接着是elf文件各个段，其中，elf文件中与段有关的重要结构就是段表（Section Header Table），该表描述了elf文件包含的所有段的信息，比如每个段的段名，段的长度，在文件中的偏移，读写权限以及段的其他属性。其他的还有字符串表，和符号表等，后续介绍</p>
<section id="id14">
<h4>文件头<a class="headerlink" href="#id14" title="此标题的永久链接"></a></h4>
<p><img alt="image-20210423194022796" src="../_images/image-20210423194022796.png" /></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ readelf -h SimpleSection.o
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 			#elf魔数
  Class:                             ELF32					        #目标机器字节长度
  Data:                              2&#39;s complement, little endian  #数据存储方式
  Version:                           1 (current)					#版本
  OS/ABI:                            UNIX - System V				#运行平台
  ABI Version:                       0								#ABI版本
  Type:                              REL (Relocatable file)			#elf文件类型（可重定位）
  Machine:                           Intel 80386					#硬件平台
  Version:                           0x1							#硬件平台版本
  Entry point address:               0x0							#程序入口地址
  Start of program headers:          0 (bytes into file)			#
  Start of section headers:          376 (bytes into file)			# 段表的偏移地址0x178
  Flags:                             0x0
  Size of this header:               52 (bytes)						#elf header大小 0x34
  Size of program headers:           0 (bytes)
  Number of program headers:         0
  Size of section headers:           40 (bytes)
  Number of section headers:         13
  Section header string table index: 10
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_NIDENT</span><span class="p">];</span><span class="w">     </span><span class="cm">/* Magic number and other info */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_type</span><span class="p">;</span><span class="w">                 </span><span class="cm">/* Object file type */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_machine</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Architecture */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">e_version</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Object file version */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Addr</span><span class="w">    </span><span class="n">e_entry</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Entry point virtual address */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Off</span><span class="w">     </span><span class="n">e_phoff</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Program header table file offset */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Off</span><span class="w">     </span><span class="n">e_shoff</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section header table file offset */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">e_flags</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Processor-specific flags */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_ehsize</span><span class="p">;</span><span class="w">               </span><span class="cm">/* ELF header size in bytes */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_phentsize</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Program header table entry size */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_phnum</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Program header table entry count */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_shentsize</span><span class="p">;</span><span class="w">            </span><span class="cm">/* Section header table entry size */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_shnum</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section header table entry count */</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Half</span><span class="w">    </span><span class="n">e_shstrndx</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Section header string table index */</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf32_Ehdr</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="image-20210423193710075" src="../_images/image-20210423193710075.png" /></p>
<p><img alt="image-20210423193723154" src="../_images/image-20210423193723154.png" /></p>
<p><img alt="image-20210423193748446" src="../_images/image-20210423193748446.png" /></p>
<p>elf文件类型有3种：</p>
<p><img alt="image-20210423193855180" src="../_images/image-20210423193855180.png" /></p>
</section>
<section id="id15">
<h4>段表<a class="headerlink" href="#id15" title="此标题的永久链接"></a></h4>
<p><img alt="image-20210423194009546" src="../_images/image-20210423194009546.png" /></p>
<p>段表，就是保存elf文件中各个段的属性信息的结构，段表是elf文件中除了文件头以外最重要的结构，他描述了elf各个段的信息，比如每个段的段名，段的长度，在文件中的偏移，读写权限及段的其他属性，elf文件的段的结构就是由段表决定的，编译器，连接器，装载器等都是依靠段表来定位和访问各个段的属性的，段表在elf文件中的位置由elf文件头中的e_shoff成员决定</p>
<p>前面我们了解到的段，其实是比较重要的一些段，但并不完整，使用如下命令查看elf文件中，完整的段信息</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ readelf -S SimpleSection.o
There are <span class="m">13</span> section headers, starting at offset 0x178:

Section Headers:
  <span class="o">[</span>Nr<span class="o">]</span> Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  <span class="o">[</span> <span class="m">0</span><span class="o">]</span>                   NULL            <span class="m">00000000</span> <span class="m">000000</span> <span class="m">000000</span> <span class="m">00</span>      <span class="m">0</span>   <span class="m">0</span>  <span class="m">0</span>
  <span class="o">[</span> <span class="m">1</span><span class="o">]</span> .text             PROGBITS        <span class="m">00000000</span> <span class="m">000034</span> <span class="m">000053</span> <span class="m">00</span>  AX  <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span> <span class="c1">#</span>
  <span class="o">[</span> <span class="m">2</span><span class="o">]</span> .rel.text         REL             <span class="m">00000000</span> 0004e8 <span class="m">000028</span> <span class="m">08</span>     <span class="m">11</span>   <span class="m">1</span>  <span class="m">4</span> <span class="c1">#</span>
  <span class="o">[</span> <span class="m">3</span><span class="o">]</span> .data             PROGBITS        <span class="m">00000000</span> <span class="m">000088</span> <span class="m">000008</span> <span class="m">00</span>  WA  <span class="m">0</span>   <span class="m">0</span>  <span class="m">4</span>
  <span class="o">[</span> <span class="m">4</span><span class="o">]</span> .bss              NOBITS          <span class="m">00000000</span> <span class="m">000090</span> <span class="m">000004</span> <span class="m">00</span>  WA  <span class="m">0</span>   <span class="m">0</span>  <span class="m">4</span>
  <span class="o">[</span> <span class="m">5</span><span class="o">]</span> .rodata           PROGBITS        <span class="m">00000000</span> <span class="m">000090</span> <span class="m">000004</span> <span class="m">00</span>   A  <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span>
  <span class="o">[</span> <span class="m">6</span><span class="o">]</span> .comment          PROGBITS        <span class="m">00000000</span> <span class="m">000094</span> 00002c <span class="m">01</span>  MS  <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span>
  <span class="o">[</span> <span class="m">7</span><span class="o">]</span> .note.GNU-stack   PROGBITS        <span class="m">00000000</span> 0000c0 <span class="m">000000</span> <span class="m">00</span>      <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span>
  <span class="o">[</span> <span class="m">8</span><span class="o">]</span> .eh_frame         PROGBITS        <span class="m">00000000</span> 0000c0 <span class="m">000058</span> <span class="m">00</span>   A  <span class="m">0</span>   <span class="m">0</span>  <span class="m">4</span>
  <span class="o">[</span> <span class="m">9</span><span class="o">]</span> .rel.eh_frame     REL             <span class="m">00000000</span> <span class="m">000510</span> <span class="m">000010</span> <span class="m">08</span>     <span class="m">11</span>   <span class="m">8</span>  <span class="m">4</span>
  <span class="o">[</span><span class="m">10</span><span class="o">]</span> .shstrtab         STRTAB          <span class="m">00000000</span> <span class="m">000118</span> 00005f <span class="m">00</span>      <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span>
  <span class="o">[</span><span class="m">11</span><span class="o">]</span> .symtab           SYMTAB          <span class="m">00000000</span> <span class="m">000380</span> <span class="m">000100</span> <span class="m">10</span>     <span class="m">12</span>  <span class="m">11</span>  <span class="m">4</span>
  <span class="o">[</span><span class="m">12</span><span class="o">]</span> .strtab           STRTAB          <span class="m">00000000</span> <span class="m">000480</span> <span class="m">000066</span> <span class="m">00</span>      <span class="m">0</span>   <span class="m">0</span>  <span class="m">1</span>
Key to Flags:
  W <span class="o">(</span>write<span class="o">)</span>, A <span class="o">(</span>alloc<span class="o">)</span>, X <span class="o">(</span>execute<span class="o">)</span>, M <span class="o">(</span>merge<span class="o">)</span>, S <span class="o">(</span>strings<span class="o">)</span>
  I <span class="o">(</span>info<span class="o">)</span>, L <span class="o">(</span>link order<span class="o">)</span>, G <span class="o">(</span>group<span class="o">)</span>, T <span class="o">(</span>TLS<span class="o">)</span>, E <span class="o">(</span>exclude<span class="o">)</span>, x <span class="o">(</span>unknown<span class="o">)</span>
  O <span class="o">(</span>extra OS processing required<span class="o">)</span> o <span class="o">(</span>OS specific<span class="o">)</span>, p <span class="o">(</span>processor specific<span class="o">)</span>
</pre></div>
</div>
<p>使用readelf输出的结果就是elf文件表的内容，那么就让我们对照这个输出来看看段表的结构，段表的结构比较简单，他是一个以“Elf32_Shdr”结构体为元素的数组。我们这里，该数组的长度是13，其中第一个段表，即index为0的，类型为NULL,是一个无效的段表（段描述符），其余12个都是有效的段</p>
<p>段表结构体如下，在32位机器中，每个段表占用的字节数固定为40个字节</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Section header.  */</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_name</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section name (string tbl index) */</span><span class="w"> </span><span class="n">段名</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_type</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section type */</span><span class="w">					  </span><span class="n">段类型</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_flags</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Section flags */</span><span class="w">					  </span><span class="n">段标志</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Addr</span><span class="w">    </span><span class="n">sh_addr</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section virtual addr at execution */</span><span class="w"> </span><span class="n">段虚拟地址</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Off</span><span class="w">     </span><span class="n">sh_offset</span><span class="p">;</span><span class="w">              </span><span class="cm">/* Section file offset */</span><span class="w">		</span><span class="n">段在文件中的偏移</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_size</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Section size in bytes */</span><span class="w">		</span><span class="n">段长度</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_link</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Link to another section */</span><span class="w">	</span><span class="n">段链接信息</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_info</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Additional section information */</span><span class="w"> </span><span class="n">段额外信息</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_addralign</span><span class="p">;</span><span class="w">           </span><span class="cm">/* Section alignment */</span><span class="w">			 </span><span class="n">段地址对齐</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">sh_entsize</span><span class="p">;</span><span class="w">             </span><span class="cm">/* Entry size if section holds table */</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf32_Shdr</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>elf文件细节剖析：</p>
<p><img alt="image-20210424125803145" src="../_images/image-20210424125803145.png" /></p>
</section>
<section id="id16">
<h4>段类型说明<a class="headerlink" href="#id16" title="此标题的永久链接"></a></h4>
<p><img alt="image-20210424125948144" src="../_images/image-20210424125948144.png" /></p>
<p><img alt="image-20210424130035983" src="../_images/image-20210424130035983.png" /></p>
<p>结合前面获取到的段信息，对应上面的表格，可以知道对应的段类型</p>
<p><img alt="image-20210424130706273" src="../_images/image-20210424130706273.png" /></p>
</section>
<section id="id17">
<h4>段标志<a class="headerlink" href="#id17" title="此标题的永久链接"></a></h4>
<p>段标志，表示对应的段，在进程虚拟地址空间中的属性，比如是否可写，可执行等</p>
<p><img alt="image-20210424130916276" src="../_images/image-20210424130916276.png" /></p>
</section>
<section id="id18">
<h4>重定位表<a class="headerlink" href="#id18" title="此标题的永久链接"></a></h4>
<p><img alt="image-20210424133555149" src="../_images/image-20210424133555149.png" /></p>
<p><img alt="image-20210424131455268" src="../_images/image-20210424131455268.png" /></p>
<p><img alt="image-20210424131504981" src="../_images/image-20210424131504981.png" /></p>
</section>
<section id="id19">
<h4>字符串表<a class="headerlink" href="#id19" title="此标题的永久链接"></a></h4>
<p><img alt="image-20210424135002222" src="../_images/image-20210424135002222.png" /></p>
<p><img alt="image-20210424133940021" src="../_images/image-20210424133940021.png" /></p>
<p><img alt="image-20210424134056522" src="../_images/image-20210424134056522.png" /></p>
<p><img alt="image-20210424134233398" src="../_images/image-20210424134233398.png" /></p>
<p>常规字符串表</p>
<p><img alt="image-20210424135038938" src="../_images/image-20210424135038938.png" /></p>
</section>
</section>
<section id="id20">
<h3>链接的接口-符号<a class="headerlink" href="#id20" title="此标题的永久链接"></a></h3>
<p>连接过程的本质，就是把多个不同的目标.o文件，相互“粘”在一起，或者说想搭积木一样，拼装成一个整体，为了使得不同的目标文件之前能够相互拼装，这些目标文件之间必须有固定的规则才行，在链接中，目标文件之间的相互拼装，实际是目标文件之间对地址的引用，即对函数或者变量的地址的引用，比如目标文件B中用到了目标文件A中的函数foo，那么我们就成目标文件A定义了foo函数，成目标B引用了目标A中的函数foo,对变量同样适用，每个函数和变量都有自己独特的名字，才能避免在链接过程中不同变量和函数之间的混淆，在链接中，我们将函数和变量统称为<strong>符号</strong>，函数名或者变量名就是<strong>符号名</strong></p>
<p>每个目标文件都有相应的<strong>符号表</strong>，这个符号表记录目标文件中的所有用到的符号，每个定义的符号有一个对应的值，叫做<strong>符号值</strong>，对于变量和函数来说，符号值就是他们的地址，除了函数和变量之外，还存在其他几种不常用到的符号</p>
<p><img alt="image-20210424135225836" src="../_images/image-20210424135225836.png" /></p>
<p>符号表中的所有的符号（符号名和符号值），进行分类：</p>
<ul class="simple">
<li><p>定义在本目标文件的全局符号，可以被其他目标引用，比如func1,main,global_init_var</p></li>
<li><p>在本目标文件中引用的全局符号，却没有定义在本目标文件中的，一般叫做<strong>外部符号</strong>，也就是我们讲的引用的符号，比如printf</p></li>
<li><p>段名，这种符号往往是由编译器产生，它的值就是该段的起始地址，比如.text段的值就是0x34</p></li>
<li><p>局部符号，这类符号只在编译单元内部可见</p></li>
<li><p>行号信息，即目标文件指令与源代码行的对应关系，可选</p></li>
</ul>
<p>对于我们来说，最值得关注的就是全局符号，即上面的第一和第二类，因为连接过程值关系全局符号的相互拼装，</p>
<p>查看elf文件的符号表</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ nm SimpleSection.o
<span class="m">00000000</span> T func1				<span class="c1"># T表示符号位于text段</span>
<span class="m">00000000</span> D global_init_var		<span class="c1"># D表示符号位于.data段</span>
<span class="m">00000004</span> C global_uninit_var	<span class="c1"># C表示未初始化数据段</span>
0000001b T main					
         U <span class="nb">printf</span>				<span class="c1"># U表示该符号在当前目标文件中没有定义</span>
<span class="m">00000004</span> d static_var.1378		<span class="c1"># d表示静态已初始化变量</span>
<span class="m">00000000</span> b static_var2.1379		<span class="c1"># b表示静态未初始化变量</span>
cyc@ubuntu:~/workspace/chapt3$ 
</pre></div>
</div>
<section id="id21">
<h4>符号表结构<a class="headerlink" href="#id21" title="此标题的永久链接"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Symbol table entry.  */</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">st_name</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Symbol name (string tbl index) */</span><span class="w">  </span><span class="n">符号名</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Addr</span><span class="w">    </span><span class="n">st_value</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Symbol value */</span><span class="w">					  </span><span class="n">符号值</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Word</span><span class="w">    </span><span class="n">st_size</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Symbol size */</span><span class="w">					  </span><span class="n">符号大小</span><span class="w"></span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">st_info</span><span class="p">;</span><span class="w">                </span><span class="cm">/* Symbol type and binding */</span><span class="w"> </span><span class="n">符号类型和绑定信息</span><span class="w"></span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">st_other</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Symbol visibility */</span><span class="w"> </span><span class="n">忽略</span><span class="w"></span>
<span class="w">  </span><span class="n">Elf32_Section</span><span class="w"> </span><span class="n">st_shndx</span><span class="p">;</span><span class="w">               </span><span class="cm">/* Section index */</span><span class="w">	   </span><span class="n">符号所在的段</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">Elf32_Sym</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="image-20210424140438786" src="../_images/image-20210424140438786.png" /></p>
<p>符号类型和绑定信息：</p>
<p><img alt="image-20210424140813242" src="../_images/image-20210424140813242.png" /></p>
<p>一个无符号 8bit数据，低4bit（0~0xf）表示符号的类型</p>
<p><img alt="image-20210424140946987" src="../_images/image-20210424140946987.png" /></p>
<p>高4bit表示符号绑定信息</p>
<p><img alt="image-20210424140914932" src="../_images/image-20210424140914932.png" /></p>
<p>查看符号表信息：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cyc@ubuntu:~/workspace/chapt3$ readelf -s SimpleSection.o 

Symbol table <span class="s1">&#39;.symtab&#39;</span> contains <span class="m">16</span> entries:
   Num:    Value  Size Type    Bind   Vis      Ndx Name
     <span class="m">0</span>: <span class="m">00000000</span>     <span class="m">0</span> NOTYPE  LOCAL  DEFAULT  UND 
     <span class="m">1</span>: <span class="m">00000000</span>     <span class="m">0</span> FILE    LOCAL  DEFAULT  ABS SimpleSection.c
     <span class="m">2</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">1</span> 
     <span class="m">3</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">3</span> 
     <span class="m">4</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">4</span> 
     <span class="m">5</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">5</span> 
     <span class="m">6</span>: <span class="m">00000004</span>     <span class="m">4</span> OBJECT  LOCAL  DEFAULT    <span class="m">3</span> static_var.1378
     <span class="m">7</span>: <span class="m">00000000</span>     <span class="m">4</span> OBJECT  LOCAL  DEFAULT    <span class="m">4</span> static_var2.1379
     <span class="m">8</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">7</span> 
     <span class="m">9</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">8</span> 
    <span class="m">10</span>: <span class="m">00000000</span>     <span class="m">0</span> SECTION LOCAL  DEFAULT    <span class="m">6</span> 
    <span class="m">11</span>: <span class="m">00000000</span>     <span class="m">4</span> OBJECT  GLOBAL DEFAULT    <span class="m">3</span> global_init_var
    <span class="m">12</span>: <span class="m">00000004</span>     <span class="m">4</span> OBJECT  GLOBAL DEFAULT  COM global_uninit_var
    <span class="m">13</span>: <span class="m">00000000</span>    <span class="m">27</span> FUNC    GLOBAL DEFAULT    <span class="m">1</span> func1
    <span class="m">14</span>: <span class="m">00000000</span>     <span class="m">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="nb">printf</span>
    <span class="m">15</span>: 0000001b    <span class="m">56</span> FUNC    GLOBAL DEFAULT    <span class="m">1</span> main
</pre></div>
</div>
<p><img alt="image-20210424142556162" src="../_images/image-20210424142556162.png" /></p>
<p><img alt="image-20210424142732884" src="../_images/image-20210424142732884.png" /></p>
<p><img alt="image-20210424142751558" src="../_images/image-20210424142751558.png" /></p>
<p><img alt="image-20210424142844810" src="../_images/image-20210424142844810.png" /></p>
</section>
<section id="id22">
<h4>符号修饰与函数签名<a class="headerlink" href="#id22" title="此标题的永久链接"></a></h4>
<p>就是我们在程序中定义了一个变量或者函数，编译器编译后的符号可能会额外统一加上一些前后缀</p>
</section>
<section id="id23">
<h4>强符号与弱符号<a class="headerlink" href="#id23" title="此标题的永久链接"></a></h4>
<p>未初始化的全局变量以及显示声明为弱符号的变量或者函数，称为弱变量，弱函数</p>
<p>初始化的全局变量或者未显示声明为弱符号的变量或者函数，称为强符号</p>
<p>显示声明，gcc中，使用__attribute__((weak))来定义</p>
</section>
</section>
<section id="id24">
<h3>调试信息<a class="headerlink" href="#id24" title="此标题的永久链接"></a></h3>
<p>目标文件中还有可能保存的是调试信息，比如设置断点，监视变量变化等，先忽略讲解</p>
<p>附件：下面截图是目标文件的二进制格式</p>
<p><img alt="image-20210423091407605" src="../_images/image-20210423091407605.png" /></p>
<p><img alt="image-20210423091428549" src="../_images/image-20210423091428549.png" /></p>
<p><img alt="image-20210423091453383" src="../_images/image-20210423091453383.png" /></p>
</section>
</section>
<section id="id25">
<h2><span class="section-number">3.3. </span><a class="headerlink" href="#id25" title="此标题的永久链接"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="02_posix_dfs/rt_thread_posix_dfs.html" class="btn btn-neutral float-left" title="2. POSIX 介绍" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="nrf52832_rtthread_dlmodule.html" class="btn btn-neutral float-right" title="4. nRF52832 RT-Thread dmodule适配" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>