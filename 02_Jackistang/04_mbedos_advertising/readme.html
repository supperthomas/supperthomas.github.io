<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. BLE_Advertising &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="5. mbed-os LEDDemo 介绍" href="../05_mbedos_example_ble_led/readme.html" />
    <link rel="prev" title="3. GATT Service 定义总结" href="../03_heart_rate_att_gatt/01_intruduce.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">WB55:Jackistang</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_introduce/01_intruduce.html">2. CubeMX生成BLE应用(二)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_heart_rate_att_gatt/01_intruduce.html">3. GATT Service 定义总结</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. BLE_Advertising</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example">4.1. example 介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#batterydemo">BatteryDemo 接口</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-init-complete">on_init_complete</a></li>
<li class="toctree-l4"><a class="reference internal" href="#start-advertising">start_advertising</a></li>
<li class="toctree-l4"><a class="reference internal" href="#update-battery-level">update_battery_level</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mbedos-ble-advertising">4.2. mbedos_ble_advertising 抓包文件分析</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ble-advertisingdatabuilder">4.3. ble::AdvertisingDataBuilder</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mbed-span">4.4. mbed::Span</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#span">Span 特性介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">Span 使用</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">Span 例程</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../05_mbedos_example_ble_led/readme.html">5. mbed-os LEDDemo 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_mbedos_gatt_client/GattClient.html">6. mbed os GattClient 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/DigitalOut.html">7. DigitalOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/InterruptIn.html">8. InterruptIn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/Callback.html">9. Callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Virtualbox%20%E5%AE%89%E8%A3%85%20Ubuntu%2020.04.html">10. VirtualBox 安装 Ubuntu 20.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html">11. Zephyr 环境搭建</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%20-%20ESP32%20%E7%AF%87.html">12. Zephyr 环境搭建 - ESP32 篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20-%20Bluetooth%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%20-%20QEMU%20%E7%AF%87.html">13. Zephyr - Bluetooth 环境搭建 - QEMU 篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20-%20Shell.html">14. Zephyr - Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20-%20BLE%20%E5%88%9D%E5%A7%8B%E5%8C%96.html">15. BLE 协议栈初始化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20-%20BLE%20%E5%B9%BF%E6%92%AD.html">16. Zephyr - BLE 广播</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08_zephyr/Zephyr%20-%20BLE%20%E6%89%AB%E6%8F%8F.html">17. Zephyr - BLE 扫描</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_esp32/problem.html">18. 掉坑汇总</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_rtthread/workqueue.html">19. RT-Thread workqueue 详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_rtthread/jerryscript.html">20. Jerryscript 简介</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">WB55:Jackistang</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>BLE_Advertising</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/02_Jackistang/04_mbedos_advertising/readme.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ble-advertising">
<h1><span class="section-number">4. </span>BLE_Advertising<a class="headerlink" href="#ble-advertising" title="此标题的永久链接"></a></h1>
<p>本节内容介绍了 mbed os 里 BLE_Advertising 例程里关于打广播的内容。尽可能地从宏观上去了解 mbed os 里 BLE 协议栈是如何打广播的，因此需要充分理解函数名，变量名等与 BLE 广播之间的联系。关于细节部分以后再添加。</p>
<p>阅读本节内容时，一方面需要去观察 mbed os 里打广播的一般流程，另一方面需要知道如何设置广播参数，广播数据。</p>
<section id="example">
<h2><span class="section-number">4.1. </span>example 介绍<a class="headerlink" href="#example" title="此标题的永久链接"></a></h2>
<section id="batterydemo">
<h3>BatteryDemo 接口<a class="headerlink" href="#batterydemo" title="此标题的永久链接"></a></h3>
<p>BatteryDemo 类声明里 public 类型的成员只有一个构造函数和一个 <code class="docutils literal notranslate"><span class="pre">start()</span></code> 方法，因此接口就只有 <code class="docutils literal notranslate"><span class="pre">start()</span></code>，可以在 main 函数里看见创建一个 BatteryDemo 对象后就直接调用了 <code class="docutils literal notranslate"><span class="pre">start()</span></code> 方法。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* mbed will call on_init_complete when when ble is ready */</span><span class="w"></span>
<span class="w">    </span><span class="n">_ble</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">BatteryDemo</span><span class="o">::</span><span class="n">on_init_complete</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* this will never return */</span><span class="w"></span>
<span class="w">    </span><span class="n">_event_queue</span><span class="p">.</span><span class="n">dispatch_forever</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>第 4 行初始化 BLE 协议栈，通过注释可以知道 BLE 协议栈初始化完成后会调用 <code class="docutils literal notranslate"><span class="pre">on_init_complete</span></code> 这个成员函数。第 7 行涉及到 mbed os 里的事件机制，我还没弄懂，而且这对我们理解 BLE 没有影响，在这里就不介绍了。</p>
</section>
<section id="on-init-complete">
<h3>on_init_complete<a class="headerlink" href="#on-init-complete" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Callback triggered when the ble initialization process has finished */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">on_init_complete</span><span class="p">(</span><span class="n">BLE</span><span class="o">::</span><span class="n">InitializationCompleteCallbackContext</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BLE_ERROR_NONE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">print_error</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Ble initialization failed.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">print_mac_address</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">start_advertising</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>这个函数首先打印了设备的 mac 地址，这个地址可以在抓包的时候用于过滤使用。</p>
<p>之后就开始打广播了。</p>
</section>
<section id="start-advertising">
<h3>start_advertising<a class="headerlink" href="#start-advertising" title="此标题的永久链接"></a></h3>
<p>这个函数里内容挺多的，可以分成设置广播参数、设置广播数据、设置扫描回复数据、开始广播这四个部分。</p>
<section id="id1">
<h4>设置广播参数<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* create advertising parameters and payload */</span><span class="w"></span>

<span class="n">ble</span><span class="o">::</span><span class="n">AdvertisingParameters</span><span class="w"> </span><span class="n">adv_parameters</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* you cannot connect to this device, you can only read its advertising data,</span>
<span class="cm">             * scannable means that the device has extra advertising data that the peer can receive if it</span>
<span class="cm">             * &quot;scans&quot; it which means it is using active scanning (it sends a scan request) */</span><span class="w"></span>
<span class="w">    </span><span class="n">ble</span><span class="o">::</span><span class="n">advertising_type_t</span><span class="o">::</span><span class="n">SCANNABLE_UNDIRECTED</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">ble</span><span class="o">::</span><span class="n">adv_interval_t</span><span class="p">(</span><span class="n">ble</span><span class="o">::</span><span class="n">millisecond_t</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="n">ble_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ble</span><span class="p">.</span><span class="n">gap</span><span class="p">().</span><span class="n">setAdvertisingParameters</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ble</span><span class="o">::</span><span class="n">LEGACY_ADVERTISING_HANDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">adv_parameters</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">print_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_ble.gap().setAdvertisingParameters() failed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>这里设置了一个广播参数 <code class="docutils literal notranslate"><span class="pre">adv_parameters</span></code>，其中广播包类型为 <code class="docutils literal notranslate"><span class="pre">SCANNABLE_UNDIRECTED</span></code> ，即可扫描、不定向包，也就是 ADV_SCAN_IND 这个包。然后又设置了发送间隔时间为 1000ms 。</p>
<p>之后将该广播参数通过 <code class="docutils literal notranslate"><span class="pre">_ble.gap().setAdvertisingParameters</span></code> 设置到 BLE 协议栈里。</p>
</section>
<section id="id2">
<h4>设置广播数据<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">setFlags</span><span class="p">();</span><span class="w"></span>
<span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">setName</span><span class="p">(</span><span class="n">DEVICE_NAME</span><span class="p">);</span><span class="w"></span>

<span class="cm">/* we add the battery level as part of the payload so it&#39;s visible to any device that scans */</span><span class="w"></span>
<span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">setServiceData</span><span class="p">(</span><span class="n">GattService</span><span class="o">::</span><span class="n">UUID_BATTERY_SERVICE</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">_battery_level</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">});</span><span class="w"></span>

<span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ble</span><span class="p">.</span><span class="n">gap</span><span class="p">().</span><span class="n">setAdvertisingPayload</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ble</span><span class="o">::</span><span class="n">LEGACY_ADVERTISING_HANDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">getAdvertisingData</span><span class="p">()</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">print_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_ble.gap().setAdvertisingPayload() failed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在 BatteryDemo 类里定义了一个私有成员 <code class="docutils literal notranslate"><span class="pre">ble::AdvertisingDataBuilder</span> <span class="pre">_adv_data_builder;</span></code> ，通过名字可以看出用于构建广播数据包。</p>
<p>然后开始构建广播数据包，也就是那 31 个字节。</p>
<ul class="simple">
<li><p>调用 <code class="docutils literal notranslate"><span class="pre">setFlags()</span></code> ，</p>
<ul>
<li><p>此时是在构建 AD Type 为 0x01 - «Flags» 的 AD Structure ，</p></li>
<li><p>其 AD Data 默认为 <code class="docutils literal notranslate"><span class="pre">BREDR_NOT_SUPPORTED</span> <span class="pre">|</span> <span class="pre">LE_GENERAL_DISCOVERABLE</span></code> ，</p></li>
<li><p>Length 字段会自动设置。</p></li>
</ul>
</li>
<li><p>调用 <code class="docutils literal notranslate"><span class="pre">setName()</span></code>，</p>
<ul>
<li><p>此时是在构建 AD Type 为 0x09 - «Complete Local Name» 的 AD Structure，</p></li>
<li><p>其 AD Data 为 <code class="docutils literal notranslate"><span class="pre">DEVICE_NAME</span></code> ，在文件最开始处有定义 <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">static</span> <span class="pre">char</span> <span class="pre">DEVICE_NAME[]</span> <span class="pre">=</span> <span class="pre">&quot;BATTERY&quot;;</span></code> ，</p></li>
<li><p>Length 字段会自动设置。</p></li>
</ul>
</li>
<li><p>调用 <code class="docutils literal notranslate"><span class="pre">setServiceData()</span></code>，</p>
<ul>
<li><p>此时是在构建 AD Type 为 0x16 - «Service Data» 的 AD Structure，</p></li>
<li><p>其 AD Data 包括 Service UUID 和 Service Data。Service UUID 为 <code class="docutils literal notranslate"><span class="pre">GattService::UUID_BATTERY_SERVICE</span></code> ，也就是 0x180F ，Service Data 就是一个字节的电量 <code class="docutils literal notranslate"><span class="pre">_battery_level</span></code> 。</p></li>
<li><p>Length 字段会自动设置。</p></li>
</ul>
</li>
</ul>
<p>之后通过 <code class="docutils literal notranslate"><span class="pre">_ble.gap().setAdvertisingPayload</span></code> 设置广播包（此处为 ADV_SCAN_IND）的负载数据。</p>
</section>
<section id="id3">
<h4>设置扫描回复数据<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* when advertising you can optionally add extra data that is only sent</span>
<span class="cm">         * if the central requests it by doing active scanning */</span><span class="w"></span>
<span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">_vendor_specific_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0xAD</span><span class="p">,</span><span class="w"> </span><span class="mh">0xDE</span><span class="p">,</span><span class="w"> </span><span class="mh">0xBE</span><span class="p">,</span><span class="w"> </span><span class="mh">0xEF</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">setManufacturerSpecificData</span><span class="p">(</span><span class="n">_vendor_specific_data</span><span class="p">);</span><span class="w"></span>

<span class="n">_ble</span><span class="p">.</span><span class="n">gap</span><span class="p">().</span><span class="n">setAdvertisingScanResponse</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">ble</span><span class="o">::</span><span class="n">LEGACY_ADVERTISING_HANDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">getAdvertisingData</span><span class="p">()</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>首先用 <code class="docutils literal notranslate"><span class="pre">clear()</span></code> 清空广播包数据。</p>
<p>调用 <code class="docutils literal notranslate"><span class="pre">setManufacturerSpecificData()</span></code> 构建 AD Structure:</p>
<ul class="simple">
<li><p>AD Type 为 0xFF - «Manufacturer Specific Data»</p></li>
<li><p>AD Data 为 <code class="docutils literal notranslate"><span class="pre">_vendor_specific_data</span></code>，在上面有定义，Company ID 为 0xdead，Data 为 0xbeef 。</p></li>
<li><p>Length 字段协议栈自动填充。</p></li>
</ul>
<p>然后调用 <code class="docutils literal notranslate"><span class="pre">_ble.gap().setAdvertisingScanResponse</span></code> 设置扫描回复包（SCAN_RSP）的负载数据。</p>
</section>
<section id="id4">
<h4>开始广播<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* start advertising */</span><span class="w"></span>

<span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ble</span><span class="p">.</span><span class="n">gap</span><span class="p">().</span><span class="n">startAdvertising</span><span class="p">(</span><span class="n">ble</span><span class="o">::</span><span class="n">LEGACY_ADVERTISING_HANDLE</span><span class="p">);</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">print_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_ble.gap().startAdvertising() failed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* we simulate battery discharging by updating it every second */</span><span class="w"></span>
<span class="n">_event_queue</span><span class="p">.</span><span class="n">call_every</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="mi">1000</span><span class="n">ms</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="n">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">update_battery_level</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>上述代码就正式开启了广播，同时还定义了每秒执行 <code class="docutils literal notranslate"><span class="pre">update_battery_level()</span></code> 函数的事件。</p>
</section>
</section>
<section id="update-battery-level">
<h3>update_battery_level<a class="headerlink" href="#update-battery-level" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">update_battery_level</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_battery_level</span><span class="o">--</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">_battery_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* update the payload with the new value */</span><span class="w"></span>
<span class="w">    </span><span class="n">ble_error_t</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">setServiceData</span><span class="p">(</span><span class="n">GattService</span><span class="o">::</span><span class="n">UUID_BATTERY_SERVICE</span><span class="p">,</span><span class="w"> </span><span class="n">make_Span</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_battery_level</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">print_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_adv_data_builder.setServiceData() failed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* set the new payload, we don&#39;t need to stop advertising */</span><span class="w"></span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_ble</span><span class="p">.</span><span class="n">gap</span><span class="p">().</span><span class="n">setAdvertisingPayload</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">ble</span><span class="o">::</span><span class="n">LEGACY_ADVERTISING_HANDLE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">_adv_data_builder</span><span class="p">.</span><span class="n">getAdvertisingData</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">print_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_ble.gap().setAdvertisingPayload() failed&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>在该函数里，模拟电量每秒减 1，减到 10 时又回到 100，如此往复。</p>
<p>然后又构建了 «Service Data» 的广播包，使用更新过的电量作为 Service Data 。重新设置广播负载数据。</p>
<p>注意之前设置的 «Manufacturer Specific Data» 数据没有在 <code class="docutils literal notranslate"><span class="pre">_adv_data_builder</span></code> 里清空，所以在发送的 ADV_SCAN_IND 的广播包里也能看到 «Manufacturer Specific Data» 这个 AD Structure 。</p>
</section>
</section>
<section id="mbedos-ble-advertising">
<h2><span class="section-number">4.2. </span>mbedos_ble_advertising 抓包文件分析<a class="headerlink" href="#mbedos-ble-advertising" title="此标题的永久链接"></a></h2>
<p><img alt="../../_images/image-20201202185438185.png" src="../../_images/image-20201202185438185.png" /></p>
<p>可以看见 WB55 周期性的在发送 ADV_SCAN_IND 的包，里面有两个 AD Structure ，其中一个是 Service Data 的类型的包，AD Data 包括 0x180f（Battery Service UUID）和 0x26（电量）。</p>
<p><img alt="../../_images/image-20201202185756693.png" src="../../_images/image-20201202185756693.png" /></p>
<p>当手机端开启扫描模式后，会发现 WB55 发送了 ADV_SCAN_RSP 的包，里面包含了一个 AD Structure，AD Type 为 0xff（Manufacturer Specific）。</p>
<p>WB55 在上电复位的时候也会发送一个广播包，有 3 个 AD Structure ，但那个包我没抓到，就没有写。</p>
</section>
<section id="ble-advertisingdatabuilder">
<h2><span class="section-number">4.3. </span>ble::AdvertisingDataBuilder<a class="headerlink" href="#ble-advertisingdatabuilder" title="此标题的永久链接"></a></h2>
<p>mbed os <a class="reference external" href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html">AdvertisingDataBuilder API 文档</a> 。</p>
<p>AdvertisingDataBuilder 这个类主要用于构建广播数据，该类有一系列的成员函数，可以帮助我们方便地构建 AD Structure 。</p>
<p>一个 AD Structure 由 <strong>Length</strong>, <strong>AD Type</strong>, <strong>AD Data</strong> 这三个部分组成。</p>
<p>可在 <a class="reference external" href="https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile/">https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile/ </a> 网址找到蓝牙联盟定义的所有 AD Type 。</p>
<p>常用广播 AD Type 及相应接口如下：</p>
<table border="1" class="docutils">
<thead>
<tr>
<th>Data Type Value</th>
<th>Data Type Name</th>
<th>AdvertisingDataBuilder</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x01</td>
<td>«Flags»</td>
<td><a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html#a32d9a40ff895015ac3a66a1fc137c194">setFlags</a> (<a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/structble_1_1adv__data__flags__t.html">adv_data_flags_t</a> flags=adv_data_flags_t::default_flags)</td>
</tr>
<tr>
<td>0x03</td>
<td>«16-bit Service Class UUIDs»</td>
<td><a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html#af3f1587af99e161e0bc343470c35dfa5">setLocalServiceList</a> (<a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/structmbed_1_1_span.html">mbed::Span</a>&lt; const <a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/class_u_u_i_d.html">UUID</a> &gt; data, bool complete=true)</td>
</tr>
<tr>
<td>0x09</td>
<td>«Complete Local Name»</td>
<td><a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html#ab4d580cb27de2a0d573a6074f4f97b64">setName</a> (const char *name, bool complete=true)</td>
</tr>
<tr>
<td>0x16</td>
<td>«Service Data»</td>
<td><a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html#a62a7275a0cfa9eadee34eb50f3f5c3cf">setServiceData</a> (<a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/class_u_u_i_d.html">UUID</a> service, <a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/structmbed_1_1_span.html">mbed::Span</a>&lt; const uint8_t &gt; data)</td>
</tr>
<tr>
<td>0xFF</td>
<td>«Manufacturer Specific Data»</td>
<td><a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/classble_1_1_advertising_data_builder.html#a08a3dd9e52eddafaecdc17772021688d">setManufacturerSpecificData</a> (<a href="https://os.mbed.com/docs/mbed-os/v6.4/mbed-os-api-doxy/structmbed_1_1_span.html">mbed::Span</a>&lt; const uint8_t &gt; data)</td>
</tr>
</tbody>
</table></section>
<section id="mbed-span">
<h2><span class="section-number">4.4. </span>mbed::Span<a class="headerlink" href="#mbed-span" title="此标题的永久链接"></a></h2>
<section id="span">
<h3>Span 特性介绍<a class="headerlink" href="#span" title="此标题的永久链接"></a></h3>
<p>数组是 C++ 从 C 语言继承过来的特性，使用方便同时又可以提供绝佳的性能，因此被广泛使用。但是简便的另一面就是风险，其中最大的两个问题就是退化（array decay）和越界访问（range errors）。mbed os 提供了特性 span 解决数组退化和越界访问的问题，使用 span 同时管理数组的地址和大小（span 特性也被 C++ 20 标准支持）。</p>
<p>如下所示代码：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>数组被定义时，同时有个元素个数信息，使用这个信息可以对数组进行操作。但是在将数组作为一个参数传递给某个函数时，只能以指针形式传递，这就是<strong>数组退化</strong>。为了正确知道数组的大小一般需要同时传递数组的大小信息。例如下面的初始化函数就是如此：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">init_data</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">buffer</span><span class="p">[],</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">gsl</span><span class="o">::</span><span class="n">index</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">buffer</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">  </span><span class="c1">//越界访问</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>即使声明函数参数时形式上是数组，但所有的行为都和指针完全相同。还有一个问题就是，由于数组是一种完全暴露的数据结构，没有任何保护。</p>
<p>例如代码中第8行，即使访问的第20个元素已经超过最初定义的10个元素，这种操作一般也会正常通过。但是接下来不知道哪个时刻，这个操作带来的影响就会以一种完全不相关的形式表现出来。数组大小信息获取，传递错误和越界操作具有引入容易、排查困难的特种，是许多程序员的噩梦。</p>
<p>为例解决这个问题，引入了模板类 span，它可以同时管理数组的地址和大小。使用 span 类的初始化函数如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">init_data</span><span class="p">(</span><span class="n">Span</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;size=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">buffer</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">buffer</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w"> </span><span class="c1">//会触发断言</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>只要函数参数声明为：<code class="docutils literal notranslate"><span class="pre">Span&lt;int&gt;</span> <span class="pre">buffer</span></code>，大小信息就会由 span 模板类管理，接下来就可以像 vector 一样使用数组了。如果发生越界访问，会触发断言。</p>
</section>
<section id="id5">
<h3>Span 使用<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>mbed os <a class="reference external" href="https://os.mbed.com/docs/mbed-os/v6.5/apis/span.html">Span 文档</a></p>
<p>Span 是一系列连续元素的试图，它可以替换在函数调用时需要传入的数组首地址指针和数组大小这一对参数。</p>
<section id="id6">
<h4>构造<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h4>
<p>Span 对象可以使用 <strong>C++ 数组</strong>构造，也可以使用<strong>指针+元素个数</strong>构造，还可以使用<strong>一对指针</strong>指向的范围构造。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello mbed!&quot;</span><span class="p">;</span><span class="w"></span>

<span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">span_from_array</span><span class="p">(</span><span class="n">str</span><span class="p">);</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">span_from_ptr_and_size</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">span_from_range</span><span class="p">(</span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id7">
<h4>操作<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h4>
<p>Span 定义了拷贝构造函数和拷贝赋值运算符（=），我们可以像使用常规值对象一样拷贝和赋值 Span 对象。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello mbed!&quot;</span><span class="p">;</span><span class="w"></span>

<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">str_span</span><span class="p">(</span><span class="n">hello_mbed</span><span class="p">);</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">copy_constructed_span</span><span class="p">(</span><span class="n">str_span</span><span class="p">);</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">copy_assigned_span</span><span class="p">;</span><span class="w"></span>

<span class="n">copy_assigned_span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_span</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>可以使用下标 <code class="docutils literal notranslate"><span class="pre">[]</span></code> 运算符随机访问对象里的元素。</p></li>
<li><p>可以使用 <code class="docutils literal notranslate"><span class="pre">data()</span></code> 访问序列视图中第一个元素的指针。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size()</span></code> 函数返回序列中元素的个数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">empty()</span></code> 返回序列中是否有元素。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">process_unit</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">);</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// nothing to process</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">process_unit</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>可以使用 <code class="docutils literal notranslate"><span class="pre">first()</span></code> 从序列的开始处向后分割 Span 。</p></li>
<li><p>可以使用 <code class="docutils literal notranslate"><span class="pre">last()</span></code> 从序列的结束处向前分割 Span 。</p></li>
<li><p>可以使用 <code class="docutils literal notranslate"><span class="pre">subspan()</span></code> 从序列中的任意点开始向后分割 Span 。</p></li>
</ul>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">str</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello mbed!&quot;</span><span class="p">;</span><span class="w"></span>

<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">str_span</span><span class="p">(</span><span class="n">hello_mbed</span><span class="p">);</span><span class="w"></span>

<span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">half_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_span</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>

<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lower_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_span</span><span class="p">.</span><span class="n">first</span><span class="p">(</span><span class="n">half_size</span><span class="p">);</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">upper_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_span</span><span class="p">.</span><span class="n">last</span><span class="p">(</span><span class="n">half_size</span><span class="p">);</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">interquartile_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_span</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="cm">/* offset */</span><span class="w"> </span><span class="n">half_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">half_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id8">
<h4>大小编码<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h4>
<p>Span 序列的大小可以静态指定，也可以动态指定。（类似 C99 之后定义数组，数组大小可以是整数数字，也可以是整数变量）</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Span&lt;uint8_t,</span> <span class="pre">6&gt;</span></code>：6 个 <code class="docutils literal notranslate"><span class="pre">uint8_t</span></code> 数据序列的 Span 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Span&lt;uint8_t&gt;</span></code>：任意个 <code class="docutils literal notranslate"><span class="pre">uint8_t</span></code> 数据序列的 Span （大小动态确定）。</p></li>
</ul>
<p>当在类型本身中编码大小（静态指定）时，Span 视图可以保证是有效序列（不为 <code class="docutils literal notranslate"><span class="pre">empty()</span></code> 和 NULL），类型系统还可以防止对不同大小的 Span 进行自动转换。</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">long_span</span><span class="p">;</span><span class="w"></span>

<span class="c1">// illegal</span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">span_mac_address</span><span class="p">;</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">from_long_span</span><span class="p">(</span><span class="n">long_span</span><span class="p">);</span><span class="w"></span>

<span class="c1">// legal</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">mac_address</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">span_mac_address</span><span class="p">(</span><span class="n">mac_address</span><span class="p">);</span><span class="w"></span>
<span class="n">long_span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">span_mac_address</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="id9">
<h3>Span 例程<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006-2020 Arm Limited and affiliates.</span>
<span class="cm"> * SPDX-License-Identifier: Apache-2.0</span>
<span class="cm"> */</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mbed.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;platform/Span.h&quot;</span><span class="cp"></span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="w"></span>
<span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">range</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">&amp;</span><span class="n">separator</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">out_of_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">out_of_range</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">range</span><span class="p">[</span><span class="n">start</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">separator</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">start</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">ptrdiff_t</span><span class="w"> </span><span class="n">last</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">last</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="p">;</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">out_of_range</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">range</span><span class="p">[</span><span class="n">last</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">separator</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">.</span><span class="n">subspan</span><span class="p">(</span><span class="n">last</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer</span><span class="p">(</span><span class="s">&quot;Hello World! Hello mbed-os!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Span</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">&gt;</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">split</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;token: %.*s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">token</span><span class="p">.</span><span class="n">data</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>输出结果如下：</p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span><span class="nl">token</span><span class="p">:</span><span class="w"> </span><span class="n">Hello</span><span class="w"></span>
<span class="nl">token</span><span class="p">:</span><span class="w"> </span><span class="n">World</span><span class="o">!</span><span class="w"></span>
<span class="nl">token</span><span class="p">:</span><span class="w"> </span><span class="n">Hello</span><span class="w"></span>
<span class="nl">token</span><span class="p">:</span><span class="w"> </span><span class="n">mbed</span><span class="o">-</span><span class="n">os</span><span class="o">!</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../03_heart_rate_att_gatt/01_intruduce.html" class="btn btn-neutral float-left" title="3. GATT Service 定义总结" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../05_mbedos_example_ble_led/readme.html" class="btn btn-neutral float-right" title="5. mbed-os LEDDemo 介绍" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>