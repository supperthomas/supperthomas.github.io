<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2. 1 前言 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="7. 1 前言" href="AN02_RT-Thread_PM2.0_nRF52xx_Power_and_Clock.html" />
    <link rel="prev" title="1. 简单自我介绍" href="../01_introduce/01_intruduce.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02_Jackistang/index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">NORDIC:ForestRain</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">2. 1 前言</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">2.1. 1.1 准备工作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.1.1 所需硬件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">1.1.2 所需开发工具</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lorawan-class-a">3. 2 LoRaWAN Class A终端设备的低功耗设计</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lorawan-ed-stack">3.1. 2.1 lorawan-ed-stack低功耗处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lora-radio-driver">3.2. 2.2 lora-radio-driver低功耗处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-rtimer">3.3. 2.3 multi-rtimer低功耗处理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stm32l4">3.4. 2.4 STM32L4平台相关外设的低功耗处理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#stm32l4pm">2.4.1 增加STM32L4平台的PM所需硬件驱动</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">2.3.2 STM32L4低功耗相关的引脚配置</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">4. 3 LoRaWAN Class A终端设备的应用示例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pm">4.1. 2.1 使能PM组件</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#idle-thread-stack-size">2.1.1 设置 IDLE_THREAD_STACK_SIZE</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">4.2. 2.2 使能lorawan-ed-stack软件包</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">2.1.1 lora-radio-driver软件包</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">2.1.1 multi-rtimer软件包</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stm32cubemx">4.3. 2.3 STM32CubeMX设置</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#stm32l4lsertc">2.3.1 配置STM32L4的LSE与RTC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lptim1">2.3.2 配置LPTIM1</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id10">5. 4 功耗测试结果</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#otaa">5.1. 4.1 OTAA入网功耗测试</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lorawan">5.2. 4.2 LoRaWAN数据通信功耗测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id11">6. 5 参考</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN02_RT-Thread_PM2.0_nRF52xx_Power_and_Clock.html">7. 1 前言</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN02_RT-Thread_PM2.0_nRF52xx_Power_and_Clock.html#nrf52">8. 2 nRF52系列的低功耗相关硬件特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN02_RT-Thread_PM2.0_nRF52xx_Power_and_Clock.html#id4">9. 3 硬件电路的相关功耗设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN03_RT-Thread_PM2.0_nRF52xx_PM_Driver.html">10. 1 前言</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN03_RT-Thread_PM2.0_nRF52xx_PM_Driver.html#rt-thread-pm">11. 2 RT-Thread PM组件简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN03_RT-Thread_PM2.0_nRF52xx_PM_Driver.html#nrf52-pm">12. 3 nRF52系列 PM适配</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN03_RT-Thread_PM2.0_nRF52xx_PM_Driver.html#id11">13. 4 nRF52系列 PM使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="AN03_RT-Thread_PM2.0_nRF52xx_PM_Driver.html#id14">14. 5 测试示例</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">NORDIC:ForestRain</a></li>
      <li class="breadcrumb-item active"><span class="section-number">2. </span>1 前言</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/11_ForestRain/02_PM/AN01_RT-Thread_PM2.0_STM32L4_LoRaWAN_ClassA_Low_Power.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p><a name="7ecd5d253667fcb9971e90ecc29ec545"></a></p>
<p>基于RT-Thread PM2.0与STM32L4的LoRaWAN Class A低功耗终端设备设计与应用笔记</p>
<section id="id1">
<h1><span class="section-number">2. </span>1 前言<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<p>本文主要描述了基于LSD4RF-TEST2002[STM32L4]平台使用RT-Thread PM2.0组件与lorawan-ed-stack软件包，如何实现LoRaWAN Class A终端设备的低功耗功能。<br />本文主要侧重讲解LoRaWAN-ed-stack的低功耗实现，lorawan-ed-stack软件包的使用可详见 <a class="reference external" href="https://github.com/Forest-Rain/lorawan-ed-stack/tree/master/doc">《lorawan-ed-stack软件包使用说明》</a><br />[<img alt="lorawan-ed-stack软件包" src="../../_images/00.png" /></p>
<ul class="simple">
<li><p>lorawan-ed-stack软件包使用了lora-radio-driver软件包作为LoRaWAN的phy层，在使用lorawan-ed-stack软件包前，建议先查看<a class="reference external" href="https://github.com/Forest-Rain/lora-radio-driver/tree/master/doc">《LoRa-Radio-Driver软件包使用说明》</a></p></li>
</ul>
<p>RT-Thread PM2.0组件设计详见rt-thread官方作者非常详细的系列文章</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  - [实践：RT-Thread PM管理实战 系列](https://club.rt-thread.org/ask/article/2282.html)
  - [进阶：RT-Thread精通PM功耗调优 系列](https://club.rt-thread.org/ask/article/2296.html)
</pre></div>
</div>
<p><a name="49d1f1cb607a41846cb1f0f1244421de"></a></p>
<section id="id2">
<h2><span class="section-number">2.1. </span>1.1 准备工作<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p><a name="29331138ac20a0507b07b7db38bcc2a7"></a></p>
<section id="id3">
<h3>1.1.1 所需硬件<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p><a class="reference external" href="http://wsn.lierda.com/index.php/Home/product/detail/id/113.html">ART-Pi LoRa开发套件</a><img alt="ART-Pi 盒子整体图片1.png" src="../../_images/012.png" /></p>
<ul>
<li><p>LoRa模块转接板(LRS101)</p>
<ul>
<li><p>贴装 <a class="reference external" href="http://bbs.lierda.com/forum.php?mod=viewthread&amp;tid=87&amp;extra=page%3D1">LSD4RF-2R717N40 (SX1268,470M频段)</a>.</p></li>
</ul>
</li>
<li><p>RF评估板</p>
<ul>
<li><p><a class="reference external" href="http://bbs.lierda.com/forum.php?mod=viewthread&amp;tid=9729&amp;highlight=test2002&amp;_dsign=25cd8f70">LSD4RF-TEST2002[STM32L4]</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p>电流测试仪器</p>
<ul>
<li><p>STM32功耗测试工具 STM32CubeMonitor-Power 与 <a class="reference external" href="https://www.st.com/en/evaluation-tools/stm32l562e-dk.html"> STM32L562E-DK</a></p></li>
</ul>
</li>
</ul>
<p><img alt="image.png" src="../../_images/022.png" />
<a name="ad7eaede33b009b37944d0dd879a30ee"></a></p>
</section>
<section id="id4">
<h3>1.1.2 所需开发工具<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h3>
<ul class="simple">
<li><p>IDE开发工具</p>
<ul>
<li><p><a class="reference external" href="https://www.rt-thread.org/document/site/rtthread-studio/um/studio-user-begin/">RT-Thread Studio 最新版本</a>2.1.0</p>
<ul>
<li><p><a class="reference external" href="https://www.rt-thread.org/page/studio.html">https://www.rt-thread.org/page/studio.html</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p>JLink或者ST-Link
<a name="c581e69ea4684dfa712192b28c3c4d85"></a></p></li>
</ul>
</section>
</section>
</section>
<section id="lorawan-class-a">
<h1><span class="section-number">3. </span>2 LoRaWAN Class A终端设备的低功耗设计<a class="headerlink" href="#lorawan-class-a" title="此标题的永久链接"></a></h1>
<p>RT-Thread PM2.0组件的整体设计思想是PM组件让系统(MCU)尽可能多处于睡眠状态（最低功耗状态），用户业务需要干活的时候，用户主动请求系统【不睡眠】(rt_pm_module_request)，并且在事情处理完成后，主动释放(rt_pm_module_release)，【允许】系统睡眠。<br />基于RT-Thread PM2.0组件，LoRaWAN Class A低功耗设计这里涉及到三个软件包lorawan-ed-stack、lora-radio-driver、multi-rtimer，具体如下所示</p>
<blockquote>
<div><p>注: 如果使用RT-Studio 2.1.0版本创建项目，在其生成的工程模板中，pm.c、pm.h非最新PM2.0版本代码，需要更新为RT-Thread master 的pm.c、pm.h（PM2.0版本）</p>
</div></blockquote>
<p><a name="FBNs3"></a></p>
<section id="lorawan-ed-stack">
<h2><span class="section-number">3.1. </span>2.1 lorawan-ed-stack低功耗处理<a class="headerlink" href="#lorawan-ed-stack" title="此标题的永久链接"></a></h2>
<p>LoRaWAN 应用层低功耗处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">  * @brief  lorawan_ed_app_thread_entry</span>
<span class="cm">  * @param  void * parameter</span>
<span class="cm">  * @retval None</span>
<span class="cm">  */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">lorawan_ed_app_thread_entry</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">parameter</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">ev</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="n">LORAWAN_ED_DEBUG_LOG</span><span class="p">(</span><span class="n">LORAWAN_ED_STACK_DEBUG_SHELL_TEST</span><span class="p">,</span><span class="w"> </span><span class="n">LOG_LVL_INFO</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LORAMAC_VERSION: %02X.%02X.%02X.%02X&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">__LORA_MAC_VERSION</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">__LORA_MAC_VERSION</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)(</span><span class="n">__LORA_MAC_VERSION</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">__LORA_MAC_VERSION</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span>
<span class="w">    </span><span class="n">rt_event_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev_lorawan_apl</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ev_lorawan_apl&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">RT_IPC_FLAG_PRIO</span><span class="p">);</span><span class="c1">//RT_IPC_FLAG_FIFO);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">auto_periodic_tx_enable</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* start to join after powerup */</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_event_send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev_lorawan_apl</span><span class="p">,</span><span class="w"> </span><span class="n">EV_LORAWAN_APL_START_JOIN_NETWORK</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rt_event_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev_lorawan_apl</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">EV_LORAWAN_APL_START_JOIN_NETWORK</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                                            </span><span class="n">EV_LORAWAN_APL_REJOIN_NETWORK</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="w">                                            </span><span class="n">EV_LORAWAN_APL_PERIODIC_TX_DATA</span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="p">(</span><span class="w"> </span><span class="n">RT_EVENT_FLAG_OR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RT_EVENT_FLAG_CLEAR</span><span class="w"> </span><span class="p">),</span><span class="w"></span>
<span class="w">                                            </span><span class="n">RT_WAITING_FOREVER</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RT_EOK</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>

<span class="cp">#ifdef RT_USING_PM</span>
<span class="w">            </span><span class="n">rt_pm_module_request</span><span class="p">(</span><span class="n">PM_LORA_APP_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">lorawan_ed_app_process</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">rt_pm_module_release</span><span class="p">(</span><span class="n">PM_LORA_APP_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">lorawan_ed_app_process</span><span class="p">(</span><span class="n">ev</span><span class="p">);</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>LoRaWAN mac层低功耗处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">LoRaMac</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">loramac_thread_entry</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">parameter</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">ev</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rt_event_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">loramac_event</span><span class="p">,</span><span class="w"> </span><span class="n">EV_LORAMAC_PROCESS_NOTIFY</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">RT_EVENT_FLAG_OR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RT_EVENT_FLAG_CLEAR</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">RT_WAITING_FOREVER</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RT_EOK</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="cp">#ifdef RT_USING_PM</span>
<span class="w">            </span><span class="n">rt_pm_module_request</span><span class="p">(</span><span class="n">PM_MAC_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">LoRaMacProcess</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">rt_pm_module_release</span><span class="p">(</span><span class="n">PM_MAC_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">LoRaMacProcess</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a name="I7ajN"></a></p>
</section>
<section id="lora-radio-driver">
<h2><span class="section-number">3.2. </span>2.2 lora-radio-driver低功耗处理<a class="headerlink" href="#lora-radio-driver" title="此标题的永久链接"></a></h2>
<p>lora-radio低功耗处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">lora</span><span class="o">-</span><span class="n">radio</span><span class="o">-</span><span class="n">sx126x</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">lora_radio_thread_entry</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">parameter</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_uint32_t</span><span class="w"> </span><span class="n">ev</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rt_event_recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lora_radio_event</span><span class="p">,</span><span class="w"> </span><span class="n">EV_LORA_RADIO_DIO_IRQ_FIRED</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">RT_EVENT_FLAG_OR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">RT_EVENT_FLAG_CLEAR</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">RT_WAITING_FOREVER</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ev</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RT_EOK</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="cp">#ifdef RT_USING_PM</span>
<span class="w">            </span><span class="n">rt_pm_module_request</span><span class="p">(</span><span class="n">PM_RADIO_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">RadioIrqProcess</span><span class="p">();</span><span class="w"></span>
<span class="w">            </span><span class="n">rt_pm_module_release</span><span class="p">(</span><span class="n">PM_RADIO_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">            </span><span class="n">RadioIrqProcess</span><span class="p">();</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a name="st1Rt"></a></p>
</section>
<section id="multi-rtimer">
<h2><span class="section-number">3.3. </span>2.3 multi-rtimer低功耗处理<a class="headerlink" href="#multi-rtimer" title="此标题的永久链接"></a></h2>
<p>multi-rtimer RTC驱动层低功耗处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">hw_rtc_stm32</span><span class="p">.</span><span class="n">c</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">rtc_set_alarm</span><span class="p">(</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// We don&#39;t go in Low Power mode for timeout below MIN_ALARM_DELAY</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">MIN_ALARM_DELAY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">McuWakeUpTimeCal</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kt">int64_t</span><span class="w"> </span><span class="p">)(</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rtc_get_timer_elapsed_time</span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_pm_module_release</span><span class="p">(</span><span class="n">PM_BOARD_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">rt_pm_module_request</span><span class="p">(</span><span class="n">PM_BOARD_ID</span><span class="p">,</span><span class="w"> </span><span class="n">PM_SLEEP_MODE_NONE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">rtc_start_alarm</span><span class="p">(</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a name="iMDLx"></a></p>
</section>
<section id="stm32l4">
<h2><span class="section-number">3.4. </span>2.4 STM32L4平台相关外设的低功耗处理<a class="headerlink" href="#stm32l4" title="此标题的永久链接"></a></h2>
<p>LoRaWAN Class A低功耗终端设备（<a class="reference external" href="http://bbs.lierda.com/forum.php?mod=viewthread&amp;tid=9729&amp;highlight=test2002&amp;_dsign=25cd8f70">LSD4RF-TEST2002</a>[STM32L4] ）当前主要使用了STM32L4 SPI3（LoRa模块使用）、Usart2（日志输出）、RTC(LoRaWAN\LoRa使用)、低频晶振(LSE)、激活模式\STOP 2模式
<a name="UgeqQ"></a></p>
<section id="stm32l4pm">
<h3>2.4.1 增加STM32L4平台的PM所需硬件驱动<a class="headerlink" href="#stm32l4pm" title="此标题的永久链接"></a></h3>
<p>基于STM32L4平台的PM2.0硬件驱动主要使用到了 drv_pm.c 、drv_lptim.c、drv_lptim.h、drv_clk.c。</p>
<blockquote>
<div><p>注:  如果使用RT-Studio 2.1.0版本创建项目，在其生成的工程模板中，未包含drv_pm.c 、drv_lptim.c、drv_lptim.h，可以直接从RT-Thread master\bsp\stm32\libraries\HAL_Drivers拷贝过来</p>
</div></blockquote>
<ol class="simple">
<li><p>在RT-Studio 2.1.0生成的 drv_common.h 中，增加&lt;rtdevice.h&gt;头文件</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*drv_common.h*/</span><span class="w"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rtdevice.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>drv_clk.c根据需求增加不同系统时钟频率设置等</p></li>
<li><p>drv_pm.c</p></li>
</ol>
<p>3.1 新增进入Deep Sleep前，调用pm_deep_sleep_deinit()</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">__WEAK</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">pm_deep_sleep_deinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SPI_HandleTypeDef</span><span class="w"> </span><span class="n">hspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SPI3</span><span class="p">};</span><span class="w">      </span><span class="c1">// LoRa Radio SPI</span>
<span class="w">    </span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="n">huart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USART2</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// Shell UART</span>

<span class="w">    </span><span class="n">HAL_SPI_MspDeInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hspi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">HAL_UART_MspDeInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">SX126xIoDeInit</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">rt_pm_disable_dbgmcu</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>3.2 新增退出Deep Sleep后，首先调用pm_deep_sleep_reinit()</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">__WEAK</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">pm_deep_sleep_reinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SPI_HandleTypeDef</span><span class="w"> </span><span class="n">hspi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SPI3</span><span class="p">};</span><span class="w">      </span><span class="c1">// LoRa Radio SPI</span>
<span class="w">    </span><span class="n">UART_HandleTypeDef</span><span class="w"> </span><span class="n">huart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{.</span><span class="n">Instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USART2</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// Shell UART</span>

<span class="w">    </span><span class="n">HAL_SPI_MspInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hspi</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">HAL_UART_MspInit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">huart</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * This function will put STM32L4xx into sleep mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pm pointer to power manage structure</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sleep</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rt_pm</span><span class="w"> </span><span class="o">*</span><span class="n">pm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">mode</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PM_SLEEP_MODE_DEEP</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="n">pm_deep_sleep_deinit</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* Enter STOP 2 mode  */</span><span class="w"></span>
<span class="w">        </span><span class="n">HAL_PWREx_EnterSTOP2Mode</span><span class="p">(</span><span class="n">PWR_STOPENTRY_WFI</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Re-configure the system clock */</span><span class="w"></span>
<span class="w">        </span><span class="n">SystemClock_ReConfig</span><span class="p">(</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">run_mode</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="n">pm_deep_sleep_reinit</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a name="W7k7n"></a></p>
</section>
<section id="id5">
<h3>2.3.2 STM32L4低功耗相关的引脚配置<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>这里采用STM32CubeMX自动生成的文件(HAL_UART_MspDeInit\HAL_UART_MspReInit)，然后根据实际所需硬件设计最优的GPIO配置。<br />串口HAL_UART_MspDeInit处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/**</span>
<span class="cm">* @brief UART MSP De-Initialization</span>
<span class="cm">* This function freeze the hardware resources used in this example</span>
<span class="cm">* @param huart: UART handle pointer</span>
<span class="cm">* @retval None</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">HAL_UART_MspDeInit</span><span class="p">(</span><span class="n">UART_HandleTypeDef</span><span class="o">*</span><span class="w"> </span><span class="n">huart</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">huart</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="o">==</span><span class="n">USART2</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* USER CODE BEGIN USART2_MspDeInit 0 */</span><span class="w"></span>

<span class="w">  </span><span class="cm">/* USER CODE END USART2_MspDeInit 0 */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Peripheral clock disable */</span><span class="w"></span>
<span class="w">    </span><span class="n">__HAL_RCC_USART2_CLK_DISABLE</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**USART2 GPIO Configuration</span>
<span class="cm">    PA2     ------&gt; USART2_TX</span>
<span class="cm">    PA3     ------&gt; USART2_RX</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">HAL_GPIO_DeInit</span><span class="p">(</span><span class="n">GPIOA</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_2</span><span class="o">|</span><span class="n">GPIO_PIN_3</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="cm">/* USER CODE BEGIN USART2_MspDeInit 1 */</span><span class="w"></span>

<span class="w">  </span><span class="cm">/* USER CODE END USART2_MspDeInit 1 */</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>SPI外设HAL_SPI_MspDeInit处理如下</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/**</span>
<span class="cm">* @brief SPI MSP De-Initialization</span>
<span class="cm">* This function freeze the hardware resources used in this example</span>
<span class="cm">* @param hspi: SPI handle pointer</span>
<span class="cm">* @retval None</span>
<span class="cm">*/</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="nf">HAL_SPI_MspDeInit</span><span class="p">(</span><span class="n">SPI_HandleTypeDef</span><span class="o">*</span><span class="w"> </span><span class="n">hspi</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">hspi</span><span class="o">-&gt;</span><span class="n">Instance</span><span class="o">==</span><span class="n">SPI3</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* USER CODE BEGIN SPI3_MspDeInit 0 */</span><span class="w"></span>

<span class="w">  </span><span class="cm">/* USER CODE END SPI3_MspDeInit 0 */</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* Peripheral clock disable */</span><span class="w"></span>
<span class="w">    </span><span class="n">__HAL_RCC_SPI3_CLK_DISABLE</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="cm">/**SPI3 GPIO Configuration</span>
<span class="cm">    PC10     ------&gt; SPI3_SCK</span>
<span class="cm">    PC11     ------&gt; SPI3_MISO</span>
<span class="cm">    PC12     ------&gt; SPI3_MOSI</span>
<span class="cm">    */</span><span class="w"></span>
<span class="w">    </span><span class="n">HAL_GPIO_DeInit</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_PIN_10</span><span class="o">|</span><span class="n">GPIO_PIN_11</span><span class="o">|</span><span class="n">GPIO_PIN_12</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="cm">/* USER CODE BEGIN SPI3_MspDeInit 1 */</span><span class="w"></span>
<span class="w">    </span><span class="n">GPIO_InitTypeDef</span><span class="w"> </span><span class="n">GPIO_InitStruct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PIN_11</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_MODE_OUTPUT_PP</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Pull</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_PULLDOWN</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GPIO_InitStruct</span><span class="p">.</span><span class="n">Speed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_SPEED_FREQ_LOW</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">HAL_GPIO_Init</span><span class="p">(</span><span class="n">GPIOC</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">GPIO_InitStruct</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="cm">/* USER CODE END SPI3_MspDeInit 1 */</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p><a name="B3iTz"></a></p>
</section>
</section>
</section>
<section id="id6">
<h1><span class="section-number">4. </span>3 LoRaWAN Class A终端设备的应用示例<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h1>
<p><a name="Uh6OP"></a></p>
<section id="pm">
<h2><span class="section-number">4.1. </span>2.1 使能PM组件<a class="headerlink" href="#pm" title="此标题的永久链接"></a></h2>
<ol class="simple">
<li><p>在”RT-Thread Settings”使能”低功耗”</p></li>
</ol>
<p>或者”RT-Thread Components” -&gt; “ Device Drivers” -&gt; “USing Power Management device drivers”使能PM组件。<br /><img alt="image.png" src="../../_images/032.png" />
<a name="tyRlW"></a></p>
<section id="idle-thread-stack-size">
<h3>2.1.1 设置 IDLE_THREAD_STACK_SIZE<a class="headerlink" href="#idle-thread-stack-size" title="此标题的永久链接"></a></h3>
<p>使用PM组件，要求IDLE_THREAD_STACK_SIZE大于256 Byte<br /><img alt="image.png" src="../../_images/042.png" /><br /></p>
<p><a name="7dbfb25a1c0eb6f5594e0b9849fc80a2"></a></p>
</section>
</section>
<section id="id7">
<h2><span class="section-number">4.2. </span>2.2 使能lorawan-ed-stack软件包<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
<p>使能lorawan-ed-stack软件包，根据接入的LoRaWAN网络，配置lorawan-ed-stack协议栈的相关参数。<br />详细查看</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Forest-Rain/lorawan-ed-stack/tree/master/doc">《lorawan-ed-stack软件包使用说明》</a></p>
<ul>
<li><p><a class="reference external" href="https://github.com/Forest-Rain/lorawan-ed-stack/tree/master/doc">https://github.com/Forest-Rain/lorawan-ed-stack/tree/master/doc</a></p></li>
</ul>
</li>
<li><p>基于ART-Pi与LRS007的LoRaWAN_ED_Stack软件包应用笔记</p>
<ul>
<li><p><a class="reference external" href="https://club.rt-thread.org/ask/article/2541.html">https://club.rt-thread.org/ask/article/2541.html</a></p></li>
</ul>
</li>
</ul>
<p><img alt="image.png" src="../../_images/052.png" /></p>
<blockquote>
<div><ul class="simple">
<li><p>Regional参数</p>
<ul>
<li><p>CN470同频</p>
<ul>
<li><p>上行=下行(RX1)</p>
<ul>
<li><p>475.3、475.5、475.7、475.9、476.1、476.3、476.5、476.7</p></li>
</ul>
</li>
</ul>
</li>
<li><p>或者CN470(异频)</p>
<ul>
<li><p>上行</p>
<ul>
<li><p>475.1、475.3、475.5、475.7、475.9、476.1、476.3、476.5</p></li>
</ul>
</li>
<li><p>下行（RX1）</p>
<ul>
<li><p>505.1、505.3、505.5、505.7、505.9、505.1、505.3、505.5</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<p><a name="xWzAM"></a></p>
<section id="id8">
<h3>2.1.1 lora-radio-driver软件包<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h3>
<p>使能lorawan-ed-stack软件包，会自动使能lora-radio-driver软件包。然后根据实际使用的LoRa模块，配置lora-radio-driver参数。<br />具体参考</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Forest-Rain/lora-radio-driver/tree/master/doc">《LoRa-Radio-Driver软件包使用说明》</a></p>
<ul>
<li><p><a class="reference external" href="https://github.com/Forest-Rain/lora-radio-driver/tree/master/doc">https://github.com/Forest-Rain/lora-radio-driver/tree/master/doc</a></p></li>
</ul>
</li>
<li><p>基于APT-Pi与LRS007的LoRa-Radio-Driver软件包应用笔记</p>
<ul>
<li><p><a class="reference external" href="https://club.rt-thread.org/ask/article/2540.html">https://club.rt-thread.org/ask/article/2540.html</a>
<a name="y4KMs"></a></p></li>
</ul>
</li>
</ul>
</section>
<section id="id9">
<h3>2.1.1 multi-rtimer软件包<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<p>LoRaWAN Class A低功耗应用需要使用低功耗的定时器外设，当前定时服务使用的是multi-rtimer软件包，其依赖的是STM32硬件RTC。<br />具体参考 <a class="reference external" href="multi-rtimer%E8%BD%AF%E4%BB%B6%E5%8C%85">multi-rtimer软件包</a></p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Forest-Rain/multi-rtimer">https://github.com/Forest-Rain/multi-rtimer</a></p></li>
</ul>
<p><img alt="image.png" src="../../_images/062.png" />
<a name="jSusT"></a></p>
</section>
</section>
<section id="stm32cubemx">
<h2><span class="section-number">4.3. </span>2.3 STM32CubeMX设置<a class="headerlink" href="#stm32cubemx" title="此标题的永久链接"></a></h2>
<p><a name="L7J24"></a></p>
<section id="stm32l4lsertc">
<h3>2.3.1 配置STM32L4的LSE与RTC<a class="headerlink" href="#stm32l4lsertc" title="此标题的永久链接"></a></h3>
<p>multi_rtimer软件包使用硬件RTC，同时为了获取更高时间精度，以满足Class A设备通信要求，需要使用低频晶振（LSE）。<br /><img alt="image.png" src="../../_images/072.png" /><br />RCC使能LSE<br />
<br /><img alt="image.png" src="../../_images/082.png" /><br />使能RTC<br /><img alt="image.png" src="../../_images/092.png" /><br />RTC时钟源设置为LSE<br />
<br /></p>
<p><a name="S3bsD"></a></p>
</section>
<section id="lptim1">
<h3>2.3.2 配置LPTIM1<a class="headerlink" href="#lptim1" title="此标题的永久链接"></a></h3>
<p>STM32L4平台，RT-Thread PM2.0组件使用了LPTIM1来提供Tickless机制。<br />注：当前在drv_lptim.c驱动里面已经默认实现LPTIM1的开启，因此此处也可以忽略该步骤。<br /><img alt="image.png" src="../../_images/103.png" /><br />使能LPTIM1<br /><img alt="image.png" src="../../_images/112.png" /><br />LPTIM1时钟源设置为LSE，也可以设置来自LSI
<a name="653cd9386c7cf2182df9bf919ad54b34"></a></p>
</section>
</section>
</section>
<section id="id10">
<h1><span class="section-number">5. </span>4 功耗测试结果<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h1>
<p>将<a class="reference external" href="https://www.st.com/en/evaluation-tools/stm32l562e-dk.html"> STM32L562E-DK</a>的JP7接口连接到测试 <a class="reference external" href="http://bbs.lierda.com/forum.php?mod=viewthread&amp;tid=9729&amp;highlight=test2002&amp;_dsign=25cd8f70">LSD4RF-TEST2002[STM32L4]</a> 的J2接口,如下图所示<br /><img alt="image.png" src="../../_images/121.png" /><br />搭建LSD4RF-TEST2002[STM32L4]功耗测试台
<a name="4f90dc611266d89dd229ef894d7f04c4"></a></p>
<section id="otaa">
<h2><span class="section-number">5.1. </span>4.1 OTAA入网功耗测试<a class="headerlink" href="#otaa" title="此标题的永久链接"></a></h2>
<ol class="simple">
<li><p>设备上电后，随机延时后，开始入网</p></li>
</ol>
<p><img alt="image.png" src="../../_images/13-0.png" /><br /><img alt="image.png" src="../../_images/131.png" /><br />设备OTAA入网<br /></p>
<p><a name="e6606b661533640deb8b05f3cc0f28f6"></a></p>
</section>
<section id="lorawan">
<h2><span class="section-number">5.2. </span>4.2 LoRaWAN数据通信功耗测试<a class="headerlink" href="#lorawan" title="此标题的永久链接"></a></h2>
<p>LoRaWAN数据通信，无下行数据情况</p>
<p><img alt="image.png" src="../../_images/141.png" />)</p>
<br />
<br />![image.png](./AN01_images/15.png))<br />周期性Class A数据上报(无下行数据)<br />![image.png](./AN01_images/16.png))单次Class A数据通信功耗曲线(无下行数据)<br /><p>LoRaWAN数据通信，有下行数据情况</p>
<p><img alt="image.png" src="../../_images/171.png" />)<br /><img alt="image.png" src="../../_images/181.png" />)<br />单次Class A数据通信功耗曲线(有下行数据）
<a name="22272bb76042704254d56c620e312fcb"></a></p>
</section>
</section>
<section id="id11">
<h1><span class="section-number">6. </span>5 参考<a class="headerlink" href="#id11" title="此标题的永久链接"></a></h1>
<ul class="simple">
<li><p>RT-Thread操作系统</p>
<ul>
<li><p><a class="reference external" href="https://github.com/RT-Thread/rt-thread">https://github.com/RT-Thread/rt-thread</a></p></li>
</ul>
</li>
<li><p>lora-radio-driver软件包</p>
<ul>
<li><p>lora spi驱动</p></li>
<li><p><a class="reference external" href="https://github.com/forest-rain/lora-radio-driver">https://github.com/forest-rain/lora-radio-driver</a></p></li>
</ul>
</li>
<li><p>multi-rtimer软件包</p>
<ul>
<li><p>低功耗RTC定时模块</p></li>
<li><p><a class="reference external" href="https://github.com/Forest-Rain/multi-rtimer">https://github.com/Forest-Rain/multi-rtimer</a></p></li>
</ul>
</li>
<li><p>lorawan-ed-stack软件包</p>
<ul>
<li><p>lorawan终端设备协议栈</p></li>
<li><p><a class="reference external" href="https://github.com/Forest-Rain/lorawan-ed-stack">https://github.com/Forest-Rain/lorawan-ed-stack</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://mp.weixin.qq.com/s/v_0raF-5KlEOjxc5_dui3Q">ART-Pi LoRa开发套件</a> 产品介绍</p>
<ul>
<li><p><a class="reference external" href="http://wsn.lierda.com/index.php/Home/product/detail/id/113.html">http://wsn.lierda.com/index.php/Home/product/detail/id/113.html</a></p></li>
</ul>
</li>
<li><p>基于ART-Pi与LRS007的LoRaWAN_ED_Stack软件包应用笔记</p>
<ul>
<li><p><a class="reference external" href="https://club.rt-thread.org/ask/article/2541.html">https://club.rt-thread.org/ask/article/2541.html</a></p></li>
</ul>
</li>
<li><p>基于APT-Pi与LRS007的LoRa-Radio-Driver软件包应用笔记</p>
<ul>
<li><p><a class="reference external" href="https://club.rt-thread.org/ask/article/2540.html">https://club.rt-thread.org/ask/article/2540.html</a></p></li>
</ul>
</li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../01_introduce/01_intruduce.html" class="btn btn-neutral float-left" title="1. 简单自我介绍" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="AN02_RT-Thread_PM2.0_nRF52xx_Power_and_Clock.html" class="btn btn-neutral float-right" title="7. 1 前言" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>