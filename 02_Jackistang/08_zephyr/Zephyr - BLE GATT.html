<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zephyr - GATT &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Zephyr - GATT</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/02_Jackistang/08_zephyr/Zephyr - BLE GATT.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="zephyr-gatt">
<h1>Zephyr - GATT<a class="headerlink" href="#zephyr-gatt" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2>发现过程<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_gatt_discover</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"></span>
<span class="w">		     </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_discover_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Zephye BLE 里 GATT 发现过程的接口为 <code class="docutils literal notranslate"><span class="pre">bt_gatt_discover</span></code>，BLE 客户端使用该函数发现服务端上的属性。第一个参数 <code class="docutils literal notranslate"><span class="pre">conn</span></code> 为连接的句柄，我们一般不直接读写它，而是由协议栈完成；重点需要关注的是第二个参数 <code class="docutils literal notranslate"><span class="pre">param</span></code> ，它决定了发现的内容是什么：服务（Service）、包含服务（Include Service）、特征（Characteristic）还是特征描述符（Characteristic Descriptor）。返回 0 表示成功，其他值表示失败。</p>
<p>该函数是异步的，因此参数 <code class="docutils literal notranslate"><span class="pre">param</span></code> 需要一直保持有效，最好为全局变量。</p>
<section id="bt-gatt-discover-params">
<h3>bt_gatt_discover_params<a class="headerlink" href="#bt-gatt-discover-params" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_discover_params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Discover UUID type */</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_uuid</span><span class="w"> </span><span class="o">*</span><span class="n">uuid</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Discover attribute callback */</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_gatt_discover_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Include service attribute declaration handle */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">attr_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Included service start handle */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">start_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Included service end handle */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">end_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="n">_included</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="cm">/** Discover start handle */</span><span class="w"></span>
<span class="w">		</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">start_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Discover end handle */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">end_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Discover type */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if defined(CONFIG_BT_GATT_AUTO_DISCOVER_CCC)</span>
<span class="w">	</span><span class="cm">/** Only for stack-internal use, used for automatic discovery. */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_subscribe_params</span><span class="w"> </span><span class="o">*</span><span class="n">sub_params</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_BT_GATT_AUTO_DISCOVER_CCC) */</span><span class="cp"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>以下列举常用的参数：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">uuid</span></code>：指向要发现的 UUID ，<code class="docutils literal notranslate"><span class="pre">bt_uuid</span></code> 结构体使用了面向对象的封装手法，在最后有介绍。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">start_hanlde</span></code>：发现的起始 handle，参考 ATT 协议。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stop_handle</span></code>：发现的结束 handle。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>：发现类型，一共有六种，根据想要发现的内容自行填充。</p></li>
</ul>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_PRIMARY</span><span class="p">,</span><span class="w">		</span><span class="c1">// 发现主要服务（常用）</span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_SECONDARY</span><span class="p">,</span><span class="w">		</span><span class="c1">// 发现次要服务</span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_INCLUDE</span><span class="p">,</span><span class="w">       </span><span class="c1">// 发现包含服务</span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_CHARACTERISTIC</span><span class="p">,</span><span class="c1">// 发现特征（常用）</span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_DESCRIPTOR</span><span class="p">,</span><span class="w">	</span><span class="c1">// 发现特征描述符（常用）</span>
<span class="w">	</span><span class="n">BT_GATT_DISCOVER_ATTRIBUTE</span><span class="p">,</span><span class="w">		</span><span class="c1">// 发现属性</span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code>：回调函数，找到发现的内容时会回调该函数，后面会有详细介绍。</p></li>
</ul>
<p>其中 <code class="docutils literal notranslate"><span class="pre">type</span></code> 字段还影响到了发现函数 <code class="docutils literal notranslate"><span class="pre">bt_gatt_discover</span></code> 的行为：</p>
<ul class="simple">
<li><p>发现主要服务：函数会根据 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> 查找特定的主要服务。</p></li>
<li><p>发现包含服务：函数会在 $[start_handle, end_handle]$ 里查找所有的包含服务。</p></li>
<li><p>发现特性：函数会在 $[start_handle, end_handle]$ 里查找所有的特征，同时也会根据 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> 查找特定的特征。</p></li>
<li><p>发现特征描述符：函数会在 $[start_handle, end_handle]$ 里查找所有的特征描述符。</p></li>
</ul>
</section>
<section id="bt-gatt-discover-func-t">
<h3>bt_gatt_discover_func_t<a class="headerlink" href="#bt-gatt-discover-func-t" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bt_gatt_discover_func_t</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span><span class="w"></span>
<span class="w">					</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_discover_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>该函数类型就是上述 <code class="docutils literal notranslate"><span class="pre">bt_gatt_discover_params</span></code> 里回调函数 <code class="docutils literal notranslate"><span class="pre">func</span></code> 的类型，当发现过程中找到了相应的属性会回调该函数。</p>
<ul class="simple">
<li><p><strong>参数</strong>：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">conn</span></code>：连接句柄。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">attr</span></code>：发现的属性，如果未找到则为 NULL。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>：发现过程参数，也就是 <code class="docutils literal notranslate"><span class="pre">bt_gatt_discover</span></code> 函数里传入的参数。</p></li>
</ul>
</li>
<li><p><strong>返回值</strong>：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">BT_GATT_ITER_CONTINUE</span></code>：继续发现过程。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BT_GATT_ITER_STOP</span></code>：停止发现过程。</p></li>
</ul>
</li>
</ul>
<p>该回调函数的使用方法大致如下：</p>
<p>![](./images/gatt discovery.png)</p>
<p>一般一个 <code class="docutils literal notranslate"><span class="pre">bt_gatt_discover_func_t</span></code> 用于处理一个服务端所有需要发现的服务，特征以及描述符，当找到所有需要的属性或者传入的 attr 为 NULL 时，代表需要结束发现过程了，此时返回 BT_GATT_ITER_STOP 结束发现过程。可以参考例程：samples/bluetooth/central_ht 。</p>
<p>现在来看看传入的 <code class="docutils literal notranslate"><span class="pre">bt_gatt_attr</span></code> 这个结构体，</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_attr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_uuid</span><span class="w"> </span><span class="o">*</span><span class="n">uuid</span><span class="p">;</span><span class="w"></span>

<span class="w">	</span><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">offset</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="kt">ssize_t</span><span class="w">	</span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_attr</span><span class="w"> </span><span class="o">*</span><span class="n">attr</span><span class="p">,</span><span class="w"></span>
<span class="w">			 </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"></span>
<span class="w">			 </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span>
<span class="w">	</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">perm</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">uuid</span></code>：属性的 UUID 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">handle</span></code>：属性 handle 。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">perm</span></code>：属性的权限。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">user_data</span></code>：用户数据。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read</span></code>：属性读回调函数（使用未知）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">write</span></code>：属性写回调函数（使用未知）。</p></li>
</ul>
<p>一般在发现过程中需要保持属性 handle 值，以便后续读写。</p>
</section>
</section>
<section id="id2">
<h2>读属性过程<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_gatt_read</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_read_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Zephyr BLE 协议栈里读属性值使用的接口为 <code class="docutils literal notranslate"><span class="pre">bt_gatt_read</span></code>，该函数可以同时处理</p>
<ul class="simple">
<li><p>读属性值</p></li>
<li><p>读长属性值（属性值大小大于 ATT_MTU-1）</p></li>
<li><p>一次读取多个属性</p></li>
</ul>
<p>的情况，其中 <code class="docutils literal notranslate"><span class="pre">conn</span></code> 为建立的连接，<code class="docutils literal notranslate"><span class="pre">param</span></code> 为读取时传入的参数。该函数是异步的，读取到属性值后会调用传入回调函数，因此需保持 param 一直有效。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_read_params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Read attribute callback. */</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_gatt_read_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** If equals to 1 single.handle and single.offset are used.</span>
<span class="cm">	 *  If &gt;1 Read Multiple Characteristic Values is performed and handles</span>
<span class="cm">	 *  are used.</span>
<span class="cm">	 *  If equals to 0 by_uuid is used for Read Using Characteristic UUID.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">handle_count</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Attribute handle. */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Attribute data offset. */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="n">single</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="cm">/** Handles to read in Read Multiple Characteristic Values. */</span><span class="w"></span>
<span class="w">		</span><span class="kt">uint16_t</span><span class="w"> </span><span class="o">*</span><span class="n">handles</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** First requested handle number. */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">start_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** Last requested handle number. */</span><span class="w"></span>
<span class="w">			</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">end_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">			</span><span class="cm">/** 2 or 16 octet UUID. */</span><span class="w"></span>
<span class="w">			</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_uuid</span><span class="w"> </span><span class="o">*</span><span class="n">uuid</span><span class="p">;</span><span class="w"></span>
<span class="w">		</span><span class="p">}</span><span class="w"> </span><span class="n">by_uuid</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="p">};</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">func</span></code>：回调函数，读取到属性值时会回调该函数，可能会多次回调。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">handle_count</span></code>：该参数决定了使用之后 union 结构体的哪一个字段。</p>
<ul>
<li><p>= 0 ：<code class="docutils literal notranslate"><span class="pre">by_uuid</span></code> 会被使用，在 $[start_handle, end_handle]$ 之间读取特征 UUID 为 <code class="docutils literal notranslate"><span class="pre">uuid</span></code> 的特性值。</p></li>
<li><p>= 1 ：<code class="docutils literal notranslate"><span class="pre">single</span></code> 会被使用，用于读取长属性。</p></li>
<li><p>&gt; 1 ：<code class="docutils literal notranslate"><span class="pre">handles</span></code> 会被使用，用于一次读取多个属性。</p></li>
</ul>
</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">by_uuid</span></code> 使用的较多，读取特征值都会使用它。</p>
<p>再来看看 <code class="docutils literal notranslate"><span class="pre">bt_gatt_read_func_t</span></code> 这个回调函数类型，</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bt_gatt_read_func_t</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">err</span><span class="p">,</span><span class="w"></span>
<span class="w">				    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_read_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">,</span><span class="w"></span>
<span class="w">				    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">length</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>该函数有两种返回值：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BT_GATT_ITER_CONTINUE</span></code>：继续尝试读取下一个属性值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BT_GATT_ITER_STOP</span></code>：停止读取属性的过程。</p></li>
</ul>
<p>其传入的参数有：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">conn</span></code>：连接句柄。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">err</span></code>：ATT 错误码，相关描述可以在 att.h 文件里找到，也可以在 Core Spec 里找到</p></li>
</ul>
<blockquote>
<div><p>Core_v5.2 - Vol 3: Host - Part F: Attribute Protocol (ATT)</p>
<p>3 Protocol requirements - 3.4 Attribute protocol PDUs - Error handling</p>
</div></blockquote>
<p>这里列举了常用的 ATT 错误码。</p>
<p><img alt="../../_images/image-20210204152958285.png" src="../../_images/image-20210204152958285.png" /></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">params</span></code>：之前定义的参数。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code>：读取到的属性值缓冲区（为 NULL 代表属性读取完成）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">length</span></code>：属性值缓冲区大小。</p></li>
</ul>
</section>
<section id="id3">
<h2>写属性过程<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_gatt_write</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_write_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>套路跟发现过程和读属性过程一样，</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">bt_gatt_write_func_t</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">err</span><span class="p">,</span><span class="w"></span>
<span class="w">				     </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_write_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="cm">/** @brief GATT Write parameters */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_write_params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Response callback */</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_gatt_write_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Attribute handle */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Attribute data offset */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Data to be written */</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Length of the data */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>这里的 <code class="docutils literal notranslate"><span class="pre">params</span></code> 里的参数意义是：向服务端 <code class="docutils literal notranslate"><span class="pre">handle</span></code> 处的属性值的偏移 <code class="docutils literal notranslate"><span class="pre">offset</span></code> 处写入输入 <code class="docutils literal notranslate"><span class="pre">data</span></code>，长度为 <code class="docutils literal notranslate"><span class="pre">length</span></code> 。</p>
</section>
<section id="id4">
<h2>通知指示过程<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_gatt_subscribe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"></span>
<span class="w">		      </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_subscribe_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">bt_gatt_unsubscribe</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_conn</span><span class="w"> </span><span class="o">*</span><span class="n">conn</span><span class="p">,</span><span class="w"></span>
<span class="w">			</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_subscribe_params</span><span class="w"> </span><span class="o">*</span><span class="n">params</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bt_gatt_subscribe</span></code> 用于订阅一个通知或指示（Notify or Indication）。<code class="docutils literal notranslate"><span class="pre">bt_gatt_unsubcribe</span></code> 用于取消订阅。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_subscribe_params</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Notification value callback */</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_gatt_notify_func_t</span><span class="w"> </span><span class="n">notify</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Subscribe CCC write request response callback */</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_gatt_write_func_t</span><span class="w"> </span><span class="n">write</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Subscribe value handle */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">value_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Subscribe CCC handle */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">ccc_handle</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if defined(CONFIG_BT_GATT_AUTO_DISCOVER_CCC)</span>
<span class="w">	</span><span class="cm">/** Subscribe End handle (for automatic discovery) */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">end_handle</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Discover parameters used when ccc_handle = 0 */</span><span class="w"></span>
<span class="w">	</span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_gatt_discover_params</span><span class="w"> </span><span class="o">*</span><span class="n">disc_params</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BT_GATT_AUTO_DISCOVER_CCC */</span><span class="cp"></span>
<span class="w">	</span><span class="cm">/** Subscribe value */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Subscription flags */</span><span class="w"></span>
<span class="w">	</span><span class="n">ATOMIC_DEFINE</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">BT_GATT_SUBSCRIBE_NUM_FLAGS</span><span class="p">);</span><span class="w"></span>

<span class="w">	</span><span class="n">sys_snode_t</span><span class="w"> </span><span class="n">node</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="uuid">
<h2>uuid 面向对象设计分析<a class="headerlink" href="#uuid" title="此标题的永久链接"></a></h2>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>