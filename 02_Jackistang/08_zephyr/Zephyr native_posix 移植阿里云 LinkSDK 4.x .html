<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zephyr native_posix 环境移植阿里云 LinkSDK 4.x &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../index.html">WB55:Jackistang</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Zephyr native_posix 环境移植阿里云 LinkSDK 4.x</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/02_Jackistang/08_zephyr/Zephyr native_posix 移植阿里云 LinkSDK 4.x .md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="zephyr-native-posix-linksdk-4-x">
<h1>Zephyr native_posix 环境移植阿里云 LinkSDK 4.x<a class="headerlink" href="#zephyr-native-posix-linksdk-4-x" title="此标题的永久链接"></a></h1>
<p>本文章主要介绍了如何将 LinkSDK 4.x 移植到 Zephyr 的 native_posix 环境上。</p>
<p>由于 LinkSDK 4.x 可以运行在 POSIX 兼容层，而且云平台也提供了相应的移植代码，还提供了 mbedtls。因此移植的主要工作是配置 Zephyr 的 POSIX 兼容层，关闭自带的 mbedtls，而且需要配置 IPv4 网络，为 LinkSDK 4.x 添加构建代码进行编译链接。</p>
<section id="linksdl-4-x">
<h2>下载 LinkSDL 4.x<a class="headerlink" href="#linksdl-4-x" title="此标题的永久链接"></a></h2>
<p>进入阿里云平台按照要求<a class="reference external" href="https://help.aliyun.com/document_detail/163755.html?spm=a2c4g.11186623.2.5.38527748Tvcdfg">获取 SDK 4.x</a>。</p>
<p>下载 SDK 时需要注意，选择不同的<strong>高级功能</strong>时，需要在后续修改构建文件才能参与构建。这里我只选择了<strong>物模型</strong>。</p>
<p><img alt="../../_images/image-20210129210330079.png" src="../../_images/image-20210129210330079.png" /></p>
</section>
<section id="id1">
<h2>配置工程目录<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p>如何进行应用程序开发，可以参考<a class="reference external" href="https://docs.zephyrproject.org/latest/application/index.html">官方手册</a>，这里我列出自己的移植。</p>
<p>首先进入一个准备开发应用程序的目录，我这里是</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~$ cd zephyrproject/gateway/
jackis@jackis-zephyr:~/zephyrproject/gateway$
</pre></div>
</div>
<p>然后创建文件和目录如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ tree -L 1
.
├── CMakeLists.txt
├── prj.conf
└── src

1 directory, 2 files
</pre></div>
</div>
<p>其中 CMakeLists.txt 是编译文件，prj.conf 是内核配置文件，src 目录是我们存放源代码的位置。</p>
<p>将前面下载的 LinkSDK 解压缩后放置到 src 目录下，并将里面的 demo 文件 <code class="docutils literal notranslate"><span class="pre">mqtt_basic_demo.c</span></code> 也复制一份到 src 目录下，结果如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ tree -L 2
.
├── CMakeLists.txt
├── prj.conf
└── src
    ├── LinkSDK
    └── mqtt_basic_demo.c

2 directories, 3 files
</pre></div>
</div>
</section>
<section id="zephyr">
<h2>配置 Zephyr 内核<a class="headerlink" href="#zephyr" title="此标题的永久链接"></a></h2>
<p>由于我们的运行环境是 native_posix，相应的 POSIX 兼容层环境会自动添加，不需要我们配置。</p>
<p>网络环境的配置参考：[Zephyr - natite_posix 运行 socket 例程](./Zephyr - natite_posix 运行 socket 例程)。</p>
<p>在当前的目录下输入</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ west build -b native_posix -t guiconfig
</pre></div>
</div>
<p>进入内核配置 GUI 界面，在里面找到 <code class="docutils literal notranslate"><span class="pre">mbedTLS</span> <span class="pre">Support</span></code>，取消勾选。</p>
<p><img alt="../../_images/image-20210129203513166.png" src="../../_images/image-20210129203513166.png" /></p>
<p>在 Sub Systems and OS Services - Networking - Network Protocols 里勾选 DNS resolver 开启 DNS 服务。</p>
<p><img alt="../../_images/image-20210129203806555.png" src="../../_images/image-20210129203806555.png" /></p>
<p>然后在 Sub Systems and OS Services - Networking - Network Libraries - Set network settings for applications 里添加 IPv4 地址，网关地址。</p>
<p><img alt=" " src="../../_images/image-20210129204309667.png" /></p>
<p>如果嫌这样配置麻烦，可以在 prj.conf 文件里添加下述内容即可，它会自动地将当前工程所用的内核配置成上述模式。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># General config</span>
<span class="n">CONFIG_NEWLIB_LIBC</span><span class="o">=</span><span class="n">y</span>

<span class="c1"># Networking config</span>
<span class="n">CONFIG_NETWORKING</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_NET_IPV4</span><span class="o">=</span><span class="n">y</span>
<span class="c1"># CONFIG_NET_IPV6=y</span>
<span class="n">CONFIG_NET_TCP</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_NET_SOCKETS</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_NET_SOCKETS_POSIX_NAMES</span><span class="o">=</span><span class="n">y</span>

<span class="n">CONFIG_DNS_RESOLVER</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_DNS_SERVER_IP_ADDRESSES</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_DNS_SERVER1</span><span class="o">=</span><span class="s2">&quot;8.8.8.8&quot;</span>

<span class="c1"># Network driver config</span>
<span class="n">CONFIG_TEST_RANDOM_GENERATOR</span><span class="o">=</span><span class="n">y</span>

<span class="c1"># Network address config</span>
<span class="n">CONFIG_NET_CONFIG_SETTINGS</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_NET_CONFIG_NEED_IPV4</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_NET_CONFIG_MY_IPV4_ADDR</span><span class="o">=</span><span class="s2">&quot;192.0.2.1&quot;</span>
<span class="n">CONFIG_NET_CONFIG_PEER_IPV4_ADDR</span><span class="o">=</span><span class="s2">&quot;192.0.2.2&quot;</span>
<span class="n">CONFIG_NET_CONFIG_MY_IPV4_GW</span><span class="o">=</span><span class="s2">&quot;192.0.2.2&quot;</span>

<span class="c1"># Network debug config</span>
<span class="n">CONFIG_NET_LOG</span><span class="o">=</span><span class="n">y</span>

<span class="c1"># POSIX API</span>
<span class="n">CONFIG_POSIX_API</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_PTHREAD_IPC</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_MAX_PTHREAD_COUNT</span><span class="o">=</span><span class="mi">20</span>
<span class="n">CONFIG_SEM_VALUE_MAX</span><span class="o">=</span><span class="mi">32767</span>
<span class="n">CONFIG_POSIX_CLOCK</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_MAX_TIMER_COUNT</span><span class="o">=</span><span class="mi">10</span>
<span class="n">CONFIG_POSIX_MQUEUE</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_EVENTFD</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_EVENTFD_MAX</span><span class="o">=</span><span class="mi">5</span>

<span class="c1"># Enable Mbed TLS configuration</span>
<span class="n">CONFIG_MBEDTLS</span><span class="o">=</span><span class="n">n</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>编写构建文件<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p>这里我们添加 CMakeLists.txt 里的内容，使用 CMake 构建语法，主要是将 LinkSDK 加入 Zephyr 的构建，参考官方手册以及其他例程的构建文件，我写的如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Find Zephyr. This also loads Zephyr&#39;s build system.
cmake_minimum_required(VERSION 3.13.1)
find_package(Zephyr REQUIRED HINTS $ENV{ZEPHYR_BASE})
project(gateway)

# Add your source file to the &quot;app&quot; target. This must come after
# find_package(Zephyr) which defines the target.

FILE(GLOB app_sources   src/*.c 
                        src/LinkSDK/components/data-model/*.c
                        src/LinkSDK/core/*.c
                        src/LinkSDK/core/sysdep/*.c
                        src/LinkSDK/core/utils/*.c
                        src/LinkSDK/external/*.c
                        src/LinkSDK/external/mbedtls/library/*.c
                        src/LinkSDK/portfiles/aiot_port/*.c)

include_directories(./ 
                    src/LinkSDK/components/data-model 
                    src/LinkSDK/core 
                    src/LinkSDK/core/sysdep
                    src/LinkSDK/external/mbedtls/include
                    src/LinkSDK/core/utils)

target_sources(app PRIVATE ${app_sources})
</pre></div>
</div>
</section>
<section id="id3">
<h2>测试<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<p>打开一个终端，进入 <code class="docutils literal notranslate"><span class="pre">net-tools</span></code> 目录，输入 <code class="docutils literal notranslate"><span class="pre">./net-setup.sh</span></code> 创建一个以太网接口，这个在 [Zephyr - natite_posix 运行 socket 例程](./Zephyr - natite_posix 运行 socket 例程) 里有介绍。</p>
<p>然后再打开一个终端，进入应用工程目录，输入下述命令构建工程，</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ west build -b native_posix
</pre></div>
</div>
<p>构建完成后再输入命令运行程序</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ west build -t run
</pre></div>
</div>
<p>可以看到下述现象</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jackis@jackis-zephyr:~/zephyrproject/gateway$ west build -t run
-- west build: running target run
[0/1] cd /home/jackis/zephyrproject/gateway/build &amp;&amp; /home/jackis/zephyrproject/gateway/build/zephyr/zephyr.exe
WARNING: Using a test - not safe - entropy source
*** Booting Zephyr OS build zephyr-v2.4.0-8-g9c30e7946974  ***
[00:00:00.000,000] &lt;inf&gt; net_config: Initializing network
[00:00:00.000,000] &lt;inf&gt; net_config: IPv4 address: 192.0.2.1
[1611925016.544][LK-0313] MQTT user calls aiot_mqtt_connect api, connect
[1611925016.544][LK-0317] mqtt_basic_demo&amp;a13FN5TplKq
[1611925016.544][LK-0318] 4780A5F17990D8DC4CCAD392683ED80160C4C2A1FFA649425CD0E2666A8593EB
establish mbedtls connection with server(host=&#39;a13FN5TplKq.iot-as-mqtt.cn-shanghai.aliyuncs.com&#39;, port=[443])
success to establish tcp, fd=4
success to establish mbedtls connection, fd = 4(cost 43270 bytes in total, max used 45882 bytes)
[1611925016.888][LK-0313] MQTT connect success in 332 ms
AIOT_MQTTEVT_CONNECT
heartbeat response
</pre></div>
</div>
<p>成功连接阿里云的 MQTT Broker 。</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>