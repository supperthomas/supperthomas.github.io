<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>16. Zephyr - BLE 广播 &mdash; bluetoothlover_wiki 0.0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="17. Zephyr - BLE 扫描" href="Zephyr%20-%20BLE%20%E6%89%AB%E6%8F%8F.html" />
    <link rel="prev" title="15. BLE 协议栈初始化" href="Zephyr%20-%20BLE%20%E5%88%9D%E5%A7%8B%E5%8C%96.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> bluetoothlover_wiki
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">BLE knowledge:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../ble/index.html">BLE STACK篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ble_profile/index.html">BLE PROFILE篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nordic/index.html">Nordic 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WB55/index.html">STM32WB55 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../WIKI_FAQ/index.html">WIKI FAQ 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../RTTHREAD/index.html">RTTHRED: RT-Thread</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../12_ESP32/index.html">ESP32</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../DEBUG/index.html">EMBEDDED DEBUG 篇</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../00_supperthomas/index.html">MASTER:supperthomas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../01_helloworldzlg/index.html">WB55:helloworldzlg</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">WB55:Jackistang</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../01_introduce/01_intruduce.html">1. 简单自我介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02_introduce/01_intruduce.html">2. CubeMX生成BLE应用(二)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03_heart_rate_att_gatt/01_intruduce.html">3. GATT Service 定义总结</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04_mbedos_advertising/readme.html">4. BLE_Advertising</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05_mbedos_example_ble_led/readme.html">5. mbed-os LEDDemo 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07_mbedos_gatt_client/GattClient.html">6. mbed os GattClient 介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/DigitalOut.html">7. DigitalOut</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/InterruptIn.html">8. InterruptIn</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06_mbedos/Callback.html">9. Callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="Virtualbox%20%E5%AE%89%E8%A3%85%20Ubuntu%2020.04.html">10. VirtualBox 安装 Ubuntu 20.04</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html">11. Zephyr 环境搭建</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%20-%20ESP32%20%E7%AF%87.html">12. Zephyr 环境搭建 - ESP32 篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20-%20Bluetooth%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%20-%20QEMU%20%E7%AF%87.html">13. Zephyr - Bluetooth 环境搭建 - QEMU 篇</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20-%20Shell.html">14. Zephyr - Shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20-%20BLE%20%E5%88%9D%E5%A7%8B%E5%8C%96.html">15. BLE 协议栈初始化</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">16. Zephyr - BLE 广播</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">16.1. 广播数据</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">概念介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-data">bt_data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">16.2. 广播参数</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">概念介绍</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-le-adv-param">bt_le_adv_param</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id7">16.3. 广播控制</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bt-le-adv-start">bt_le_adv_start</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-le-adv-update-data">bt_le_adv_update_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bt-le-adv-stop">bt_le_adv_stop</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Zephyr%20-%20BLE%20%E6%89%AB%E6%8F%8F.html">17. Zephyr - BLE 扫描</a></li>
<li class="toctree-l2"><a class="reference internal" href="../09_esp32/problem.html">18. 掉坑汇总</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_rtthread/workqueue.html">19. RT-Thread workqueue 详解</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_rtthread/jerryscript.html">20. Jerryscript 简介</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../03_xupenghu/index.html">WB55:xupenghu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04_dozingfiretruck/index.html">WB55:dozingfiretruck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../05_luhuadong/index.html">WB55:luhuadong</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../09_answerinthewind/index.html">WB55:answerinthewind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../06_chenyingchun0312/index.html">NORDIC:chenyingchun0312</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../07_ylz0923/index.html">NORDIC:ylz0923</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../08_guohp1128/index.html">NORDIC:guohp1128</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10_jiy/index.html">NORDIC:jiy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../11_ForestRain/index.html">NORDIC:ForestRain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../13_xiangxistu/index.html">NORDIC:xiangxistu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../14_bobwenstudy/index.html">NORDIC:bobwenstudy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../16_ColeStudy/index.html">NORDIC:ColeStudy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">bluetoothlover_wiki</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">WB55:Jackistang</a></li>
      <li class="breadcrumb-item active"><span class="section-number">16. </span>Zephyr - BLE 广播</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/02_Jackistang/08_zephyr/Zephyr - BLE 广播.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="zephyr-ble">
<h1><span class="section-number">16. </span>Zephyr - BLE 广播<a class="headerlink" href="#zephyr-ble" title="此标题的永久链接"></a></h1>
<p>此处介绍的广播是传统广播，不涉及扩展广播。</p>
<section id="id1">
<h2><span class="section-number">16.1. </span>广播数据<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<section id="id2">
<h3>概念介绍<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h3>
<p>在传统广播里，广播包里携带的数据只有 31 个字节，一个经典的图示如下：</p>
<p><img alt="../../_images/2191371-fc29b5124fa07b82.png" src="../../_images/2191371-fc29b5124fa07b82.png" /></p>
<p>这 31 个字节又分为<strong>有效部分</strong>和<strong>无效部分</strong>。</p>
<p>有效部分也就是我们想要发送的数据，里面每一个数据单元都由一个 AD Structure 组成，N 个 AD Structure 共同填充了有效部分。</p>
<p>每个 AD Structure 又是由 Length + AD Type + AD Data（LTD）组成，图示如下：</p>
<p><img alt="../../_images/6974508-63821d97bf504563" src="../../_images/6974508-63821d97bf504563" /></p>
<ul class="simple">
<li><p>Length： 这个数据单元的长度。</p></li>
<li><p>AD Type：广播数据单元的类型，蓝牙 SIG 联盟定义了一些<a class="reference external" href="https://www.bluetooth.com/specifications/assigned-numbers/generic-access-profile/">标准类型</a>。</p></li>
<li><p>AD Data：数据内容，需要根据 AD Type 来解析。</p></li>
</ul>
<p>这样 BLE 传统广播的数据包内容基本介绍完了，接下来看看 Zephyr 里如何定义 AD Structure 的。</p>
</section>
<section id="bt-data">
<h3>bt_data<a class="headerlink" href="#bt-data" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data_len</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">bt_data</span></code> 就是 Zephyr 蓝牙协议栈定义的 AD Structure，其中 <code class="docutils literal notranslate"><span class="pre">type</span></code> 是该数据单元的类型（AD Type），<code class="docutils literal notranslate"><span class="pre">data</span></code> 指向数据内容（AD Data）缓冲区的首地址，而 <code class="docutils literal notranslate"><span class="pre">data_len</span></code> 是数据内容（AD Data）缓冲区的首地址，不是前面介绍的数据单元的长度（Length），数据单元的长度（Length）协议栈会自动设置。</p>
<p>协议栈还提供了一系列的宏来帮助我们快速构造 <code class="docutils literal notranslate"><span class="pre">bt_data</span></code>。</p>
<section id="id3">
<h4>BT_DATA<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BT_DATA(_type, _data, _data_len) \</span>
<span class="cp">	{ \</span>
<span class="cp">		.type = (_type), \</span>
<span class="cp">		.data_len = (_data_len), \</span>
<span class="cp">		.data = (const uint8_t *)(_data), \</span>
<span class="cp">	}</span>
</pre></div>
</div>
<p>这个参数宏的参数和 bt_data 里的成员变量是一一对应的。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">BT_DATA(0x09,</span> <span class="pre">&quot;name&quot;,</span> <span class="pre">sizeof(&quot;name&quot;)-1)</span></code> 即可快速构造一个 <code class="docutils literal notranslate"><span class="pre">bt_data</span></code>，而且它的宏名称是相应的大写版本，方便记忆。</p>
</section>
<section id="bt-data-bytes">
<h4>BT_DATA_BYTES<a class="headerlink" href="#bt-data-bytes" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BT_DATA_BYTES(_type, _bytes...) \</span>
<span class="cp">	BT_DATA(_type, ((uint8_t []) { _bytes }), \</span>
<span class="cp">		sizeof((uint8_t []) { _bytes }))</span>
</pre></div>
</div>
<p>有时候我们想要在定义 <code class="docutils literal notranslate"><span class="pre">bt_data</span></code> 时直接手动输入数据部分，让程序自己判断数据的长度，这个时候就可以用宏 BT_DATA_BYTES 了。这个参数宏将第 2 个参数及之后的参数全部放置到了 <code class="docutils literal notranslate"><span class="pre">_bytes</span></code> 里，然后用它构建了一个数组，并自动获取该数组的长度，从而达到了上述的目的。</p>
<p>例如：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="n">ad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA_BYTES</span><span class="p">(</span><span class="n">BT_DATA_FLAGS</span><span class="p">,</span><span class="w"> </span><span class="n">BT_LE_AD_NO_BREDR</span><span class="p">),</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA_BYTES</span><span class="p">(</span><span class="n">BT_DATA_UUID16_ALL</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">),</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA_BYTES</span><span class="p">(</span><span class="n">BT_DATA_SVC_DATA16</span><span class="p">,</span><span class="w"></span>
<span class="w">		      </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Eddystone UUID */</span><span class="w"></span>
<span class="w">		      </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Eddystone-URL frame type */</span><span class="w"></span>
<span class="w">		      </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Calibrated Tx power at 0m */</span><span class="w"></span>
<span class="w">		      </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="cm">/* URL Scheme Prefix http://www. */</span><span class="w"></span>
<span class="w">		      </span><span class="sc">&#39;z&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;h&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;y&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">		      </span><span class="sc">&#39;p&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;r&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;o&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;j&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;c&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;t&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">		      </span><span class="mh">0x08</span><span class="p">)</span><span class="w"> </span><span class="cm">/* .org */</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id4">
<h2><span class="section-number">16.2. </span>广播参数<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h2>
<section id="id5">
<h3>概念介绍<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>BLE 设备是以一定间隔（Interval）来广播的，每一次广播就叫做广播事件（Advertising Event），如下图：</p>
<p><img alt="../../_images/20190715175243651.PNG" src="../../_images/20190715175243651.PNG" /></p>
<p>这里 advInterval 就是广播间隔，但实际上的 T_advEvent（广播事件）还加了一个 10ms 的伪随机数（advDelay）。</p>
<p>如果在这一次广播事件内，对端扫描到了这个广播，那么就可以进行一系列的交互了，否则只能等待下一次的广播事件。</p>
</section>
<section id="bt-le-adv-param">
<h3>bt_le_adv_param<a class="headerlink" href="#bt-le-adv-param" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_le_adv_param</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">id</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">sid</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint8_t</span><span class="w">  </span><span class="n">secondary_max_skip</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Bit-field of advertising options */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">options</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Minimum Advertising Interval (N * 0.625) */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interval_min</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/** Maximum Advertising Interval (N * 0.625) */</span><span class="w"></span>
<span class="w">	</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">interval_max</span><span class="p">;</span><span class="w"></span>
<span class="w">	</span><span class="cm">/**</span>
<span class="cm">	 * @brief Directed advertising to peer</span>
<span class="cm">	 *</span>
<span class="cm">	 * When this parameter is set the advertiser will send directed</span>
<span class="cm">	 * advertising to the remote device.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The advertising type will either be high duty cycle, or low duty</span>
<span class="cm">	 * cycle if the BT_LE_ADV_OPT_DIR_MODE_LOW_DUTY option is enabled.</span>
<span class="cm">	 * When using @ref BT_LE_ADV_OPT_EXT_ADV then only low duty cycle is</span>
<span class="cm">	 * allowed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In case of connectable high duty cycle if the connection could not</span>
<span class="cm">	 * be established within the timeout the connected() callback will be</span>
<span class="cm">	 * called with the status set to @ref BT_HCI_ERR_ADV_TIMEOUT.</span>
<span class="cm">	 */</span><span class="w"></span>
<span class="w">	</span><span class="k">const</span><span class="w"> </span><span class="n">bt_addr_le_t</span><span class="w"> </span><span class="o">*</span><span class="n">peer</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>这里传统广播只需要关注 <code class="docutils literal notranslate"><span class="pre">options</span></code>，<code class="docutils literal notranslate"><span class="pre">interval_min</span></code>，<code class="docutils literal notranslate"><span class="pre">interval_max</span></code> 和 <code class="docutils literal notranslate"><span class="pre">peer</span></code> 即可。</p>
<ul class="simple">
<li><p><strong>options</strong>: 广播包的类型。</p></li>
</ul>
<p>这里的类型定义了很多，我这里列几个常用的，更全面地需要参考代码。</p>
<p><code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_OPT_CONNECTABLE</span></code>：可连接的广播包。</p>
<p><code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_OPT_USE_NAME</span></code>：广播使用 GAP 设备名称。</p>
<p><code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_OPT_SCANNABLE</span></code>：可扫描的广播包。</p>
<p><code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_OPT_DISABLE_CHAN_37</span></code>：不允许在通道 37 打广播。</p>
<ul class="simple">
<li><p><strong>interval_min</strong>: 最小的广播间隔。</p></li>
<li><p><strong>interval_max</strong>: 最大的广播间隔。</p></li>
<li><p><strong>peer</strong>: 定向广播的地址。若该地址被设置，则广播包自动变为定向的，否则为不定向的。</p></li>
</ul>
<p>协议栈也提供了辅助宏来帮助我们初始化广播参数。</p>
<section id="bt-le-adv-param-init">
<h4>BT_LE_ADV_PARAM_INIT<a class="headerlink" href="#bt-le-adv-param-init" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BT_LE_ADV_PARAM_INIT(_options, _int_min, _int_max, _peer) \</span>
<span class="cp">{ \</span>
<span class="cp">	.id = BT_ID_DEFAULT, \</span>
<span class="cp">	.sid = 0, \</span>
<span class="cp">	.secondary_max_skip = 0, \</span>
<span class="cp">	.options = (_options), \</span>
<span class="cp">	.interval_min = (_int_min), \</span>
<span class="cp">	.interval_max = (_int_max), \</span>
<span class="cp">	.peer = (_peer), \</span>
<span class="cp">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_PARAM_INIT</span></code> 宏传入选项，广播间隔以及对端地址来初始化一个传统广播的参数。</p>
<p>当前，我们一般不直接使用这个来初始化广播参数，协议栈提供了一种更便利的方式。</p>
</section>
<section id="id6">
<h4>BT_LE_ADV_PARAM<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h4>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define BT_LE_ADV_PARAM(_options, _int_min, _int_max, _peer) \</span>
<span class="cp">	((struct bt_le_adv_param[]) { \</span>
<span class="cp">		BT_LE_ADV_PARAM_INIT(_options, _int_min, _int_max, _peer) \</span>
<span class="cp">	 })</span>
</pre></div>
</div>
<p>协议栈利用 <code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_PARAM</span></code> 来构造了一个 struct bt_le_adv_param 类型的数组，里面只有一个元素，并且该参数宏展开后的含义是该数组的数组名，也就是广播参数的首地址。</p>
<p>借助该参数宏，协议栈定义了一系列更便捷的宏供我们使用。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* 可连接的，定向的广播包 */</span><span class="w"></span>
<span class="cp">#define BT_LE_ADV_CONN_DIR(_peer) BT_LE_ADV_PARAM(BT_LE_ADV_OPT_CONNECTABLE |  \</span>
<span class="cp">						  BT_LE_ADV_OPT_ONE_TIME, 0, 0,\</span>
<span class="cp">						  _peer)</span>

<span class="cm">/* 可连接的，不定向的广播包 */</span><span class="w"></span>
<span class="cp">#define BT_LE_ADV_CONN BT_LE_ADV_PARAM(BT_LE_ADV_OPT_CONNECTABLE, \</span>
<span class="cp">				       BT_GAP_ADV_FAST_INT_MIN_2, \</span>
<span class="cp">				       BT_GAP_ADV_FAST_INT_MAX_2, NULL)</span>
<span class="cm">/* 可连接的，不定向的广播包，并且带有 GAP 设备名 */</span><span class="w"></span>
<span class="cp">#define BT_LE_ADV_CONN_NAME BT_LE_ADV_PARAM(BT_LE_ADV_OPT_CONNECTABLE | \</span>
<span class="cp">					    BT_LE_ADV_OPT_USE_NAME, \</span>
<span class="cp">					    BT_GAP_ADV_FAST_INT_MIN_2, \</span>
<span class="cp">					    BT_GAP_ADV_FAST_INT_MAX_2, NULL)</span>
</pre></div>
</div>
<p>这里只列举出了这三个宏，全部的辅助宏感兴趣的可以去参考代码。如果没有我们需要的，我们自己也可以按照这个格式实现。</p>
<p>可以看出本质上就是借用 <code class="docutils literal notranslate"><span class="pre">BT_LE_ADV_PARAM</span></code> 来构建了一个 <code class="docutils literal notranslate"><span class="pre">bt_le_adv_param</span></code> 参数，并获取了其地址，只不过中间利用了一些宏的技巧而已。</p>
</section>
</section>
</section>
<section id="id7">
<h2><span class="section-number">16.3. </span>广播控制<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
<p>协议栈提供了接口 <code class="docutils literal notranslate"><span class="pre">bt_le_adv_start</span></code> 来启动广播，<code class="docutils literal notranslate"><span class="pre">bt_le_adv_update_data</span></code> 来更新数据，<code class="docutils literal notranslate"><span class="pre">bt_le_adv_stop</span></code> 来停止广播。</p>
<section id="bt-le-adv-start">
<h3>bt_le_adv_start<a class="headerlink" href="#bt-le-adv-start" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">bt_le_adv_start</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_le_adv_param</span><span class="w"> </span><span class="o">*</span><span class="n">param</span><span class="p">,</span><span class="w"></span>
<span class="w">		    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="o">*</span><span class="n">ad</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">ad_len</span><span class="p">,</span><span class="w"></span>
<span class="w">		    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sd_len</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>启动广播，并同时设置广播数据和扫描回复数据。</p>
<ul class="simple">
<li><p><strong>返回值</strong>：</p>
<ul>
<li><p>0 表示成功，其他值表示失败。</p></li>
</ul>
</li>
<li><p><strong>参数</strong>：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">param</span></code>：广播参数，bt_le_adv_param 结构体类型的指针，可有上述辅助宏创建。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ad</span></code>, <code class="docutils literal notranslate"><span class="pre">ad_len</span></code>：广播数据数组的首地址，以及数组的长度。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sd</span></code>, <code class="docutils literal notranslate"><span class="pre">sd_len</span></code> : 扫描回复数据数组的首地址，以及数组的长度。扫描回复数据与广播数据一模一样。</p></li>
</ul>
</li>
</ul>
<p>例如：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="n">ad</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA_BYTES</span><span class="p">(</span><span class="n">BT_DATA_FLAGS</span><span class="p">,</span><span class="w"> </span><span class="n">BT_LE_AD_NO_BREDR</span><span class="p">),</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA_BYTES</span><span class="p">(</span><span class="n">BT_DATA_UUID16_ALL</span><span class="p">,</span><span class="w"> </span><span class="mh">0xaa</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfe</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="cm">/* Set Scan Response data */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="n">sd</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">	</span><span class="n">BT_DATA</span><span class="p">(</span><span class="n">BT_DATA_NAME_COMPLETE</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">DEVICE_NAME_LEN</span><span class="p">),</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="w">	</span><span class="n">bt_le_adv_start</span><span class="p">(</span><span class="n">BT_LE_ADV_CONN</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">,</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span><span class="w"></span>
<span class="w">			      </span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sd</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="bt-le-adv-update-data">
<h3>bt_le_adv_update_data<a class="headerlink" href="#bt-le-adv-update-data" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_le_adv_update_data</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="o">*</span><span class="n">ad</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">ad_len</span><span class="p">,</span><span class="w"></span>
<span class="w">			  </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">bt_data</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sd_len</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>更新广播数据。</p>
<ul class="simple">
<li><p><strong>返回值</strong>：</p>
<ul>
<li><p>0 表示成功，其他值表示失败。</p></li>
</ul>
</li>
<li><p><strong>参数</strong>：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ad</span></code>, <code class="docutils literal notranslate"><span class="pre">ad_len</span></code>：广播数据数组的首地址，以及数组的长度。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sd</span></code>, <code class="docutils literal notranslate"><span class="pre">sd_len</span></code> : 扫描回复数据数组的首地址，以及数组的长度。扫描回复数据与广播数据一模一样。</p></li>
</ul>
</li>
</ul>
</section>
<section id="bt-le-adv-stop">
<h3>bt_le_adv_stop<a class="headerlink" href="#bt-le-adv-stop" title="此标题的永久链接"></a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">bt_le_adv_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>停止广播。</p>
<ul class="simple">
<li><p><strong>返回值</strong>：</p>
<ul>
<li><p>0 表示成功，其他值表示失败。</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="Zephyr%20-%20BLE%20%E5%88%9D%E5%A7%8B%E5%8C%96.html" class="btn btn-neutral float-left" title="15. BLE 协议栈初始化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="Zephyr%20-%20BLE%20%E6%89%AB%E6%8F%8F.html" class="btn btn-neutral float-right" title="17. Zephyr - BLE 扫描" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2020, apache.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>